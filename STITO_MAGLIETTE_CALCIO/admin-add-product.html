<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Prodotti</title>
       <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            box-sizing: border-box;
        }
        body.modal-open {
            overflow: hidden;
        }

        .admin-container {
            background-color: #fff;
            padding: 30px; /* Manteniamo il padding per il contenuto interno */
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 900px;
            margin: 20px auto;
            position: relative; /* Necessario per posizionare il pulsante logout assolutamente al suo interno */
        }

        /* Stile per il pulsante Logout Admin posizionato in alto a destra del .admin-container */
        #admin-logout-button-container {
            position: absolute;
            top: 20px; /* Distanza dal bordo superiore del .admin-container */
            right: 20px; /* Distanza dal bordo destro del .admin-container */
            z-index: 10; /* Per essere sopra altri elementi se necessario */
        }
        #admin-logout-button-container button {
            padding: 8px 15px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }
        #admin-logout-button-container button:hover {
            background-color: #c0392b;
        }
        #admin-logout-button-container button i {
            margin-right: 6px;
        }


        #open-product-list-fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background-color: #2c3e50;
            color: white;
            border: none;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease-out;
            z-index: 999;
        }
        #open-product-list-fab:hover {
            background-color: #1abc9c;
            transform: scale(1.1);
        }
        #open-product-list-fab .product-count-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #e74c3c;
            color: white;
            border-radius: 50%;
            padding: 3px 7px;
            font-size: 12px;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
            box-sizing: border-box;
        }


        h1, h2 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
        }
        h1 { font-size: 2.2rem; }
        h2 { font-size: 1.6rem; border-bottom: 2px solid #1abc9c; padding-bottom: 10px; }

        .form-section {
            margin-bottom: 40px;
        }

        .product-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .product-form input[type="text"],
        .product-form input[type="number"],
        .product-form textarea,
        .product-form select {
            width: 100%;
            padding: 10px 12px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.2s ease;
        }
        .product-form input:focus,
        .product-form textarea:focus,
        .product-form select:focus {
            border-color: #1abc9c;
            outline: none;
            box-shadow: 0 0 0 2px rgba(26, 188, 156, 0.2);
        }
        .product-form textarea {
            min-height: 80px;
            resize: vertical;
        }
        .product-form select[multiple] {
            min-height: 100px;
        }

        .product-form .form-group { margin-bottom: 15px; }
        .product-form .form-row { display: flex; gap: 20px; margin-bottom: 15px; }
        .product-form .form-row > div { flex: 1; }

        .product-form .tags-input-container { border: 1px solid #ccc; border-radius: 5px; padding: 8px; display: flex; flex-wrap: wrap; gap: 6px; align-items: center; margin-bottom: 15px; }
        .product-form .tag-item { background-color: #1abc9c; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; }
        .product-form .tag-remove-btn { background: none; border: none; color: white; cursor: pointer; font-size: 1rem; line-height: 1; }
        .product-form input[type="text"].tag-input { border: none; outline: none; flex-grow: 1; padding: 5px; margin-bottom: 0; }

        .product-form button { background-color: #1abc9c; color: white; padding: 12px 25px; border: none; border-radius: 5px; cursor: pointer; font-size: 1.1rem;  font-weight: 600; transition: background-color 0.3s ease; margin-right: 10px; }
        .product-form button:hover { background-color: #16a085; }
        .product-form button.clear-btn { background-color: #e74c3c; }
        .product-form button.clear-btn:hover { background-color: #c0392b; }
        .product-form button.cancel-edit-btn { background-color: #7f8c8d; display: none; }
        .product-form button.cancel-edit-btn:hover { background-color: #525e64; }

        /* Styling for MODAL product list collapsible headers */
        #product-list-modal-content .collapsible-header {
            cursor: pointer;
            padding: 8px 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid #eee;
        }
        #product-list-modal-content .collapsible-header:hover { background-color: #f0f0f0; }
        #product-list-modal-content .collapsible-header .indicator {
            transition: transform 0.35s ease-in-out;
            margin-left: 10px; font-size: 0.8em; display: inline-block;
        }
        #product-list-modal-content .collapsible-header.header-expanded .indicator { transform: rotate(180deg); }

        #product-list-modal-content h3.collapsible-header {
            margin-top: 15px; margin-bottom: 0; font-size: 1.3rem; color: #2c3e50;
            background-color: #e9ecef; padding-left: 10px;
        }
        #product-list-modal-content h4.collapsible-header {
            margin-top: 5px; margin-bottom: 0; font-size: 1.05rem; color: #34495e;
            padding-left: 10px;
        }
        #product-list-modal-content h4.collapsible-header.optgrouped-category {
            margin-left: 0; padding-left: 20px; background-color: #f8f9fa;
        }

        .product-list { list-style: none; padding: 0; }
        ul.collapsible-content {
            list-style-type: none; padding: 0; margin: 0;
            max-height: 0; overflow: hidden;
            transition: max-height 0.35s ease-in-out;
        }
        ul.collapsible-content.expanded {
            /* max-height is set by JS to scrollHeight */
        }
        ul.collapsible-content > li.product-list-item,
        ul.collapsible-content > h4.collapsible-header + ul.collapsible-content > li.product-list-item {
             margin-left: 10px;
             margin-right: 5px;
        }
        ul.collapsible-content > h4.collapsible-header + ul.collapsible-content.expanded > li.product-list-item {
            margin-left: 25px;
        }


        .product-list-item {
            background-color: #fdfdfd; border: 1px solid #e9e9e9; border-radius: 6px;
            padding: 10px 15px; margin-bottom: 10px; display: flex; align-items: center;
            gap: 15px; transition: box-shadow 0.2s ease;
        }
        .product-list-item:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
        .product-list-item-img { width: 50px; height: 50px; object-fit: contain; border-radius: 4px; border: 1px solid #eee; background-color: #fff; flex-shrink: 0; }
        .product-list-item .info { flex-grow: 1; }
        .product-list-item .info strong { font-size: 1.0rem; color: #2c3e50; display: block; margin-bottom: 2px; }
        .product-list-item .info span { font-size: 0.85rem; color: #555; display: block; }
        .product-list-item .actions { margin-left: auto; flex-shrink: 0; }
        .product-list-item .actions button { background: none; border: 1px solid; padding: 5px 8px; border-radius: 3px; cursor: pointer; font-size: 0.8rem; transition: background-color 0.2s, color 0.2s; margin-left: 6px; }
        .product-list-item .actions .edit-btn { border-color: #3498db; color: #3498db; }
        .product-list-item .actions .edit-btn:hover { background-color: #3498db; color: white; }
        .product-list-item .actions .delete-btn { border-color: #e74c3c; color: #e74c3c; }
        .product-list-item .actions .delete-btn:hover { background-color: #e74c3c; color: white; }

        .no-products-message { text-align: center; color: #7f8c8d; padding: 20px; font-style: italic; border: 1px dashed #ccc; border-radius: 5px; }
        #admin-feedback { text-align: center; padding: 10px; margin: 15px 0; border-radius: 5px; display: none; }
        #admin-feedback.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        #admin-feedback.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s linear 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; transition: opacity 0.3s ease; }
        #confirm-delete-modal { z-index: 1010; }
        .confirm-modal-content { background-color: #fff; padding: 25px 30px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center; width: 90%; max-width: 400px; transform: scale(0.7); transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        #confirm-delete-modal.visible .confirm-modal-content { transform: scale(1); }
        .confirm-modal-content h3 { margin-top: 0; margin-bottom: 15px; color: #2c3e50; font-size: 1.4rem; }
       
        .confirm-modal-content #modal-delete-product-image {
            display: block;
            max-width: 100px;
            max-height: 100px;
            margin: 0 auto 15px auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            object-fit: contain;
            background-color: #fff;
        }
        .confirm-modal-content #modal-delete-product-name {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            text-align: center;
        }
       
        .confirm-modal-content p { margin-bottom: 25px; color: #555; font-size: 1rem; line-height: 1.5; }
        .modal-actions { display: flex; justify-content: center; gap: 15px; }
        .modal-btn { padding: 10px 20px; border: none; border-radius: 5px; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s ease, transform 0.1s ease; }
        .modal-btn:active { transform: translateY(1px); }
        .modal-btn-confirm { background-color: #e74c3c; color: white; }
        .modal-btn-confirm:hover { background-color: #c0392b; }
        .modal-btn-cancel { background-color: #bdc3c7; color: #333; }
        .modal-btn-cancel:hover { background-color: #95a5a6; }
       
        #product-list-overlay { z-index: 1000; }
        #product-list-modal-content { background-color: #fff; box-shadow: 0 10px 40px rgba(0,0,0,0.2); width: 100vw; height: 100vh; display: flex; flex-direction: column; padding: 20px; padding-top: 10px; box-sizing: border-box; position: relative; transform: scale(0.95); opacity: 0; transition: transform 0.2s ease-out, opacity 0.2s ease-out; }
        #product-list-overlay.visible #product-list-modal-content { transform: scale(1); opacity: 1; }
       
        #product-list-modal-content .modal-list-header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #1abc9c;
            margin-bottom: 10px;
            padding-bottom: 8px;
            padding-right: 50px; 
        }
        #product-list-modal-content .modal-list-header-controls > h2 {
            margin: 0;
            font-size: 1.6rem;
            color: #2c3e50;
            border-bottom: none;
            padding-bottom: 0;
            text-align: left;
        }
        .toggle-all-btn {
            background: none;
            border: 1px solid #ccc;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            padding: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, border-color 0.2s;
            margin-left: 10px;
            flex-shrink: 0;
        }
        .toggle-all-btn:hover {
            background-color: #f0f0f0;
            border-color: #999;
        }
        .toggle-all-btn svg { }

        #product-list-modal-content .modal-list-container { flex-grow: 1; overflow-y: auto; }
        .modal-close-btn { position: absolute; top: 15px; right: 15px; background: #e0e0e0; color: #333; border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 1.6rem; line-height: 30px; text-align: center; cursor: pointer; transition: background-color 0.2s, transform 0.2s; z-index: 1001; }
        .modal-close-btn:hover { background: #ccc; transform: rotate(90deg); }

        @media (max-width: 600px) {
            .admin-container { padding: 20px; }
            #admin-logout-button-container { top: 15px; right: 15px; }
            #admin-logout-button-container button { padding: 6px 10px; font-size: 0.8rem;}

            .product-form .form-row { flex-direction: column; gap: 0; }
            .product-list-item { align-items: flex-start; }
            .product-list-item-img { width: 45px; height: 45px; }
            .product-list-item .actions { margin-top: 8px; margin-left: 0; width: 100%; display: flex; justify-content: flex-end; }
            .product-list-item .actions button { margin-left: 0; margin-right: 5px;}
            #open-product-list-fab { bottom: 20px; right: 20px; width: 50px; height: 50px; font-size: 20px; }
            #open-product-list-fab .product-count-badge { padding: 2px 5px; font-size: 10px; min-width: 16px; }
            #product-list-modal-content { padding: 10px; }
           
            #product-list-modal-content .modal-list-header-controls > h2 { font-size: 1.4rem; }
            #product-list-modal-content .modal-list-header-controls {
                 padding-right: 45px; 
            }

            .modal-close-btn { top: 8px; right: 8px; width: 28px; height: 28px; font-size: 1.4rem; line-height: 28px; }
            #product-list-modal-content h3.collapsible-header { font-size: 1.15rem; }
            #product-list-modal-content h4.collapsible-header { font-size: 1.0rem; }
            .product-list-item { padding: 8px 10px; gap: 10px; }
            .product-list-item .info strong { font-size: 0.9rem; }
            .product-list-item .info span { font-size: 0.75rem; }
            .confirm-modal-content #modal-delete-product-image { max-width: 80px; max-height: 80px; margin-bottom: 10px;}
            .confirm-modal-content #modal-delete-product-name { font-size: 1.1rem; }

            .toggle-all-btn { width: 28px; height: 28px; }
            .toggle-all-btn svg { width: 18px; height: 18px; }
        }
    </style>
    <!-- Icone Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <button id="open-product-list-fab" title="Visualizza Lista Prodotti">
        ☰ <span class="product-count-badge" style="display: none;">0</span>
    </button>

    <div class="admin-container">
        <!-- PULSANTE LOGOUT ADMIN INSERITO QUI -->
        <div id="admin-logout-button-container">
            <button id="admin-logout-button">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>

        <h1>Gestione Prodotti</h1>
        <div id="admin-feedback"></div>
        <section class="form-section">
            <h2 id="form-title">Aggiungi Nuovo Prodotto</h2>
            <form id="product-form" class="product-form">
                <input type="hidden" id="editing-product-id-field">
                <div class="form-group"> <label for="product-name">Nome Prodotto:</label> <input type="text" id="product-name" name="name" required> </div>
                <div class="form-group"> <label for="product-description">Descrizione:</label> <textarea id="product-description" name="description" required></textarea> </div>
                <div class="form-row">
                    <div> <label for="product-price">Prezzo (€):</label> <input type="number" id="product-price" name="price" step="0.01" min="0" required> </div>
                    <div> <label for="product-category">Categoria:</label> <select id="product-category" name="category" required> <option value="">-- Seleziona una categoria --</option> <optgroup label="Maglie Club"> <option value="serie-a">Serie A</option> <option value="la-liga">La Liga</option> <option value="premier-league">Premier League</option> <option value="bundesliga">Bundesliga</option> <option value="ligue-1">Ligue 1</option> </optgroup> <optgroup label="Maglie Nazionali"> <option value="albania">Albania</option> <option value="arabia-saudita">Arabia Saudita</option> <option value="argentina">Argentina</option> <option value="australia">Australia</option> <option value="austria">Austria</option> <option value="belgio">Belgio</option> <option value="brasile">Brasile</option> <option value="camerun">Camerun</option> <option value="canada">Canada</option> <option value="cechia">Cechia (Rep. Ceca)</option> <option value="cile">Cile</option> <option value="colombia">Colombia</option> <option value="corea-del-sud">Corea del Sud</option> <option value="costa-avorio">Costa d'Avorio</option> <option value="costa-rica">Costa Rica</option> <option value="croazia">Croazia</option> <option value="danimarca">Danimarca</option> <option value="ecuador">Ecuador</option> <option value="egitto">Egitto</option> <option value="finlandia">Finlandia</option> <option value="francia">Francia</option> <option value="gabon">Gabon</option> <option value="galles">Galles</option> <option value="georgia">Georgia</option> <option value="germania">Germania</option> <option value="ghana">Ghana</option> <option value="giamaica">Giamaica</option> <option value="giappone">Giappone</option> <option value="guinea">Guinea</option> <option value="honduras">Honduras</option> <option value="inghilterra">Inghilterra</option> <option value="irlanda">Irlanda</option> <option value="irlanda-del-nord">Irlanda del Nord</option> <option value="islanda">Islanda</option> <option value="israele">Israele</option> <option value="italia">Italia</option> <option value="mali">Mali</option> <option value="marocco">Marocco</option> <option value="messico">Messico</option> <option value="monaco">Monaco</option> <option value="nigeria">Nigeria</option> <option value="norvegia">Norvegia</option> <option value="paesi-bassi">Paesi Bassi</option> <option value="panama">Panama</option> <option value="paraguay">Paraguay</option> <option value="peru">Perù</option> <option value="polonia">Polonia</option> <option value="portogallo">Portogallo</option> <option value="qatar">Qatar</option> <option value="romania">Romania</option> <option value="russia">Russia</option> <option value="scozia">Scozia</option> <option value="senegal">Senegal</option> <option value="serbia">Serbia</option> <option value="slovacchia">Slovacchia</option> <option value="slovenia">Slovenia</option> <option value="spagna">Spagna</option> <option value="sud-africa">Sud Africa</option> <option value="svezia">Svezia</option> <option value="svizzera">Svizzera</option> <option value="tunisia">Tunisia</option> <option value="turchia">Turchia</option> <option value="ucraina">Ucraina</option> <option value="ungheria">Ungheria</option> <option value="uruguay">Uruguay</option> <option value="usa">USA</option> <option value="venezuela">Venezuela</option> </optgroup> <optgroup label="Altro"> <option value="accessori">Accessori / Altro</option> </optgroup> </select> </div>
                </div>
                <div class="form-row">
                    <div> <label for="product-image-small">URL Immagine Piccola:</label> <input type="text" id="product-image-small" name="imageSmall" placeholder="https://..." required> </div>
                    <div> <label for="product-image-large">URL Immagine Grande (Opzionale):</label> <input type="text" id="product-image-large" name="imageLarge" placeholder="https://..."> </div>
                </div>
                <div class="form-group"> <label>Taglie Disponibili (premere Invio dopo ogni taglia):</label> <div class="tags-input-container" id="sizes-container"> <input type="text" class="tag-input" id="size-input" placeholder="Es: M, L, XL..."> </div> </div>
                <div class="form-group"> <label>Colori Disponibili (premere Invio dopo ogni colore):</label> <div class="tags-input-container" id="colors-container"> <input type="text" class="tag-input" id="color-input" placeholder="Es: Rosso, Blu..."> </div> </div>
                <button type="submit" id="submit-btn">Aggiungi Prodotto</button> <button type="button" class="clear-btn" id="clear-form-btn">Pulisci Form</button> <button type="button" class="cancel-edit-btn" id="cancel-edit-btn">Annulla Modifica</button>
            </form>
        </section>
        <button type="button" id="export-products-btn" style="margin-top: 20px;">Esporta Prodotti (JSON)</button>
        <button type="button" id="clear-all-products-btn" style="background-color: #c0392b; color:white; padding: 8px 12px; border:none; border-radius:4px; cursor:pointer; margin-top: 20px; margin-left:10px;">Svuota Tutti i Prodotti (PERICOLO!)</button>
    </div>

    <div id="confirm-delete-modal" class="modal-overlay">
        <div class="confirm-modal-content">
            <h3 id="modal-title-text">Conferma Eliminazione</h3>
            <img id="modal-delete-product-image" src="" alt="Anteprima prodotto">
            <h4 id="modal-delete-product-name"></h4>
            <p id="modal-message-text">Sei sicuro di voler eliminare questo prodotto?</p>
            <div class="modal-actions">
                <button id="modal-confirm-btn" class="modal-btn modal-btn-confirm">Conferma</button>
                <button id="modal-cancel-btn" class="modal-btn modal-btn-cancel">Annulla</button>
            </div>
        </div>
    </div>

    <div id="product-list-overlay" class="modal-overlay">
        <div id="product-list-modal-content">
            <button id="close-product-list-modal-btn" class="modal-close-btn">×</button>
            <div class="modal-list-header-controls">
                <h2>Lista Prodotti Esistenti</h2>
                <button id="toggle-all-sections-btn" title="Espandi Tutto" class="toggle-all-btn">
                    <svg class="icon-expand-all" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 0 24 24" width="20px" fill="currentColor" style="display: block;">
                        <path d="M0 0h24v24H0V0z" fill="none"/>
                        <path d="M12 13.17L16.59 8.59 18 10l-6 6-6-6 1.41-1.41L12 13.17zm0 6L16.59 14.59 18 16l-6 6-6-6 1.41-1.41L12 19.17z"/>
                    </svg>
                    <svg class="icon-collapse-all" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 0 24 24" width="20px" fill="currentColor" style="display: none;">
                        <path d="M0 0h24v24H0V0z" fill="none"/>
                        <path d="M12 10.83L7.41 15.41 6 14l6-6 6 6-1.41 1.41L12 10.83zm0-6L7.41 9.41 6 8l6-6 6 6-1.41 1.41L12 4.83z"/>
                    </svg>
                </button>
            </div>
            <div class="modal-list-container">
                <ul id="product-list" class="product-list"> </ul>
                <p id="no-products-message" class="no-products-message" style="display: none;"> Nessun prodotto trovato. Inizia aggiungendone uno! </p>
            </div>
        </div>
    </div>

    <script>
document.addEventListener('DOMContentLoaded', () => {
    const ADMIN_SESSION_TOKEN_KEY = 'adminAuthToken';
    const API_URL = 'products_api.php'; // API per i prodotti

    function isAdminAuthenticated() {
        return sessionStorage.getItem(ADMIN_SESSION_TOKEN_KEY) !== null;
    }

    function redirectToLoginGate(currentPage) {
        window.location.href = `admin-login-gate.html?redirect=${encodeURIComponent(currentPage)}`;
    }

    const currentPageName = window.location.pathname.split('/').pop();

    if (!isAdminAuthenticated()) {
        redirectToLoginGate(currentPageName);
        return; // Interrompe l'esecuzione se non autenticato
    }

    // Associa la funzionalità al pulsante di logout nell'HTML
    const logoutAdminBtn = document.getElementById('admin-logout-button'); // ID aggiornato
    if (logoutAdminBtn) {
        logoutAdminBtn.onclick = () => {
            sessionStorage.removeItem(ADMIN_SESSION_TOKEN_KEY);
            window.location.href = 'admin-login-gate.html';
        };
    } else {
        console.warn("Pulsante Logout Admin (ID: admin-logout-button) non trovato.");
    }


    // Variabili DOM specifiche per questa pagina
    const productForm = document.getElementById('product-form');
    const formTitle = document.getElementById('form-title');
    const submitBtn = document.getElementById('submit-btn');
    const cancelEditBtn = document.getElementById('cancel-edit-btn');
    const editingProductIdField = document.getElementById('editing-product-id-field');
    const adminFeedback = document.getElementById('admin-feedback');
    const exportProductsBtn = document.getElementById('export-products-btn');
    const clearAllProductsBtn = document.getElementById('clear-all-products-btn');
    const sizesContainer = document.getElementById('sizes-container');
    const sizeInput = document.getElementById('size-input');
    const colorsContainer = document.getElementById('colors-container');
    const colorInput = document.getElementById('color-input');
    const productCategorySelect = document.getElementById('product-category');
    const openProductListFab = document.getElementById('open-product-list-fab');
    const productCountBadge = openProductListFab.querySelector('.product-count-badge');
    const productListOverlay = document.getElementById('product-list-overlay');
    const closeProductListModalBtn = document.getElementById('close-product-list-modal-btn');
    const productListElement = document.getElementById('product-list');
    const noProductsMessageEl = document.getElementById('no-products-message');
    const confirmDeleteModal = document.getElementById('confirm-delete-modal');
    const modalMessageText = document.getElementById('modal-message-text');
    const modalConfirmBtn = document.getElementById('modal-confirm-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');
    const modalDeleteProductImage = document.getElementById('modal-delete-product-image');
    const modalDeleteProductName = document.getElementById('modal-delete-product-name');
   
    const toggleAllSectionsBtn = document.getElementById('toggle-all-sections-btn');
    const iconExpandAll = toggleAllSectionsBtn.querySelector('.icon-expand-all');
    const iconCollapseAll = toggleAllSectionsBtn.querySelector('.icon-collapse-all');

    let currentActionContext = null;
    let currentProducts = [];
    let editingProductId = null;
    const COLLAPSIBLE_STATE_KEY = 'productAdminCollapsibleStates_v2';
    let allSectionsCurrentlyExpanded = false;

    function getCollapsibleStates() {
        const states = localStorage.getItem(COLLAPSIBLE_STATE_KEY);
        try {
            return states ? JSON.parse(states) : {};
        } catch (e) {
            console.error("Errore nel parsing degli stati collapsible:", e);
            return {};
        }
    }

    function saveCollapsibleState(elementId, isExpanded) {
        const states = getCollapsibleStates();
        states[elementId] = isExpanded;
        localStorage.setItem(COLLAPSIBLE_STATE_KEY, JSON.stringify(states));
    }
   
    function applyCollapsibleState(headerElement, contentElement, isExpanded, animate = false) {
        if (!headerElement || !contentElement) return;

        const originalTransition = contentElement.style.transition;

        if (isExpanded) {
            headerElement.classList.add('header-expanded');
            contentElement.classList.add('expanded');
           
            if (!animate) {
                contentElement.style.transition = 'none';
            }
           
            void contentElement.offsetHeight; // Trigger reflow
            contentElement.style.maxHeight = contentElement.scrollHeight + "px";
           
            if (!animate) {
                requestAnimationFrame(() => {
                    contentElement.style.transition = originalTransition;
                });
            }
            adjustParentMaxHeightBasedOnChildrenSum(contentElement, animate);

        } else {
            headerElement.classList.remove('header-expanded');
           
            if (!animate) {
                contentElement.style.transition = 'none';
            }

            contentElement.style.maxHeight = '0px';
            contentElement.classList.remove('expanded');

            if (!animate) {
                requestAnimationFrame(() => {
                    contentElement.style.transition = originalTransition;
                });
            }
            adjustParentMaxHeightBasedOnChildrenSum(contentElement, animate, true);
        }
    }
           
    function adjustParentMaxHeightBasedOnChildrenSum(changedChildElement, animate = true, childIsCollapsingOrHasJustCollapsed = false) {
        let currentParentUL = changedChildElement.parentElement;

        while (currentParentUL && currentParentUL !== productListElement) {
            if (currentParentUL.tagName === 'UL' &&
                currentParentUL.classList.contains('collapsible-content') &&
                currentParentUL.classList.contains('expanded')) {
               
                const originalParentTransition = currentParentUL.style.transition;
                if (!animate) {
                    currentParentUL.style.transition = 'none';
                }
               
                void currentParentUL.offsetHeight; // Trigger reflow

                let newRequiredInnerHeight = 0;
               
                Array.from(currentParentUL.children).forEach((childNodeOfParent) => {
                    let childHeightContribution = 0;

                    if (childNodeOfParent.classList.contains('collapsible-header')) {
                        childHeightContribution = childNodeOfParent.offsetHeight;
                        const childStyles = window.getComputedStyle(childNodeOfParent);
                        const childMarginTop = parseFloat(childStyles.marginTop) || 0;
                        const childMarginBottom = parseFloat(childStyles.marginBottom) || 0;
                        childHeightContribution += childMarginTop + childMarginBottom;
                    }
                    else if (childNodeOfParent.tagName === 'UL' && childNodeOfParent.classList.contains('collapsible-content')) {
                        childHeightContribution = parseFloat(childNodeOfParent.style.maxHeight) || 0;
                    }
                    newRequiredInnerHeight += childHeightContribution;
                });

                const parentStyles = window.getComputedStyle(currentParentUL);
                const parentPaddingTop = parseFloat(parentStyles.paddingTop) || 0;
                const parentPaddingBottom = parseFloat(parentStyles.paddingBottom) || 0;
                const parentBorderTop = parseFloat(parentStyles.borderTopWidth) || 0;
                const parentBorderBottom = parseFloat(parentStyles.borderBottomWidth) || 0;
               
                newRequiredInnerHeight += parentPaddingTop + parentPaddingBottom + parentBorderTop + parentBorderBottom;
                currentParentUL.style.maxHeight = newRequiredInnerHeight + 'px';

                if (!animate) {
                    requestAnimationFrame(() => {
                        currentParentUL.style.transition = originalParentTransition;
                    });
                }
                currentParentUL = currentParentUL.parentElement;
            } else {
                currentParentUL = currentParentUL.parentElement;
            }
        }
    }

    function showAdminFeedback(message, type = 'success', duration = 3000) { adminFeedback.textContent = message; adminFeedback.className = type; adminFeedback.style.display = 'block'; setTimeout(() => { adminFeedback.style.display = 'none'; }, duration); }
    function setupTagInput(container, inputElement) { inputElement.addEventListener('keydown', function(event) { if (event.key === 'Enter' && this.value.trim() !== '') { event.preventDefault(); addTag(this.value.trim(), container); this.value = ''; } }); }
    function addTag(text, container) { const tag = document.createElement('span'); tag.className = 'tag-item'; tag.textContent = text; const removeBtn = document.createElement('button'); removeBtn.className = 'tag-remove-btn'; removeBtn.innerHTML = '×'; removeBtn.type = 'button'; removeBtn.onclick = () => tag.remove(); tag.appendChild(removeBtn); container.insertBefore(tag, container.querySelector('.tag-input'));  }
    function getTagsFromContainer(container) { const tags = []; container.querySelectorAll('.tag-item').forEach(tagElement => { tags.push(tagElement.firstChild.textContent.trim()); }); return tags; }
    function populateTagsToContainer(tagsArray, container) {  container.querySelectorAll('.tag-item').forEach(el => el.remove()); if (tagsArray && Array.isArray(tagsArray)) { tagsArray.forEach(tagText => addTag(tagText, container));} }
    setupTagInput(sizesContainer, sizeInput); setupTagInput(colorsContainer, colorInput);
    function updateFabProductCount(count) { if (count > 0) { productCountBadge.textContent = count; productCountBadge.style.display = 'block'; } else { productCountBadge.style.display = 'none'; } }

    async function loadProducts() { try { const response = await fetch(API_URL); if (!response.ok) { const errorData = await response.json().catch(() => ({ message: response.statusText })); throw new Error(`Errore HTTP ${response.status}: ${errorData.message}`); } currentProducts = await response.json(); updateFabProductCount(currentProducts.length); if (productListOverlay.classList.contains('visible')) { renderProductList(); updateToggleAllButtonState(); } } catch (error) { console.error('Errore nel caricamento dei prodotti:', error); showAdminFeedback(`Errore nel caricamento prodotti: ${error.message}`, 'error', 5000); currentProducts = []; updateFabProductCount(0); if (productListOverlay.classList.contains('visible')) { renderProductList(); updateToggleAllButtonState(); } } }
   
    function renderProductList() {
        productListElement.innerHTML = '';
        if (currentProducts.length === 0) { noProductsMessageEl.style.display = 'block'; productListElement.style.display = 'none'; return; }
        noProductsMessageEl.style.display = 'none'; productListElement.style.display = '';

        const groupedProducts = currentProducts.reduce((acc, product) => {
            const categoryKey = product.category || 'uncategorized';
            if (!acc[categoryKey]) acc[categoryKey] = []; acc[categoryKey].push(product); return acc;
        }, {});

        const renderedCategories = new Set();
        const createProductListItem = (product, categoryText) => {  const listItem = document.createElement('li'); listItem.className = 'product-list-item'; listItem.dataset.id = product.id; listItem.innerHTML = ` <img src="${product.imageSmall || 'https://via.placeholder.com/60'}" alt="Anteprima ${product.name}" class="product-list-item-img"> <div class="info"> <strong>${product.name}</strong> <span>ID: ${product.id} | Prezzo: €${parseFloat(product.price).toFixed(2)}</span> <span>Categoria: ${categoryText}</span> </div> <div class="actions"> <button class="edit-btn">Modifica</button> <button class="delete-btn">Elimina</button> </div>`; return listItem; };
       
        const sanitizeForId = (text) => text.toLowerCase().replace(/\W+/g, '-');

        const createCollapsibleHeader = (text, level = 'h4', isOptgroupedCategory = false, uniqueIdPrefix) => {
            const header = document.createElement(level);
            header.classList.add('collapsible-header');
            const sanitizedText = sanitizeForId(text);
            header.id = `${uniqueIdPrefix}-${sanitizedText}`;
            if (isOptgroupedCategory) header.classList.add('optgrouped-category');
            header.innerHTML = `<span>${text}</span> <span class="indicator">▾</span>`;
            return header;
        };

        const renderGroup = (categoryKey, categoryDisplayName, optgroupLabel = null) => {
            if (!groupedProducts[categoryKey] || groupedProducts[categoryKey].length === 0) return;

            let parentElementForHeaderAndContent = productListElement;
            let header, contentUl;
           
            const sanitizedCategoryKey = sanitizeForId(categoryKey);
            const sanitizedOptgroupLabel = optgroupLabel ? sanitizeForId(optgroupLabel) : '';
           
            if (optgroupLabel) {
                const optgroupHeaderId = `optgroup-${sanitizedOptgroupLabel}`;
                const optgroupContentWrapperId = `content-wrapper-optgroup-${sanitizedOptgroupLabel}`;
                let optgroupContentWrapper = document.getElementById(optgroupContentWrapperId);

                if (!optgroupContentWrapper) {
                    const optgroupHeader = createCollapsibleHeader(optgroupLabel, 'h3', false, 'optgroup');
                    optgroupHeader.id = optgroupHeaderId;
                    productListElement.appendChild(optgroupHeader);

                    optgroupContentWrapper = document.createElement('ul');
                    optgroupContentWrapper.id = optgroupContentWrapperId;
                    optgroupContentWrapper.className = 'collapsible-content';
                    productListElement.appendChild(optgroupContentWrapper);
                    optgroupHeader.dataset.target = `#${optgroupContentWrapperId}`;
                }
                parentElementForHeaderAndContent = optgroupContentWrapper;
                header = createCollapsibleHeader(categoryDisplayName, 'h4', true, `category-in-${sanitizedOptgroupLabel}`);
            } else {
                header = createCollapsibleHeader(categoryDisplayName, 'h4', false, 'category');
            }
           
            parentElementForHeaderAndContent.appendChild(header);
           
            const productListUlId = `product-list-for-${header.id}`;
            contentUl = document.createElement('ul');
            contentUl.id = productListUlId;
            contentUl.className = 'collapsible-content';
            parentElementForHeaderAndContent.appendChild(contentUl);
            header.dataset.target = `#${productListUlId}`;


            groupedProducts[categoryKey].forEach(product => {
                contentUl.appendChild(createProductListItem(product, categoryDisplayName));
            });
            renderedCategories.add(categoryKey);
        };

        Array.from(productCategorySelect.getElementsByTagName('optgroup')).forEach(optgroup => {  const optgroupLabel = optgroup.label; Array.from(optgroup.getElementsByTagName('option')).forEach(option => { if (option.value) renderGroup(option.value, option.textContent, optgroupLabel); }); });
        Array.from(productCategorySelect.options).forEach(option => {  if (option.value && option.parentElement === productCategorySelect && !renderedCategories.has(option.value)) { renderGroup(option.value, option.textContent); } });
        if (groupedProducts['uncategorized'] && !renderedCategories.has('uncategorized')) {  renderGroup('uncategorized', 'Senza Categoria'); }
        Object.keys(groupedProducts).forEach(categoryKey => {  if (!renderedCategories.has(categoryKey)) { const fallbackDisplayName = categoryKey.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()); renderGroup(categoryKey, fallbackDisplayName, 'Altro (Dati Esistenti)'); } });
       
        const savedStates = getCollapsibleStates();
        productListElement.querySelectorAll('.collapsible-header').forEach(headerEl => {
            const targetSelector = headerEl.dataset.target;
            const contentEl = targetSelector ? document.querySelector(targetSelector) : null;
            if (contentEl) {
                const isExpanded = savedStates[headerEl.id] === true;
                applyCollapsibleState(headerEl, contentEl, isExpanded, false);
            } else {
                console.warn(`    No content element found for header ${headerEl.id} with target ${targetSelector}`);
            }
        });
    }

    productForm.addEventListener('submit', async function(event) { event.preventDefault(); submitBtn.disabled = true; const name = document.getElementById('product-name').value; const description = document.getElementById('product-description').value; const price = parseFloat(document.getElementById('product-price').value); const category = productCategorySelect.value;  const imageSmall = document.getElementById('product-image-small').value; const imageLarge = document.getElementById('product-image-large').value || imageSmall;  const availableSizes = getTagsFromContainer(sizesContainer); const availableColors = getTagsFromContainer(colorsContainer); if (!name || !description || !category || !imageSmall) { showAdminFeedback('Per favore, compila tutti i campi obbligatori (Nome, Descrizione, Categoria, URL Img Piccola).', 'error'); submitBtn.disabled = false; return; } if (isNaN(price) || price < 0) { showAdminFeedback('Il prezzo non è valido.', 'error'); submitBtn.disabled = false; return; } const productData = { name, description, price, category, imageSmall, imageLarge, availableSizes, availableColors }; let url = API_URL; let method = 'POST'; if (editingProductId) { productData.id = editingProductId; method = 'PUT'; } try { const response = await fetch(url, { method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(productData) }); const responseData = await response.json(); if (!response.ok) throw new Error(responseData.message || `Errore HTTP ${response.status}`); showAdminFeedback(responseData.message || (editingProductId ? 'Prodotto modificato!' : 'Prodotto aggiunto!'), 'success'); await loadProducts(); resetForm(); } catch (error) { console.error('Errore invio form:', error); showAdminFeedback(`Errore: ${error.message}`, 'error'); } finally { submitBtn.disabled = false; } });
   
    function resetForm() { productForm.reset(); editingProductIdField.value = ''; editingProductId = null; formTitle.textContent = 'Aggiungi Nuovo Prodotto'; submitBtn.textContent = 'Aggiungi Prodotto'; cancelEditBtn.style.display = 'none'; populateTagsToContainer([], sizesContainer); populateTagsToContainer([], colorsContainer);  productCategorySelect.value = '';  }
    document.getElementById('clear-form-btn').addEventListener('click', resetForm);
    cancelEditBtn.addEventListener('click', resetForm);
   
    function showConfirmDeleteModal(productToDelete, onConfirmCallback) {
        if (modalDeleteProductImage) {
            modalDeleteProductImage.src = productToDelete.imageSmall || 'https://via.placeholder.com/100x100?text=N/A';
            modalDeleteProductImage.alt = `Anteprima ${productToDelete.name}`;
        }
        if (modalDeleteProductName) {
            modalDeleteProductName.textContent = productToDelete.name;
        }
        modalMessageText.innerHTML = `Sei sicuro di voler eliminare questo prodotto (ID: <strong>${productToDelete.id}</strong>)? L'azione è irreversibile.`;
        currentActionContext = { onConfirm: onConfirmCallback };
        confirmDeleteModal.classList.add('visible');
        document.body.classList.add('modal-open');
    }

    function hideConfirmDeleteModal() { confirmDeleteModal.classList.remove('visible'); currentActionContext = null; if (!productListOverlay.classList.contains('visible')) { document.body.classList.remove('modal-open'); } }
    modalConfirmBtn.addEventListener('click', () => { if (currentActionContext && typeof currentActionContext.onConfirm === 'function') { currentActionContext.onConfirm(); } hideConfirmDeleteModal(); });
    modalCancelBtn.addEventListener('click', hideConfirmDeleteModal);
    confirmDeleteModal.addEventListener('click', (event) => { if (event.target === confirmDeleteModal) hideConfirmDeleteModal(); });
   
    function updateToggleAllButtonState() {
        const allHeaders = productListElement.querySelectorAll('.collapsible-header');
        if (allHeaders.length === 0) {
            toggleAllSectionsBtn.style.display = 'none';
            return;
        }
        toggleAllSectionsBtn.style.display = 'flex';

        let numExpanded = 0;
        allHeaders.forEach(headerEl => {
            const targetSelector = headerEl.dataset.target;
            const contentEl = targetSelector ? document.querySelector(targetSelector) : null;
            if (contentEl && contentEl.classList.contains('expanded')) {
                numExpanded++;
            }
        });

        if (numExpanded === allHeaders.length) {
            allSectionsCurrentlyExpanded = true;
            iconExpandAll.style.display = 'none';
            iconCollapseAll.style.display = 'block';
            toggleAllSectionsBtn.title = "Comprimi Tutto";
        } else if (numExpanded === 0 && allHeaders.length > 0) {
            allSectionsCurrentlyExpanded = false;
            iconExpandAll.style.display = 'block';
            iconCollapseAll.style.display = 'none';
            toggleAllSectionsBtn.title = "Espandi Tutto";
        } else { // Caso misto
            allSectionsCurrentlyExpanded = false;
            iconExpandAll.style.display = 'block';
            iconCollapseAll.style.display = 'none';
            toggleAllSectionsBtn.title = "Espandi Tutto";
        }
    }

    function showProductListModal() {
        renderProductList();
        productListOverlay.classList.add('visible');
        document.body.classList.add('modal-open'); 
        updateToggleAllButtonState();
    }
    function hideProductListModal() { productListOverlay.classList.remove('visible'); if (!confirmDeleteModal.classList.contains('visible')) { document.body.classList.remove('modal-open'); } }
    openProductListFab.addEventListener('click', showProductListModal);
    closeProductListModalBtn.addEventListener('click', hideProductListModal);
    productListOverlay.addEventListener('click', (event) => { if (event.target === productListOverlay) hideProductListModal(); });
   
    toggleAllSectionsBtn.addEventListener('click', () => {
        allSectionsCurrentlyExpanded = !allSectionsCurrentlyExpanded;

        if (allSectionsCurrentlyExpanded) {
            iconExpandAll.style.display = 'none';
            iconCollapseAll.style.display = 'block';
            toggleAllSectionsBtn.title = "Comprimi Tutto";
        } else {
            iconExpandAll.style.display = 'block';
            iconCollapseAll.style.display = 'none';
            toggleAllSectionsBtn.title = "Espandi Tutto";
        }

        const allHeaders = productListElement.querySelectorAll('.collapsible-header');
        allHeaders.forEach(headerEl => {
            const targetSelector = headerEl.dataset.target;
            const contentEl = targetSelector ? document.querySelector(targetSelector) : null;
            if (contentEl) {
                applyCollapsibleState(headerEl, contentEl, allSectionsCurrentlyExpanded, true);
                saveCollapsibleState(headerEl.id, allSectionsCurrentlyExpanded);
            }
        });
    });
           
    productListElement.addEventListener('click', function(event) {
        const header = event.target.closest('.collapsible-header');
        if (header && header.dataset.target) {
            const targetSelector = header.dataset.target;
            const targetElement = document.querySelector(targetSelector);
            if (targetElement) {
                const isCurrentlyExpanded = targetElement.classList.contains('expanded');
                applyCollapsibleState(header, targetElement, !isCurrentlyExpanded, true);
                saveCollapsibleState(header.id, !isCurrentlyExpanded);
                updateToggleAllButtonState();
            } else {
                 console.warn(`Click on header ${header.id}, but target ${targetSelector} not found!`);
            }
        }

        const targetButton = event.target.closest('button'); 
        if (!targetButton) return;

        const listItem = targetButton.closest('.product-list-item');
        if (!listItem) return;
        const productIdFromDOM = listItem.dataset.id;
        if (targetButton.classList.contains('edit-btn')) { const productToEdit = currentProducts.find(p => p.id == productIdFromDOM); if (productToEdit) { hideProductListModal();  formTitle.textContent = 'Modifica Prodotto'; submitBtn.textContent = 'Salva Modifiche'; cancelEditBtn.style.display = 'inline-block'; editingProductId = productToEdit.id; editingProductIdField.value = productToEdit.id; document.getElementById('product-name').value = productToEdit.name; document.getElementById('product-description').value = productToEdit.description; document.getElementById('product-price').value = productToEdit.price; productCategorySelect.value = productToEdit.category || "";  document.getElementById('product-image-small').value = productToEdit.imageSmall; document.getElementById('product-image-large').value = productToEdit.imageLarge || ''; populateTagsToContainer(productToEdit.availableSizes || [], sizesContainer); populateTagsToContainer(productToEdit.availableColors || [], colorsContainer); if(window.innerWidth > 600) { productForm.scrollIntoView({ behavior: 'smooth', block: 'start' }); } else { window.scrollTo({ top:0, behavior: 'smooth'}); } }
        } else if (targetButton.classList.contains('delete-btn')) {
            const productToDelete = currentProducts.find(p => p.id == productIdFromDOM);
            if (productToDelete) {
                showConfirmDeleteModal(
                    productToDelete,
                    async () => {
                        try {
                            const response = await fetch(`${API_URL}?id=${productIdFromDOM}`, { method: 'DELETE' });
                            const responseData = await response.json();
                            if (!response.ok) throw new Error(responseData.message || `Errore HTTP ${response.status}`);
                            showAdminFeedback(responseData.message || 'Prodotto eliminato.', 'info');
                            await loadProducts(); 
                            if (editingProductId == productIdFromDOM) resetForm();
                        } catch (error) {
                            console.error('Errore eliminazione:', error);
                            showAdminFeedback(`Errore eliminazione: ${error.message}`, 'error');
                        }
                    }
                );
            }
        }
    });

    exportProductsBtn.addEventListener('click', async () => { try { const response = await fetch(API_URL); if (!response.ok) throw new Error('Errore nel fetch dei dati per l\'esportazione'); const productsToExport = await response.json(); if (productsToExport.length === 0) { showAdminFeedback('Nessun prodotto da esportare.', 'info'); return; } const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(productsToExport, null, 2)); const downloadAnchorNode = document.createElement('a'); downloadAnchorNode.setAttribute("href", dataStr); downloadAnchorNode.setAttribute("download", "products_data.json"); document.body.appendChild(downloadAnchorNode); downloadAnchorNode.click(); downloadAnchorNode.remove(); showAdminFeedback('Dati prodotti esportati!', 'success'); } catch (error) { console.error("Errore esportazione:", error); showAdminFeedback(`Errore esportazione: ${error.message}`, 'error');} });
    clearAllProductsBtn.addEventListener('click', async () => {  if (confirm('ATTENZIONE! Sei assolutamente sicuro di voler eliminare TUTTI i prodotti dal database? Questa azione non può essere annullata.')) { if (confirm('CONFERMA DEFINITIVA: Vuoi davvero svuotare la tabella prodotti?')) { try { showAdminFeedback('Tentativo di eliminazione di tutti i prodotti...', 'info', 10000); const response = await fetch(`${API_URL}?action=clearallproducts&confirm=true`, { method: 'DELETE'}); if (!response.ok) { const errorData = await response.json().catch(() => ({message: 'Errore sconosciuto.'})); throw new Error(errorData.message || `Errore HTTP ${response.status}`); } const result = await response.json(); await loadProducts(); resetForm(); showAdminFeedback(result.message || 'Tutti i prodotti sono stati eliminati.', 'success'); } catch (error) { console.error("Errore svuotamento prodotti:", error); showAdminFeedback(`Errore durante lo svuotamento: ${error.message}`, 'error'); } } } });
   
    loadProducts();
});
    </script>
</body>
</html>