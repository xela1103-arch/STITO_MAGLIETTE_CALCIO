<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accesso Amministrazione</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #f0f2f5; margin: 0; }
        .gate-container { background-color: #fff; padding: 30px 40px; border-radius: 10px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); text-align: center; width: 100%; max-width: 450px; }
        h2 { color: #2c3e50; margin-bottom: 25px; font-size: 1.8rem; }
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; color: #555; }
        .form-group input[type="password"] { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 1rem; }
        .form-group input[type="password"]:focus { border-color: #1abc9c; outline: none; box-shadow: 0 0 0 2px rgba(26,188,156,0.2); }
        button { background-color: #1abc9c; color: white; padding: 12px 20px; border: none; border-radius: 5px; font-size: 1.1rem; cursor: pointer; transition: background-color 0.2s; width: 100%; font-weight: 600; }
        button:hover { background-color: #16a085; }
        .feedback { margin-top: 15px; padding: 10px; border-radius: 5px; display: none; }
        .feedback.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .feedback.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .change-password-link { display: block; margin-top: 20px; font-size: 0.9rem; color: #3498db; text-decoration: none; }
        .change-password-link:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="gate-container">
        <div id="loading-state">
            <h2><i class="fas fa-spinner fa-spin"></i> Verifica Configurazione...</h2>
        </div>

        <div id="set-initial-password-section" style="display:none;">
            <h2>Imposta Password Amministratore</h2>
            <p>Sembra che questa sia la prima volta che accedi all'area admin o la password non Ã¨ impostata. Creane una.</p>
            <form id="set-initial-password-form">
                <div class="form-group">
                    <label for="initial-new-password">Nuova Password Admin (min. 8 caratteri):</label>
                    <input type="password" id="initial-new-password" required minlength="8">
                </div>
                <div class="form-group">
                    <label for="initial-confirm-password">Conferma Nuova Password:</label>
                    <input type="password" id="initial-confirm-password" required>
                </div>
                <button type="submit">Imposta Password</button>
            </form>
        </div>

        <div id="login-section" style="display:none;">
            <h2>Accesso Area Amministrazione</h2>
            <form id="admin-login-form">
                <div class="form-group">
                    <label for="admin-password">Password Amministratore:</label>
                    <input type="password" id="admin-password" required>
                </div>
                <button type="submit">Accedi</button>
            </form>
            <a href="admin-change-password.html" class="change-password-link">Cambia Password Admin</a>
        </div>
        <div id="admin-gate-feedback" class="feedback"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const ADMIN_AUTH_API_URL = 'admin_auth_api.php';
            const ADMIN_SESSION_TOKEN_KEY = 'adminAuthToken';

            const loadingStateDiv = document.getElementById('loading-state');
            const setInitialPasswordSection = document.getElementById('set-initial-password-section');
            const loginSection = document.getElementById('login-section');
            const feedbackDiv = document.getElementById('admin-gate-feedback');

            const setInitialPasswordForm = document.getElementById('set-initial-password-form');
            const adminLoginForm = document.getElementById('admin-login-form');

            function showFeedback(message, type = 'error') {
                feedbackDiv.textContent = message;
                feedbackDiv.className = `feedback ${type}`;
                feedbackDiv.style.display = 'block';
            }

            async function checkAdminPasswordStatus() {
                try {
                    const response = await fetch(`${ADMIN_AUTH_API_URL}?action=check_password_set`);
                    if (!response.ok) throw new Error('Errore nel controllo password.');
                    const data = await response.json();

                    loadingStateDiv.style.display = 'none';
                    if (data.isPasswordSet) {
                        loginSection.style.display = 'block';
                    } else {
                        setInitialPasswordSection.style.display = 'block';
                    }
                } catch (error) {
                    showFeedback(error.message || 'Impossibile connettersi al server.');
                    loadingStateDiv.innerHTML = `<h2>Errore di connessione</h2><p>${error.message}</p>`;
                }
            }

            if (setInitialPasswordForm) {
                setInitialPasswordForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const newPassword = document.getElementById('initial-new-password').value;
                    const confirmPassword = document.getElementById('initial-confirm-password').value;

                    if (newPassword.length < 8) {
                        showFeedback('La password deve essere di almeno 8 caratteri.');
                        return;
                    }
                    if (newPassword !== confirmPassword) {
                        showFeedback('Le password non coincidono.');
                        return;
                    }
                    try {
                        const response = await fetch(`${ADMIN_AUTH_API_URL}?action=set_initial_password`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ new_password: newPassword })
                        });
                        const result = await response.json();
                        if (!response.ok && response.status !== 201) throw new Error(result.message || 'Errore impostazione password.');
                        
                        showFeedback(result.message, 'success');
                        setTimeout(() => {
                            setInitialPasswordSection.style.display = 'none';
                            loginSection.style.display = 'block';
                            feedbackDiv.style.display = 'none';
                        }, 2000);
                    } catch (error) {
                        showFeedback(error.message);
                    }
                });
            }

            if (adminLoginForm) {
                adminLoginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const password = document.getElementById('admin-password').value;
                    try {
                        const response = await fetch(`${ADMIN_AUTH_API_URL}?action=login_admin`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ password: password })
                        });
                        const result = await response.json();
                        if (!response.ok) throw new Error(result.message || 'Login fallito.');
                        
                        if (result.isAdminAuthenticated && result.token) {
                            sessionStorage.setItem(ADMIN_SESSION_TOKEN_KEY, result.token); // Salva il token fittizio
                            showFeedback('Login riuscito! Reindirizzamento...', 'success');
                            // Reindirizza alla pagina di gestione prodotti o ordini desiderata
                            // Potresti passare un parametro ?redirect=admin-add-product.html
                            const urlParams = new URLSearchParams(window.location.search);
                            const redirectTo = urlParams.get('redirect') || 'admin-add-product.html'; // Default
                            window.location.href = redirectTo;
                        } else {
                           throw new Error(result.message || 'Autenticazione fallita.');
                        }
                    } catch (error) {
                        showFeedback(error.message);
                    }
                });
            }
            checkAdminPasswordStatus();
        });
    </script>
</body>
</html>