<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Il Nostro Negozio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- CSS styles will be linked or embedded here -->
    <style>
         :root {
        --primary-color: #1abc9c;
        --secondary-color: #2c3e50;
        --accent-color: #e74c3c;
        --light-gray: #f0f2f5;
        --dark-gray: #7f8c8d;
        --text-color: #333;
        --border-radius: 8px;
        --box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        --side-modal-width: 450px;
        --side-modal-width-mobile: 90%;
        --side-navigation-width: 320px;

        --toast-success-bg: #2ecc71;
        --toast-success-icon: #27ae60;
        --toast-error-bg: #e74c3c;
        --toast-error-icon: #c0392b;
        --toast-info-bg: #3498db;
        --toast-info-icon: #2980b9;
        --toast-warning-bg: #f39c12;
        --toast-warning-icon: #e67e22;
        --toast-text-color: #fff;
        --toast-gap: 10px;

        /* Nuovi colori per stati ordine */
        --status-processing-bg: #3498db;
        --status-shipped-bg: #f39c12;
        --status-delivered-bg: #2ecc71;
        --status-cancelled-bg: #e74c3c;
        --status-pending-payment-bg: #e67e22; /* Orange for pending payment */
        --status-text-color: #fff;
    }

    /* Regola per impedire la selezione di qualsiasi elemento nella pagina */
    * {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        background-color: var(--light-gray);
        color: var(--text-color);
        margin: 0;
        padding-top: 80px;
        overflow-x: hidden;
    }
    body.body-scroll-locked {
        overflow: hidden;
    }

    .container {
        width: 90%;
        max-width: 1200px;
        margin: 20px auto;
        padding: 0 15px;
    }

    header {
        background-color: #fff;
        box-shadow: var(--box-shadow);
        padding: 15px 0;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        z-index: 1000;
    }
    header .container {
        display: flex;
        align-items: center;
        margin-top: 0; margin-bottom: 0;
    }
    #hamburger-btn {
        background: none;
        border: none;
        color: var(--secondary-color);
        font-size: 1.6rem;
        cursor: pointer;
        padding: 5px 10px 5px 0;
    }
    .logo {
        font-size: 1.8rem;
        font-weight: bold;
        color: var(--primary-color);
        text-decoration: none;
        margin-left: 10px;
        margin-right: auto;
    }
    .nav-icons {
        display: flex;
        align-items: center;
    }
    .nav-icons button, .nav-icons .user-account-controls button {
        background: none;
        border: none;
        color: var(--secondary-color);
        font-size: 1.5rem;
        margin-left: 20px;
        cursor: pointer;
        position: relative;
    }
    .nav-icons .user-account-controls button {
        font-size: 0.95rem; /* Dimensione più piccola per testo */
        padding: 8px 12px;
        border: 1px solid transparent;
        border-radius: var(--border-radius);
        transition: background-color 0.2s, color 0.2s;
    }
    .nav-icons .user-account-controls button:hover {
        background-color: var(--light-gray);
        border-color: #ddd;
    }
     .nav-icons .user-account-controls .username-display {
        font-size: 0.95rem;
        color: var(--secondary-color);
        margin-left: 20px;
        font-weight: 500;
    }

    .nav-icons button .badge {
        position: absolute;
        top: -8px;
        right: -10px;
        background-color: var(--accent-color);
        color: white;
        border-radius: 50%;
        padding: 2px 6px;
        font-size: 0.7rem;
        font-weight: bold;
    }

    /* Side Navigation Menu */
    #side-navigation-menu {
        position: fixed;
        top: 0;
        left: 0;
        width: var(--side-navigation-width);
        max-width: 85%;
        height: 100vh;
        background-color: #ffffff;
        z-index: 1050;
        box-shadow: 0 0 25px rgba(0,0,0,0.15);
        transform: translateX(-100%);
        transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        display: flex;
        flex-direction: column;
    }
    #side-navigation-menu.open {
        transform: translateX(0);
    }

    .side-menu-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 25px;
        border-bottom: 1px solid var(--light-gray);
        flex-shrink: 0;
    }
    .side-menu-header h3 {
        margin: 0;
        font-size: 1.5rem;
        color: var(--primary-color);
        font-weight: 600;
    }
    #close-side-menu-btn {
        background: none;
        border: none;
        font-size: 2.2rem;
        color: var(--secondary-color);
        cursor: pointer;
        padding: 5px;
        line-height: 1;
    }
    #close-side-menu-btn:hover {
        color: var(--accent-color);
    }

    .side-menu-content {
        padding: 15px;
        overflow-y: auto;
        flex-grow: 1;
    }

    .menu-item {
        margin-bottom: 8px;
        border-radius: var(--border-radius);
        overflow: hidden;
        background-color: #fff;
    }

    .main-category-toggle {
        background-color: transparent;
        border: none;
        padding: 15px 20px;
        width: 100%;
        text-align: left;
        font-size: 1.05rem;
        font-weight: 500;
        color: var(--secondary-color);
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color 0.2s ease;
    }
    .main-category-toggle:hover {
        background-color: #f7f7f7;
    }
    .main-category-toggle span i {
        margin-right: 12px;
        color: var(--primary-color);
        font-size: 1.2em;
        vertical-align: middle;
    }
    .main-category-toggle .arrow-icon {
        transition: transform 0.35s cubic-bezier(0.25, 0.8, 0.25, 1);
        font-size: 0.9em;
    }
    .main-category-toggle[aria-expanded="true"] .arrow-icon {
        transform: rotate(180deg);
    }


    .submenu {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.45s cubic-bezier(0.23, 1, 0.32, 1),
                    padding-top 0.45s cubic-bezier(0.23, 1, 0.32, 1),
                    padding-bottom 0.45s cubic-bezier(0.23, 1, 0.32, 1);
        background-color: #f8f9fa;
    }
    .submenu.open {
        padding-top: 5px;
        padding-bottom: 5px;
    }

    .submenu-item {
        display: block;
        padding: 10px 20px 10px 35px;
        text-decoration: none;
        color: var(--dark-gray);
        font-size: 0.85rem;
        font-weight: 500;
        transition: background-color 0.2s ease, color 0.2s ease, padding-left 0.2s ease;
        position: relative;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .submenu-item::before {
        content: '';
        position: absolute;
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
        height: 60%;
        width: 2px;
        background-color: var(--primary-color);
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .submenu-item:hover, .submenu-item.active {
        background-color: var(--primary-color);
        color: white;
    }
    .submenu-item:hover::before, .submenu-item.active::before {
        opacity: 1;
    }

    .submenu-item i {
        margin-right: 10px;
        color: var(--secondary-color);
        transition: color 0.2s ease;
        font-size: 0.95em;
    }
    .submenu-item:hover i, .submenu-item.active i {
        color: white;
    }

    #side-menu-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.4);
        z-index: 1040;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.4s ease, visibility 0s 0.4s;
    }
    #side-menu-overlay.active {
        opacity: 1;
        visibility: visible;
        transition: opacity 0.4s ease, visibility 0s 0s;
    }

    #page-category-title {
        text-align: center;
        margin-top: 20px;
        margin-bottom: 10px;
        font-size: 1.8rem;
        color: var(--secondary-color);
        font-weight: 600;
    }


    .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, max-content));
        gap: 25px;
        margin-top: 10px;
        padding-bottom: 30px;
    }
    .product-card {
        background-color: #fff;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .product-card img {
        width: 100%;
        height: 220px;
        object-fit: contain;
        background-color: #f9f9f9;
        transition: transform 0.3s ease;
    }
    .product-card:hover .product-card-actions .btn {
        opacity: 1;
        transform: translateY(0);
    }

    .product-card-content {
        padding: 20px;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }
    .product-card h3 {
        font-size: 1.3rem;
        color: var(--secondary-color);
        margin-top: 0;
        margin-bottom: 10px;
        white-space: nowrap;
    }
    .product-card .price {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 15px;
        letter-spacing: 0.5px;
    }
    .product-card-actions {
        margin-top: auto;
        display: flex;
        gap: 10px;
        align-items: center;
    }
    .product-card-actions .btn {
        padding: 8px 12px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background-color 0.2s ease, opacity 0.3s ease, transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        flex-grow: 1;
        text-align: center;
        opacity: 0;
        transform: translateY(15px);
    }
    .product-card-actions .details-btn {
        transition-delay: 0.05s;
    }
    .product-card-actions .wishlist-btn-card {
        transition-delay: 0.1s;
    }
    .product-card:hover .product-card-actions .details-btn,
    .product-card:hover .product-card-actions .wishlist-btn-card {
        opacity: 1;
        transform: translateY(0);
    }

    .product-card-actions .btn i { margin-right: 5px; }

    #product-grid .product-card-actions .details-btn {
        background-color: var(--secondary-color);
        color: white;
    }
    #product-grid .product-card-actions .details-btn:hover {
        background-color: #34495e;
    }
    #product-grid .product-card-actions .wishlist-btn-card {
        background: none;
        color: var(--dark-gray);
        font-size: 1.3rem;
        padding: 5px;
        flex-grow: 0;
        border: 1px solid transparent;
    }
    #product-grid .product-card-actions .wishlist-btn-card.active {
        color: var(--accent-color);
    }
    #product-grid .product-card-actions .wishlist-btn-card:hover {
        color: var(--accent-color);
    }

    @keyframes shake-product-card {
        0%, 100% { transform: translateX(0) translateY(0); }
        20%, 60% { transform: translateX(-3px) translateY(0); }
        40%, 80% { transform: translateX(3px) translateY(0); }
    }
    #product-grid .product-card.removing-from-wishlist-main {
        animation: shake-product-card 0.4s ease-in-out;
    }

    #wishlist-page-grid .product-card-actions .details-btn-wishlist {
        background-color: var(--secondary-color);
        color: white;
    }
    #wishlist-page-grid .product-card-actions .details-btn-wishlist:hover {
        background-color: #34495e;
    }
    #wishlist-page-grid .product-card-actions .remove-from-wishlist-page-btn {
        background-color: var(--accent-color);
        color: white;
    }
    #wishlist-page-grid .product-card-actions .remove-from-wishlist-page-btn:hover {
        background-color: #c0392b;
    }

    @keyframes zoom-out-blur-effect {
        0% {
            transform: scale(1);
            opacity: 1;
            filter: blur(0px);
        }
        100% {
            transform: scale(0.5);
            opacity: 0;
            filter: blur(8px);
        }
    }
    #wishlist-page-grid .product-card.is-removing-from-wishlist {
        animation: zoom-out-blur-effect 0.5s forwards ease-out;
    }

    .modal {
        display: flex;
        align-items: center;
        justify-content: center;
        position: fixed;
        z-index: 1020; /* AUMENTATO: per essere sopra la wishlist-page (1010) */
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background-color: rgba(0,0,0,0.0);
        visibility: hidden;
        opacity: 0;
        transition: background-color 0.4s ease, visibility 0s 0.4s, opacity 0.4s ease;
    }
    .modal.active {
        background-color: rgba(0,0,0,0.6);
        visibility: visible;
        opacity: 1;
        transition: background-color 0.4s ease, visibility 0s 0s, opacity 0.4s ease;
    }

    .modal-content {
        background-color: #fff;
        margin: auto;
        padding: 30px;
        border-radius: var(--border-radius);
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        width: 90%;
        max-width: 700px; /* Default max-width, can be overridden */
        position: relative;
        transform: translateY(-30px) scale(0.95);
        opacity: 0;
        transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        max-height: 90vh;
        overflow-y: auto;
    }
    .modal.active .modal-content {
        transform: translateY(0) scale(1);
        opacity: 1;
    }
    .modal-close {
        color: var(--dark-gray);
        position: absolute;
        top: 15px;
        right: 20px;
        font-size: 2rem;
        font-weight: bold;
        cursor: pointer;
        z-index: 10;
    }
    .modal-close:hover {
        color: var(--text-color);
    }
    .modal-header h2 {
        margin-top: 0;
        margin-bottom: 20px;
        color: var(--secondary-color);
        font-size: 1.6rem;
        text-align: center;
    }

    .side-modal-content {
        background-color: #fff;
        width: var(--side-modal-width);
        max-width: 100%;
        height: 100vh;
        box-shadow: -5px 0 25px rgba(0,0,0,0.25);
        position: fixed;
        top: 0;
        right: calc(-1 * var(--side-modal-width));
        visibility: hidden;
        opacity: 0.9;
        transition: right 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55),
                    visibility 0s 0.5s,
                    opacity 0.4s ease-in-out;
        display: flex;
        flex-direction: column;
        z-index: 1002;
    }
    .modal.active .side-modal-content {
        right: 0;
        visibility: visible;
        opacity: 1;
        transition: right 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55),
                    visibility 0s 0s,
                    opacity 0.4s ease-in-out 0.1s;
    }
    .side-modal-content .modal-close {
        top: 10px; right: 15px; font-size: 1.8rem;
    }
    .side-modal-content h2 {
        margin: 0;
        padding: 20px 25px;
        color: var(--secondary-color);
        border-bottom: 1px solid var(--light-gray);
        font-size: 1.4rem;
        flex-shrink: 0;
    }
    #cart-items-container {
        flex-grow: 1;
        overflow-y: auto;
        padding: 25px;
        display: flex;
        flex-direction: column;
    }

    .cart-item {
        perspective: 1000px;
        border-bottom: 1px solid var(--light-gray);
        position: relative;
    }
    .cart-item:last-child {
        border-bottom: none;
    }

    .cart-item-inner {
        position: relative;
        width: 100%;
        transform-style: preserve-3d;
        transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .cart-item.is-flipped .cart-item-inner {
        transform: rotateY(180deg);
    }

    .cart-item-front, .cart-item-back {
        width: 100%;
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
        box-sizing: border-box;
    }

    .cart-item-front {
        display: flex;
        align-items: center;
        padding: 15px 0;
    }
    .cart-item-front img {
        width: 60px; height: 60px; object-fit: cover;
        border-radius: 5px; margin-right: 15px;
        flex-shrink: 0;
    }
    .cart-item-front .list-item-info {
        flex-grow: 1;
        margin-right: 10px;
    }
    .cart-item-front .list-item-info h4 { margin: 0 0 5px 0; font-size: 1rem; color: var(--secondary-color); }
    .cart-item-front .list-item-info p { margin: 2px 0; font-size: 0.9rem; color: var(--dark-gray); }
    .cart-item-unit-price, .cart-item-total-price {
        font-weight: 600;
        color: var(--primary-color);
    }
    .cart-item-unit-price {
        font-size: 0.95rem;
    }
    .cart-item-total-price {
        font-size: 1rem;
        font-weight: 700;
    }
    .cart-item-qty-display {
        font-size: 0.85rem;
        color: var(--dark-gray);
    }

    .cart-item-front .cart-item-quantity {
        display: flex;
        align-items: center;
        flex-shrink: 0;
    }
    .cart-item-front .cart-item-quantity button {
        background-color: var(--light-gray); border: 1px solid #ccc; color: var(--text-color);
        padding: 2px 6px; font-size: 0.9rem; cursor: pointer; border-radius: 3px;
        line-height: 1;
    }
    .cart-item-front .cart-item-quantity input {
        width: 30px; text-align: center; border: 1px solid #ccc;
        border-left: none; border-right: none; padding: 3px 0;
        font-size: 0.9rem;
        height: calc(1em + 6px);
        box-sizing: border-box;
    }
    .cart-item-front .list-item-actions {
        display: flex;
        align-items: center;
        flex-shrink: 0;
        margin-left: 10px;
    }
    .cart-item-front .list-item-actions button {
        background: none; border: none; color: var(--dark-gray); /* Changed default color */
        font-size: 1.2rem; cursor: pointer; margin-left: 8px; /* Adjusted margin */
        padding: 5px; /* Added padding for better click area */
        transition: color 0.2s ease;
        line-height: 1;
    }
    .cart-item-front .list-item-actions .remove-from-cart-trigger {
        color: var(--accent-color); /* Red for remove */
    }
    .cart-item-front .list-item-actions .edit-cart-item-btn {
        color: var(--primary-color); /* Primary color for edit */
    }
    .cart-item-front .list-item-actions button:hover {
        color: var(--secondary-color);
    }


    .cart-item-back {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        background-color: var(--secondary-color);
        color: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        border-radius: var(--border-radius);
        transform: rotateY(180deg);
        text-align: center;
    }
    .cart-item-back h5 {
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 1.1rem;
        font-weight: 600;
    }
    .cart-item-back .confirmation-actions button {
        margin: 5px;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 500;
        border: none;
        transition: background-color 0.2s ease, transform 0.2s ease;
    }
    .cart-item-back .confirm-delete-btn {
        background-color: var(--accent-color);
        color:white;
    }
    .cart-item-back .confirm-delete-btn:hover {
        background-color: #c0392b;
        transform: translateY(-1px);
    }
    .cart-item-back .cancel-delete-btn {
        background-color: var(--light-gray);
        color:var(--text-color);
        border:1px solid var(--dark-gray);
    }
    .cart-item-back .cancel-delete-btn:hover {
        background-color: #e0e0e0;
        transform: translateY(-1px);
    }

    @keyframes bounce-out-inner {
        0% {
            transform: rotateY(0deg) scale(1);
            opacity: 1;
        }
        20% {
            transform: rotateY(0deg) scale(0.9);
        }
        50% {
            transform: rotateY(0deg) scale(1.1);
            opacity: 1;
        }
        100% {
            transform: rotateY(0deg) scale(0.3);
            opacity: 0;
        }
    }
    .cart-item .cart-item-inner.is-removing {
        animation: bounce-out-inner 0.7s forwards ease-in-out;
        transition: none !important;
    }

    .cart-footer {
        padding: 25px;
        background-color: #f8f9fa;
        flex-shrink: 0;
        box-shadow: 0 -5px 12px -6px rgba(0, 0, 0, 0.12);
        border-top: 1px solid #e7e7e7;
        margin-top: 10px;
    }

    .cart-total {
        font-weight: 700;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding: 18px 20px;
        background-color: #ffffff;
        border-radius: var(--border-radius);
        border: 1px solid #dee2e6;
        box-shadow: 0 3px 10px rgba(0,0,0,0.07);
        transition: all 0.3s ease-in-out;
    }
    .cart-total:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .cart-total span {
        color: var(--secondary-color);
        font-weight: 500;
        font-size: 1.2rem;
        letter-spacing: 0.3px;
    }

    .cart-total strong {
        color: var(--primary-color);
        font-size: 2rem;
        font-weight: 700;
        letter-spacing: 0.5px;
        background: linear-gradient(45deg, var(--primary-color), #1ddca7);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        padding-right: 2px;
    }

    .empty-cart-button {
        display: block;
        width: 100%;
        background-color: var(--accent-color);
        color: white;
        padding: 10px;
        text-align: center;
        border: none;
        border-radius: 5px;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.2s ease;
        font-weight: 500;
        margin-bottom: 10px; /* Space before checkout button */
    }
    .empty-cart-button:hover {
        background-color: #c0392b;
        transform: translateY(-1px);
    }
    .empty-cart-button i {
        margin-right: 8px;
    }

    .checkout-btn {
        display: block; width: 100%; background-color: var(--primary-color);
        color: white; padding: 12px; text-align: center; border: none;
        border-radius: 5px; font-size: 1.1rem; cursor: pointer;
        transition: background-color 0.3s ease, transform 0.2s ease;
        font-weight: 600;
    }
    .checkout-btn:hover {
        background-color: #16a085;
        transform: translateY(-2px);
    }

    .shipping-cost-info-cart {
        text-align: center;
        font-size: 0.85rem;
        color: var(--dark-gray);
        padding: 8px 15px;
        background-color: #f0f8ff; /* AliceBlue, un azzurrino molto chiaro */
        border: 1px dashed #add8e6; /* LightBlue */
        border-radius: var(--border-radius);
        margin-top: -15px; /* Per avvicinarlo al totale */
        margin-bottom: 15px; /* Spazio prima dei pulsanti */
    }
    .shipping-cost-info-cart i {
        margin-right: 5px;
        color: var(--primary-color);
    }

    .empty-cart-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding: 30px 20px;
        margin: auto;
        max-width: 350px;
        opacity: 0;
        transform: translateY(20px);
        animation: fadeInEmptyMessage 0.5s 0.1s forwards cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    @keyframes fadeInEmptyMessage {
        to { opacity: 1; transform: translateY(0); }
    }
    .empty-cart-icon {
        font-size: 5.5rem;
        color: var(--primary-color);
        margin-bottom: 30px;
        animation: bobbingCart 2.5s infinite ease-in-out;
    }
    @keyframes bobbingCart {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }
    .empty-cart-container h3 {
        font-size: 1.6rem;
        color: var(--secondary-color);
        margin-bottom: 15px;
        margin-top:0;
    }
    .empty-cart-container p {
        font-size: 1rem;
        color: var(--dark-gray);
        margin-bottom: 30px;
        line-height: 1.5;
    }
    .explore-products-btn-cart {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 12px 25px;
        font-size: 1rem;
        font-weight: 600;
        border-radius: var(--border-radius);
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.2s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
    }
    .explore-products-btn-cart:hover {
        background-color: #16a085;
        transform: translateY(-2px);
    }
    .explore-products-btn-cart i {
        margin-right: 8px;
    }

    #wishlist-page {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: var(--light-gray);
        z-index: 1010;
        display: flex;
        flex-direction: column;
        visibility: hidden;
        opacity: 0;
        transform: scale(0.8);
        transition: opacity 0.3s ease, transform 0.3s ease, visibility 0s 0.3s;
    }
    #wishlist-page.active {
        visibility: visible;
        opacity: 1;
        transform: scale(1);
        transition: opacity 0.3s ease, transform 0.3s ease, visibility 0s 0s;
    }
    .wishlist-page-header {
        background-color: #fff;
        box-shadow: var(--box-shadow);
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }
    .wishlist-page-header h2 {
        margin: 0;
        color: var(--secondary-color);
        font-size: 1.6rem;
    }
    .wishlist-page-close-btn {
        background: none;
        border: none;
        font-size: 1.8rem;
        color: var(--secondary-color);
        cursor: pointer;
        padding: 5px;
    }
    .wishlist-page-close-btn:hover { color: var(--primary-color); }

    #wishlist-page-content {
        flex-grow: 1;
        overflow-y: auto;
        padding: 0 20px;
    }

    .empty-wishlist-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding: 20px;
        max-width: 500px;
        margin: 0 auto;
    }
    .empty-wishlist-icon {
        font-size: 5rem;
        color: var(--primary-color);
        margin-bottom: 25px;
        animation: pulseHeart 2s infinite ease-in-out;
    }
    @keyframes pulseHeart {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }
    .empty-wishlist-container h3 {
        font-size: 1.8rem;
        color: var(--secondary-color);
        margin-bottom: 15px;
    }
    .empty-wishlist-container p {
        font-size: 1.1rem;
        color: var(--dark-gray);
        margin-bottom: 30px;
        line-height: 1.5;
    }
    .explore-products-btn {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 12px 25px;
        font-size: 1rem;
        font-weight: 600;
        border-radius: var(--border-radius);
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.2s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
    }
    .explore-products-btn:hover {
        background-color: #16a085;
        transform: translateY(-2px);
    }
    .explore-products-btn i {
        margin-right: 8px;
    }
    .empty-message {
        text-align: center;
        color: var(--dark-gray);
        padding: 40px 20px;
        font-style: italic;
        font-size: 1.2rem;
    }

    .product-detail-layout { display: flex; gap: 25px; }
    .product-detail-image img {
        width: 100%; max-width: 250px; height: auto;
        border-radius: var(--border-radius); object-fit: cover;
    }
    .product-detail-info { flex: 1; }
    .product-detail-info h2 { margin-top: 0; color: var(--secondary-color); }
    .product-detail-info .price {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--primary-color);
        margin: 15px 0 20px;
        display: inline-block;
    }
    .product-detail-info p { margin-bottom: 15px; color: #555; }
    .product-detail-options label {
        display: block; margin-bottom: 8px; font-weight: 600; color: var(--secondary-color);
    }
    .product-detail-options select, .product-detail-options input[type="number"] {
        width: 100%; padding: 10px; margin-bottom: 15px;
        border: 1px solid #ccc; border-radius: 5px; font-size: 1rem;
    }
    .product-detail-options input[type="number"] { width: 80px; }
    .add-to-cart-btn {
        background-color: var(--primary-color); color: white; padding: 12px 25px;
        border: none; border-radius: 5px; cursor: pointer; font-size: 1.1rem;
        font-weight: 600; transition: background-color 0.3s ease; width: 100%;
    }
    .add-to-cart-btn:hover { background-color: #16a085; }
    .product-detail-tags { margin-top: 10px; }
    .product-detail-tags .tag-group { margin-bottom: 10px;}
    .product-detail-tags strong { font-weight: 600; color: var(--secondary-color); }
    .product-detail-tags span {
        background-color: var(--light-gray); padding: 3px 8px; border-radius: 4px;
        font-size: 0.9rem; margin-right: 5px; margin-bottom: 5px; display: inline-block;
    }

    #toast-container {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 2000;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--toast-gap);
        width: auto;
        pointer-events: none;
    }
    .custom-toast {
        display: flex;
        align-items: center;
        background-color: var(--secondary-color);
        color: var(--toast-text-color);
        padding: 12px 20px;
        border-radius: var(--border-radius);
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        min-width: 280px;
        max-width: 400px;
        opacity: 0;
        pointer-events: auto;
        overflow: hidden;
        position:relative;
        margin-bottom: 0;
        max-height: 150px;
        transition: max-height 0.3s ease, margin-bottom 0.3s ease, padding 0.3s ease;
    }
    .custom-toast.show {
        animation: slideInDownToast 0.4s cubic-bezier(0.23, 1, 0.32, 1) forwards;
    }
    .custom-toast.slide-out {
        animation: slideOutUpBounceAndCollapseToast 0.6s forwards;
    }
    .custom-toast-icon {
        font-size: 1.5rem;
        margin-right: 15px;
        flex-shrink: 0;
    }
    .custom-toast-message {
        flex-grow: 1;
        font-size: 0.95rem;
        line-height: 1.4;
    }
    .custom-toast-progress {
        position: absolute;
        bottom: 0;
        left: 0;
        height: 4px;
        width: 100%;
        background-color: rgba(255,255,255,0.3);
    }
    .custom-toast-progress-bar {
        height: 100%;
        width: 100%;
        background-color: var(--toast-text-color);
        animation-name: progressShrinkToast;
        animation-timing-function: linear;
        animation-fill-mode: forwards;
    }
    .custom-toast.success { background-color: var(--toast-success-bg); }
    .custom-toast.success .custom-toast-icon { color: var(--toast-success-icon); }
    .custom-toast.success .custom-toast-progress-bar { background-color: var(--toast-success-icon); }
    .custom-toast.error { background-color: var(--toast-error-bg); }
    .custom-toast.error .custom-toast-icon { color: var(--toast-error-icon); }
    .custom-toast.error .custom-toast-progress-bar { background-color: var(--toast-error-icon); }
    .custom-toast.info { background-color: var(--toast-info-bg); }
    .custom-toast.info .custom-toast-icon { color: var(--toast-info-icon); }
    .custom-toast.info .custom-toast-progress-bar { background-color: var(--toast-info-icon); }
    .custom-toast.warning { background-color: var(--toast-warning-bg); }
    .custom-toast.warning .custom-toast-icon { color: var(--toast-warning-icon); }
    .custom-toast.warning .custom-toast-progress-bar { background-color: var(--toast-warning-icon); }


    @keyframes slideInDownToast {
        from { transform: translateY(-150%); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    @keyframes slideOutUpBounceAndCollapseToast {
        0% {
            transform: translateY(0);
            opacity: 1;
            max-height: 150px;
            margin-bottom: var(--toast-gap);
            padding: 12px 20px;
        }
        20% {
            transform: translateY(10px);
            opacity: 1;
        }
        60% {
            transform: translateY(-20px);
            opacity: 1;
            max-height: 150px;
            margin-bottom: var(--toast-gap);
            padding: 12px 20px;
        }
        100% {
            transform: translateY(-150%);
            opacity: 0;
            max-height: 0;
            margin-bottom: 0;
            padding-top: 0;
            padding-bottom: 0;
        }
    }
    @keyframes progressShrinkToast {
        from { width: 100%; }
        to { width: 0%; }
    }

    #no-products-message {
        padding: 40px 20px;
        background-color: #fff;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        margin-top: 30px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        min-height: 300px;
    }
    #no-products-message .empty-page-icon {
        font-size: 4.5rem;
        color: var(--secondary-color);
        margin-bottom: 25px;
        animation: pulseBox 2.5s infinite ease-in-out;
    }
    @keyframes pulseBox {
        0% { transform: scale(1) rotate(0deg); }
        25% { transform: scale(1.05) rotate(-2deg); }
        75% { transform: scale(1.05) rotate(2deg); }
        100% { transform: scale(1) rotate(0deg); }
    }
    #no-products-message h3 {
        font-size: 1.7rem;
        color: var(--secondary-color);
        margin-bottom: 15px;
        margin-top: 0;
    }
    #no-products-message p {
        font-size: 1.1rem;
        color: var(--dark-gray);
        line-height: 1.5;
        max-width: 550px;
    }
    #no-products-message .btn-outline-primary {
        border: 1px solid var(--primary-color);
        color: var(--primary-color);
        background-color: transparent;
        padding: 10px 20px;
        border-radius: var(--border-radius);
        margin-top: 20px;
        cursor: pointer;
        font-weight: 600;
        transition: background-color 0.2s ease, color 0.2s ease;
    }
    #no-products-message .btn-outline-primary:hover {
        background-color: var(--primary-color);
        color: white;
    }


    .flying-product {
        position: fixed;
        z-index: 2005;
        object-fit: contain;
        transition: left 0.8s cubic-bezier(0.6, -0.28, 0.735, 0.045),
                    top 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275),
                    width 0.8s ease-in-out,
                    height 0.8s ease-in-out,
                    opacity 0.8s ease-in;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        border: 1px solid rgba(255,255,255,0.7);
        background-color: rgba(255,255,255,0.5);
        padding: 2px;
        pointer-events: none;
    }

    .nav-icons button.cart-icon-pop {
        animation: cartPopEffect 0.4s ease-out;
    }
    @keyframes cartPopEffect {
        0% { transform: scale(1); }
        50% { transform: scale(1.4); }
        100% { transform: scale(1); }
    }

    .nav-icons button.wishlist-icon-pop {
        animation: wishlistPopEffect 0.4s ease-out;
    }
    @keyframes wishlistPopEffect {
        0% { transform: scale(1); }
        50% { transform: scale(1.4) rotate(-10deg); }
        75% { transform: scale(1.4) rotate(10deg); }
        100% { transform: scale(1) rotate(0deg); }
    }

    /* Edit Cart Item Modal Specific Styles */
    #edit-cart-item-modal .modal-content {
        max-width: 550px;
    }

    .edit-cart-item-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--light-gray);
        padding-bottom: 15px;
    }
    .edit-cart-item-header img {
        width: 80px;
        height: 80px;
        object-fit: contain;
        border-radius: var(--border-radius);
        background-color: #f9f9f9;
    }
    .edit-cart-item-header h3 {
        margin: 0;
        font-size: 1.4rem;
        color: var(--secondary-color);
        font-weight: 600;
    }
    .edit-cart-item-options {
        display: grid;
        gap: 15px;
    }
    .edit-cart-item-options .option-group {
        display: flex;
        flex-direction: column;
    }
    .edit-cart-item-options label {
        font-weight: 600;
        color: var(--secondary-color);
        margin-bottom: 8px;
        font-size: 0.95rem;
    }
    .edit-cart-item-options select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 1rem;
        background-color: #fff;
    }
    .edit-cart-item-options select:disabled {
        background-color: var(--light-gray);
        cursor: not-allowed;
        opacity: 0.7;
    }
    .edit-cart-item-actions {
        margin-top: 25px;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
    .edit-cart-item-actions .btn {
        padding: 10px 20px;
        border-radius: 5px;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s ease, transform 0.2s ease;
        border: none;
    }
    .edit-cart-item-actions .save-edit-btn {
        background-color: var(--primary-color);
        color: white;
    }
    .edit-cart-item-actions .save-edit-btn:hover {
        background-color: #16a085;
        transform: translateY(-1px);
    }
    .edit-cart-item-actions .cancel-edit-btn {
        background-color: var(--light-gray);
        color: var(--text-color);
        border: 1px solid var(--dark-gray);
    }
    .edit-cart-item-actions .cancel-edit-btn:hover {
        background-color: #e0e0e0;
    }

    /* Bounce-in animation for general modal content, can be reused */
    @keyframes bounceInModal {
        0% {
            opacity: 0;
            transform: scale(0.7) translateY(-50px);
        }
        60% {
            opacity: 1;
            transform: scale(1.05) translateY(10px);
        }
        100% {
            transform: scale(1) translateY(0);
        }
    }

    .modal.active .edit-modal-content,
    .modal.active .auth-modal-content,
    .modal.active .user-data-modal-content,
    .modal.active .checkout-modal-content,
    .modal.active .orders-history-modal-content,
    .modal.active .order-detail-modal-content,
    .modal.active .confirm-cancel-order-modal-content,
    .modal.active .my-account-details-modal-content /* Added for new modal */ {
        animation: bounceInModal 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }

    /* Stili specifici per la modale di conferma annullamento ordine */
    #confirm-cancel-order-modal .modal-header h2 {
        display: flex;
        align-items: center;
        justify-content: center; /* Centra il titolo e l'icona */
        font-size: 1.3rem; /* Leggermente più piccolo per fare spazio all'icona */
    }
    #confirm-cancel-order-modal #confirm-cancel-order-message {
        font-size: 1.05rem;
        line-height: 1.6;
        color: var(--dark-gray); /* Un po' più scuro per leggibilità */
        padding: 0 10px; /* Un po' di padding laterale */
    }
    #confirm-cancel-order-modal .form-actions button i {
        margin-right: 8px;
    }
    #confirm-cancel-order-modal .form-actions button {
        transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
    }
    #confirm-cancel-order-modal .form-actions button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }

    /* Form Stili Generali (usati in varie modali) */
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--secondary-color); }
    .form-group input[type="text"], .form-group input[type="email"],
    .form-group input[type="password"], .form-group input[type="tel"],
    .form-group textarea, .form-group select {
        width: 100%;
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: var(--border-radius);
        font-size: 1rem;
        box-sizing: border-box;
        transition: border-color 0.2s ease;
    }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
        border-color: var(--primary-color);
        outline: none;
        box-shadow: 0 0 0 2px rgba(26, 188, 156, 0.2);
    }
    .form-actions { margin-top: 25px; display: flex; justify-content: flex-end; gap: 10px; }
    .btn-primary { background-color: var(--primary-color); color: white; border:none; padding: 12px 20px; border-radius: var(--border-radius); cursor:pointer; font-weight: 500; transition: background-color 0.2s ease;}
    .btn-primary:hover { background-color: #16a085; }
    .btn-primary:disabled,
    .btn-primary.disabled { /* Aggiunta classe .disabled per compatibilità se serve */
        background-color: #bdc3c7; /* Grigio chiaro */
        color: #7f8c8d; /* Grigio scuro per testo */
        cursor: not-allowed;
        box-shadow: none;
    }
    .btn-secondary { background-color: var(--light-gray); color: var(--text-color); border: 1px solid var(--dark-gray); padding: 12px 20px; border-radius: var(--border-radius); cursor:pointer; font-weight: 500; transition: background-color 0.2s ease;}
    .btn-secondary:hover { background-color: #e0e0e0; }
    .btn-danger { background-color: var(--accent-color); color: white; border: none; }
    .btn-danger:hover { background-color: #c0392b; }
    .btn-link { color: var(--primary-color); text-decoration: none; background: none; border: none; cursor: pointer; padding: 0; font-size: 0.9rem; }
    .btn-link:hover { text-decoration: underline; }
    .btn-warning { background-color: var(--toast-warning-bg); color: white; border:none; padding: 10px 15px; border-radius: var(--border-radius); cursor:pointer; font-weight: 500; transition: background-color 0.2s ease;}
    .btn-warning:hover { background-color: var(--toast-warning-icon); }
    .btn-warning i { margin-right: 5px; }

    /* Auth Modal */
    #account-modal .modal-content { max-width: 450px; }
    .auth-tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid var(--light-gray); }
    .auth-tabs .tab-btn { flex: 1; padding: 12px; background: none; border: none; font-size: 1rem; font-weight: 600; cursor: pointer; color: var(--dark-gray); border-bottom: 3px solid transparent; transition: color 0.2s, border-color 0.2s; }
    .auth-tabs .tab-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
    .auth-section { display: none; }
    .auth-section.active { display: block; }
    .user-dashboard { text-align: center; }
    .user-dashboard h3 { color: var(--secondary-color); margin-bottom: 10px; }
    .user-dashboard .user-greeting { font-size: 1.2rem; margin-bottom: 25px; color: var(--dark-gray); }
    .user-dashboard .dashboard-actions button { display: block; width: 100%; margin-bottom: 10px; padding: 12px; font-size: 1rem; }
    .user-dashboard .dashboard-actions button i { margin-right: 8px;}
    #delete-account-btn { background-color: var(--accent-color); color: white; }
    #delete-account-btn:hover { background-color: #c0392b; }

    /* User Data Modal */
    #user-data-modal .modal-content { max-width: 700px; }
    .address-list { list-style: none; padding: 0; margin-bottom: 20px;}
    .address-item {
        background-color: var(--light-gray); padding: 15px; border-radius: var(--border-radius);
        margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .address-item p { margin: 0; font-size: 0.95rem; flex-grow: 1;}
    .address-item-actions button { margin-left: 8px; background: none; border: none; cursor: pointer; font-size: 1.1rem; color: var(--dark-gray); }
    .address-item-actions button:hover { color: var(--primary-color); }
    .address-item-actions .delete-address-btn:hover { color: var(--accent-color); }
    .address-default-badge {
        background-color: var(--primary-color); color: white; font-size: 0.75rem;
        padding: 3px 8px; border-radius: 4px; font-weight: 600; margin-right: 10px;
    }

    /* Checkout Modal */
    #checkout-modal .modal-content { max-width: 800px; }
    .checkout-steps { display: flex; justify-content: space-around; margin-bottom: 25px; }
    .checkout-step-indicator {
        flex: 1; text-align: center; padding-bottom: 10px;
        border-bottom: 3px solid var(--light-gray); color: var(--dark-gray);
        font-weight: 500; transition: border-color 0.3s, color 0.3s;
    }
    .checkout-step-indicator.active { border-bottom-color: var(--primary-color); color: var(--primary-color); font-weight: 600;}
    .checkout-step-indicator.completed { border-bottom-color: var(--toast-success-bg); color: var(--toast-success-bg); }

    /* Nuovo stile per il contenitore degli step */
    #checkout-steps-container {
        position: relative;
        overflow: hidden;
        width: 100%;
        min-height: 350px; /* Altezza minima per evitare salti di contenuto */
    }

    /* Stile per gli step */
    .checkout-step {
        position: absolute;
        width: 100%;
        top: 0;
        left: 0;
        display: none;
        padding: 10px 0;
        opacity: 0;
        transition: transform 0.5s ease-in-out, opacity 0.3s ease-in-out;
    }

    /* Animazioni di entrata e uscita */
    .checkout-step.active {
        display: block;
        opacity: 1;
        position: relative;
        transform: translateX(0);
        z-index: 2;
    }

    .checkout-step.slide-out-left {
        display: block;
        opacity: 0;
        transform: translateX(-100%);
    }

    .checkout-step.slide-out-right {
        display: block;
        opacity: 0;
        transform: translateX(100%);
    }

    .checkout-step.slide-in-left {
        display: block;
        opacity: 1;
        transform: translateX(0);
        z-index: 2;
        animation: slideInLeft 0.5s forwards;
    }

    .checkout-step.slide-in-right {
        display: block;
        opacity: 1;
        transform: translateX(0);
        z-index: 2;
        animation: slideInRight 0.5s forwards;
    }

    @keyframes slideInLeft {
        from { transform: translateX(-100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    /* Modifico lo stile originale per rimuovere la transizione semplice */
    .checkout-step.active { animation: none; }
    @keyframes fadeInForm { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); }}

    #shipping-methods .form-group, #payment-methods .form-group { margin-bottom: 10px; }
    #shipping-methods label, #payment-methods label { display: block; padding: 12px; border: 1px solid #ccc; border-radius: var(--border-radius); cursor: pointer; transition: border-color 0.2s, background-color 0.2s; }
    #shipping-methods label:hover, #payment-methods label:hover { border-color: var(--primary-color); }
    #shipping-methods input[type="radio"]:checked + label, #payment-methods input[type="radio"]:checked + label { border-color: var(--primary-color); background-color: #e8f8f5; box-shadow: 0 0 0 2px rgba(26, 188, 156, 0.2); }
    #shipping-methods input[type="radio"], #payment-methods input[type="radio"] { display: none; }
    .shipping-cost, .payment-info { font-size: 0.9rem; color: var(--dark-gray); margin-left: 5px;}
    #credit-card-details { display: none; margin-top: 15px; padding-top: 15px; border-top: 1px dashed var(--light-gray); }
    .order-summary-section { margin-bottom: 15px; }
    .order-summary-section h4 { margin-bottom: 10px; color: var(--secondary-color); border-bottom: 1px solid var(--light-gray); padding-bottom: 5px;}
    .summary-item-list .summary-product { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem;}
    .summary-total-line { display: flex; justify-content: space-between; font-weight: 600; margin-top: 8px;}
    .summary-total-line.grand-total { font-size: 1.3rem; color: var(--primary-color); padding-top: 10px; border-top: 1px solid var(--dark-gray); }
    /* Stile per l'immagine nel riepilogo checkout */
    .summary-product-image {
        width: 40px; /* Larghezza desiderata */
        height: 40px; /* Altezza desiderata */
        object-fit: contain; /* o 'cover' a seconda dell'effetto desiderato */
        margin-right: 10px;
    }

    /* Orders History & Detail Modals */
    #orders-history-modal .modal-content, #order-detail-modal .modal-content { max-width: 900px; }
    #order-search-input { margin-bottom: 20px; }
    .orders-list { list-style: none; padding: 0; }
    .order-item {
        background-color: #fff; border: 1px solid var(--light-gray); padding: 15px;
        border-radius: var(--border-radius); margin-bottom: 15px;
        display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center;
        box-shadow: var(--box-shadow); transition: box-shadow 0.2s;
    }
    .order-item:hover { box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
    .order-info span { display: block; margin-bottom: 5px; font-size: 0.9rem; }
    .order-info strong { color: var(--secondary-color); }
    .order-status-label {
        padding: 5px 12px; border-radius: 15px; font-size: 0.85rem; font-weight: 600;
        color: var(--status-text-color); text-align: center; min-width: 100px;
    }
    .order-status-processing { background-color: var(--status-processing-bg); }
    .order-status-shipped { background-color: var(--status-shipped-bg); }
    .order-status-delivered { background-color: var(--status-delivered-bg); }
    .order-status-cancelled { background-color: var(--status-cancelled-bg); }
    .order-status-pending_payment { background-color: var(--status-pending-payment-bg); } /* New status */
    .order-item-actions button { margin-left: 10px; }
    #order-detail-sections { margin-top: 20px; }
    #order-detail-sections .detail-section { margin-bottom: 20px; padding: 15px; background: var(--light-gray); border-radius: var(--border-radius); }
    #order-detail-sections .detail-section h4 { margin-top:0; margin-bottom: 10px; color: var(--primary-color); border-bottom: 1px solid #ddd; padding-bottom: 5px;}
    #order-detail-items-list .product { display: flex; justify-content: space-between; border-bottom: 1px dotted #ccc; padding: 8px 0; }
    #order-detail-items-list .product:last-child { border-bottom: none; }
    #cancel-order-timer { font-weight: bold; color: var(--accent-color); margin-left: 10px;}

    /* Styles for cancellation and payment in order list */
    .order-item .order-actions-extra {
        width: 100%;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px dashed var(--light-gray);
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap; /* Allow wrapping on small screens */
    }
    .order-item .cancel-order-timer-list {
        font-size: 0.85rem;
        color: var(--accent-color);
        font-weight: 500;
        margin-left: 5px;
    }
    .order-item .order-actions-extra .btn-danger,
    .order-item .order-actions-extra .btn-warning { /* Style for Pay Now button */
        padding: 6px 12px; /* Slightly smaller button */
        font-size: 0.9rem;
    }
    .order-status-note { /* For "(Non Pagato)" text */
        font-size: 0.8rem;
        color: var(--status-pending-payment-bg);
        font-style: italic;
        margin-left: 5px;
    }


    @media (max-width: 768px) {
        :root {
            --side-modal-width: var(--side-modal-width-mobile);
            --side-navigation-width: 280px;
        }
        #hamburger-btn { display: inline-block; }
        .logo { font-size: 1.6rem; margin-left: 15px;}
        .nav-icons .user-account-controls .username-display { display: none; } /* Nascondi username su mobile */
        .nav-icons .user-account-controls button i { margin-right: 0; } /* Solo icona su mobile */

        #page-category-title { font-size: 1.6rem; }
        .submenu-item { font-size: 0.82rem; padding: 9px 18px 9px 33px; }


        .product-detail-layout { flex-direction: column; }
        .product-detail-image img { max-width: 100%; margin-bottom: 20px; }
        .modal-content, #edit-cart-item-modal .modal-content,
        #account-modal .modal-content, #user-data-modal .modal-content,
        #checkout-modal .modal-content, #orders-history-modal .modal-content,
        #order-detail-modal .modal-content {
             max-width: 90%;
             padding: 20px;
        }
        .wishlist-page-header h2 { font-size: 1.4rem; }
        .wishlist-page-close-btn { font-size: 1.6rem; }

        #toast-container { top: 10px; width: 90%; }
        .custom-toast { min-width: unset; width:100%; }

        .cart-footer { padding: 20px; }
        .cart-total {
            font-size: 1.1rem;
            padding: 15px;
        }
        .cart-total span { font-size: 1rem; }
        .cart-total strong { font-size: 1.6rem; }


        .empty-wishlist-icon { font-size: 4rem; }
        .empty-wishlist-container h3 { font-size: 1.5rem; }
        .empty-wishlist-container p { font-size: 1rem; }

        .empty-cart-icon { font-size: 4.5rem; margin-bottom: 20px;}
        .empty-cart-container h3 { font-size: 1.4rem;}
        .empty-cart-container p { font-size: 0.9rem;}


        #no-products-message .empty-page-icon { font-size: 4rem; }
        #no-products-message h3 { font-size: 1.5rem; }
        #no-products-message p { font-size: 1rem; }

        .edit-cart-item-header { flex-direction: column; text-align: center; }
        .edit-cart-item-header img { width: 100px; height: 100px; }
        .edit-cart-item-actions { justify-content: center; }

        .address-item { flex-direction: column; align-items: flex-start; }
        .address-item-actions { margin-top: 10px; margin-left:0; width:100%; display: flex; justify-content: space-between;}
        .checkout-steps { font-size: 0.8rem; }
        .order-item { flex-direction: column; align-items: flex-start;}
        .order-item > div { margin-bottom: 10px; width:100%;}
        .order-item-actions { width: 100%; display:flex; justify-content: flex-end;}
    }
    @media (max-width: 480px) {
        .order-item .order-actions-extra {
            flex-direction: column;
            align-items: flex-start;
        }
        .order-item .order-actions-extra .btn-danger,
        .order-item .order-actions-extra .btn-warning { margin-bottom: 5px; }
    }
    @media (max-width: 480px) {
        :root {
            --side-modal-width: 100%;
            --side-navigation-width: 85vw;
        }
        .logo { font-size: 1.4rem; margin-left: 10px; }
        .nav-icons button, .nav-icons .user-account-controls button { font-size: 1.3rem; margin-left: 10px; }
        #page-category-title { font-size: 1.4rem; }
        .main-category-toggle { font-size: 1rem; }
        .submenu-item { font-size: 0.8rem; padding: 8px 15px 8px 30px; }

        .wishlist-page-header h2 { font-size: 1.2rem; }

        .cart-total {
            padding: 12px;
            margin-bottom: 20px;
        }
        .cart-total strong { font-size: 1.4rem; }

        .empty-wishlist-icon { font-size: 3.5rem; }
        .empty-wishlist-container h3 { font-size: 1.3rem; }

        .empty-cart-icon { font-size: 4rem; }
        .empty-cart-container h3 { font-size: 1.2rem;}


        #no-products-message .empty-page-icon { font-size: 3.5rem; }
        #no-products-message h3 { font-size: 1.3rem; }

        .side-menu-header h3 { font-size: 1.3rem; }
        #close-side-menu-btn { font-size: 2rem; }
        .main-category-toggle { padding: 12px 15px; font-size: 1rem; }

        .edit-cart-item-header h3 { font-size: 1.2rem; }
        .edit-cart-item-actions .btn { width: 100%; margin-bottom: 5px; }
        .edit-cart-item-actions { flex-direction: column; }

        .form-actions { flex-direction: column; }
        .form-actions button { width: 100%; margin-bottom: 10px; }
        .user-dashboard .dashboard-actions button { font-size: 0.9rem; }
    }



/* ========================================================================== */
/* == ADEGUAMENTI SPECIFICI PER MODALE CHECKOUT - ANTI SCROLL == */
/* ========================================================================== */

/* Header della modale di checkout */
#checkout-modal .modal-header h2 {
    margin-bottom: 15px; /* Ridotto da 20px */
    font-size: 1.4rem;   /* Titolo modale leggermente più piccolo */
}

/* Contenuto generale della modale di checkout */
#checkout-modal .modal-content {
    padding: 20px; /* Standardizza padding, sovrascrive il 30px desktop della regola .modal-content generale */
}

/* Singolo step del checkout */
#checkout-modal .checkout-step {
    padding-top: 0px;    /* Ridotto per compattezza */
    padding-bottom: 0px; /* Ridotto per compattezza */
}

/* Titolo principale di ogni step del checkout (es. "Dati di Spedizione") */
#checkout-modal .checkout-step > h4 {
    margin-top: 0;
    margin-bottom: 10px; /* Ridotto per avvicinare il contenuto */
    font-size: 1.1rem;   /* Titolo step leggermente più piccolo */
}

/* Etichette dei campi form nel checkout */
#checkout-modal .form-group label {
    margin-bottom: 5px; /* Ridotto da 8px (regola generale .form-group label) */
    font-size: 0.9rem; /* Label leggermente più piccole */
}

/* Gruppi di form all'interno degli step del checkout */
#checkout-modal .checkout-step .form-group {
    margin-bottom: 8px; /* Ridotto da 20px (regola generale .form-group) e precedenti tentativi */
}

/* Titoli delle sezioni nel riepilogo ordine (Step 4, es. "Dati Cliente") */
#checkout-modal .checkout-step .order-summary-section h4 {
    margin-bottom: 6px;  /* Ridotto */
    padding-bottom: 3px; /* Ridotto */
    font-size: 1rem;     /* Titoli sezioni riepilogo leggermente più piccoli */
}

/* Lista degli articoli nel riepilogo ordine (Step 4) */
#checkout-modal .summary-item-list {
    max-height: 150px; /* Permette circa 4-5 items prima dello scroll interno di questa lista */
    overflow-y: auto;
    padding-right: 8px; /* Spazio per la scrollbar se appare */
    margin-bottom: 10px; /* Spazio prima dei totali */
}

/* Pulsanti Avanti/Indietro nel form di checkout */
#checkout-modal #checkout-form .form-actions {
    margin-top: 15px !important; /* Ridotto da 30px (impostato inline da JS), !important per sovrascrivere */
}

/* ========================================================================== */
/* == FINE ADEGUAMENTI CHECKOUT == */
/* ========================================================================== */

/* --- INIZIO CSS MODERNO PER MODALE AUTH --- */
.auth-modal-illustration {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 10px;
    animation: fadeInDown 0.7s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.auth-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    box-shadow: 0 4px 16px rgba(44, 62, 80, 0.15);
    border: 4px solid var(--primary-color);
    background: #fff;
    object-fit: cover;
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.auth-avatar:hover {
    transform: scale(1.08) rotate(-6deg);
}

.auth-tabs.modern-tabs {
    background: #f8fafd;
    border-radius: 30px;
    box-shadow: 0 2px 8px rgba(44,62,80,0.06);
    overflow: hidden;
    margin-bottom: 25px;
    position: relative;
    animation: fadeInUp 0.7s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.auth-tabs .tab-btn {
    position: relative;
    z-index: 1;
    font-size: 1.1rem;
    padding: 14px 0;
    border-radius: 0;
    background: none;
    border: none;
    color: var(--dark-gray);
    font-weight: 600;
    transition: color 0.2s, background 0.2s;
}
.auth-tabs .tab-btn.active {
    color: var(--primary-color);
    background: #e8f8f5;
    box-shadow: 0 2px 8px rgba(26,188,156,0.08);
}
.auth-section {
    display: none;
    animation: fadeInTab 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.auth-section.active {
    display: block;
}
@keyframes fadeInTab {
    from { opacity: 0; transform: translateY(30px) scale(0.98); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}
@keyframes fadeInDown {
    from { opacity: 0; transform: translateY(-40px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}
@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(40px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}

.form-group.with-icon label {
    margin-bottom: 6px;
}
.input-icon {
    display: flex;
    align-items: center;
    background: #f4f8fb;
    border-radius: 30px;
    padding: 0 16px;
    border: 1.5px solid #e0e0e0;
    transition: border-color 0.2s, box-shadow 0.2s;
}
.input-icon i {
    color: var(--primary-color);
    font-size: 1.1rem;
    margin-right: 10px;
    min-width: 22px;
    text-align: center;
}
.input-icon input {
    border: none;
    background: transparent;
    outline: none;
    font-size: 1.08rem;
    padding: 12px 0;
    width: 100%;
    color: var(--text-color);
    transition: background 0.2s;
}
.input-icon input:focus {
    background: #e8f8f5;
}
.input-icon:focus-within {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(26,188,156,0.10);
}

.big-btn {
    font-size: 1.15rem;
    padding: 14px 0;
    width: 100%;
    border-radius: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-top: 10px;
    box-shadow: 0 2px 8px rgba(44,62,80,0.08);
    transition: background 0.2s, transform 0.2s;
}
.big-btn i {
    font-size: 1.2em;
}
.big-btn:hover {
    background: #16a085;
    transform: translateY(-2px) scale(1.03);
}
.auth-switch-text {
    text-align: center;
    margin-top: 18px;
    color: var(--dark-gray);
    font-size: 1.01rem;
    animation: fadeInTab 0.7s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.auth-switch-text button {
    color: var(--primary-color);
    font-weight: 600;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.01rem;
    transition: color 0.2s;
}
.auth-switch-text button:hover {
    color: var(--accent-color);
    text-decoration: underline;
}
/* --- FINE CSS MODERNO PER MODALE AUTH --- */

.animated-icon {
    font-size: 70px; /* Dimensione ridotta */
    color: var(--primary-color);
    animation: pulse 1.5s infinite; /* Animazione di pulsazione */
}

@keyframes pulse {
    0% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.1);
    }
    100% {
        transform: scale(1);
    }
}
    </style>
</head>
<body>

    <header>
        <div class="container">
            <button id="hamburger-btn" aria-label="Apri menu">
                <i class="fas fa-bars"></i>
            </button>
            <a href="#" class="logo">E-Shop Kids</a>
            <div class="nav-icons">
                <div id="user-account-controls">
                    <!-- Controlli account verranno inseriti qui da JS -->
                </div>
                <button id="wishlist-btn-icon" aria-label="Lista Preferiti">
                    <i class="fas fa-heart"></i>
                    <span class="badge" id="wishlist-count">0</span>
                </button>
                <button id="cart-btn-icon" aria-label="Carrello">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="badge" id="cart-count">0</span>
                </button>
            </div>
        </div>
    </header>

    <nav id="side-navigation-menu">
        <div class="side-menu-header">
            <h3>Menu</h3>
            <button id="close-side-menu-btn" aria-label="Chiudi menu">×</button>
        </div>
        <div class="side-menu-content">
            <div class="menu-item">
                <button class="main-category-toggle" aria-expanded="false" aria-controls="submenu-club">
                    <span><i class="fas fa-shield-alt"></i> Maglie Club</span>
                    <i class="fas fa-chevron-down arrow-icon"></i>
                </button>
                <div class="submenu" id="submenu-club">
                    <a href="#" class="submenu-item" data-category="serie-a"><i class="fas fa-flag"></i> Serie A</a>
                    <a href="#" class="submenu-item" data-category="la-liga"><i class="fas fa-flag"></i> La Liga</a>
                    <a href="#" class="submenu-item" data-category="premier-league"><i class="fas fa-flag"></i> Premier League</a>
                    <a href="#" class="submenu-item" data-category="bundesliga"><i class="fas fa-flag"></i> Bundesliga</a>
                    <a href="#" class="submenu-item" data-category="ligue-1"><i class="fas fa-flag"></i> Ligue 1</a>
                </div>
            </div>
            <div class="menu-item">
                <button class="main-category-toggle" aria-expanded="false" aria-controls="submenu-nazionali">
                    <span><i class="fas fa-globe-europe"></i> Maglie Nazionali</span>
                    <i class="fas fa-chevron-down arrow-icon"></i>
                </button>
                <div class="submenu" id="submenu-nazionali">
                     <a href="#" class="submenu-item" data-category="albania"><i class="fas fa-flag"></i> Albania</a>
                    <a href="#" class="submenu-item" data-category="arabia-saudita"><i class="fas fa-flag"></i> Arabia Saudita</a>
                    <a href="#" class="submenu-item" data-category="argentina"><i class="fas fa-flag"></i> Argentina</a>
                    <a href="#" class="submenu-item" data-category="australia"><i class="fas fa-flag"></i> Australia</a>
                    <a href="#" class="submenu-item" data-category="austria"><i class="fas fa-flag"></i> Austria</a>
                    <a href="#" class="submenu-item" data-category="belgio"><i class="fas fa-flag"></i> Belgio</a>
                    <a href="#" class="submenu-item" data-category="brasile"><i class="fas fa-flag"></i> Brasile</a>
                    <a href="#" class="submenu-item" data-category="camerun"><i class="fas fa-flag"></i> Camerun</a>
                    <a href="#" class="submenu-item" data-category="canada"><i class="fas fa-flag"></i> Canada</a>
                    <a href="#" class="submenu-item" data-category="cechia"><i class="fas fa-flag"></i> Cechia (Rep. Ceca)</a>
                    <a href="#" class="submenu-item" data-category="cile"><i class="fas fa-flag"></i> Cile</a>
                    <a href="#" class="submenu-item" data-category="colombia"><i class="fas fa-flag"></i> Colombia</a>
                    <a href="#" class="submenu-item" data-category="corea-del-sud"><i class="fas fa-flag"></i> Corea del Sud</a>
                    <a href="#" class="submenu-item" data-category="costa-avorio"><i class="fas fa-flag"></i> Costa d'Avorio</a>
                    <a href="#" class="submenu-item" data-category="costa-rica"><i class="fas fa-flag"></i> Costa Rica</a>
                    <a href="#" class="submenu-item" data-category="croazia"><i class="fas fa-flag"></i> Croazia</a>
                    <a href="#" class="submenu-item" data-category="danimarca"><i class="fas fa-flag"></i> Danimarca</a>
                    <a href="#" class="submenu-item" data-category="ecuador"><i class="fas fa-flag"></i> Ecuador</a>
                    <a href="#" class="submenu-item" data-category="egitto"><i class="fas fa-flag"></i> Egitto</a>
                    <a href="#" class="submenu-item" data-category="finlandia"><i class="fas fa-flag"></i> Finlandia</a>
                    <a href="#" class="submenu-item" data-category="francia"><i class="fas fa-flag"></i> Francia</a>
                    <a href="#" class="submenu-item" data-category="gabon"><i class="fas fa-flag"></i> Gabon</a>
                    <a href="#" class="submenu-item" data-category="galles"><i class="fas fa-flag"></i> Galles</a>
                    <a href="#" class="submenu-item" data-category="georgia"><i class="fas fa-flag"></i> Georgia</a>
                    <a href="#" class="submenu-item" data-category="germania"><i class="fas fa-flag"></i> Germania</a>
                    <a href="#" class="submenu-item" data-category="ghana"><i class="fas fa-flag"></i> Ghana</a>
                    <a href="#" class="submenu-item" data-category="giamaica"><i class="fas fa-flag"></i> Giamaica</a>
                    <a href="#" class="submenu-item" data-category="giappone"><i class="fas fa-flag"></i> Giappone</a>
                    <a href="#" class="submenu-item" data-category="guinea"><i class="fas fa-flag"></i> Guinea</a>
                    <a href="#" class="submenu-item" data-category="honduras"><i class="fas fa-flag"></i> Honduras</a>
                    <a href="#" class="submenu-item" data-category="inghilterra"><i class="fas fa-flag"></i> Inghilterra</a>
                    <a href="#" class="submenu-item" data-category="irlanda"><i class="fas fa-flag"></i> Irlanda</a>
                    <a href="#" class="submenu-item" data-category="irlanda-del-nord"><i class="fas fa-flag"></i> Irlanda del Nord</a>
                    <a href="#" class="submenu-item" data-category="islanda"><i class="fas fa-flag"></i> Islanda</a>
                    <a href="#" class="submenu-item" data-category="israele"><i class="fas fa-flag"></i> Israele</a>
                    <a href="#" class="submenu-item" data-category="italia"><i class="fas fa-flag"></i> Italia</a>
                    <a href="#" class="submenu-item" data-category="mali"><i class="fas fa-flag"></i> Mali</a>
                    <a href="#" class="submenu-item" data-category="marocco"><i class="fas fa-flag"></i> Marocco</a>
                    <a href="#" class="submenu-item" data-category="messico"><i class="fas fa-flag"></i> Messico</a>
                    <a href="#" class="submenu-item" data-category="monaco"><i class="fas fa-flag"></i> Monaco</a>
                    <a href="#" class="submenu-item" data-category="nigeria"><i class="fas fa-flag"></i> Nigeria</a>
                    <a href="#" class="submenu-item" data-category="norvegia"><i class="fas fa-flag"></i> Norvegia</a>
                    <a href="#" class="submenu-item" data-category="paesi-bassi"><i class="fas fa-flag"></i> Paesi Bassi</a>
                    <a href="#" class="submenu-item" data-category="panama"><i class="fas fa-flag"></i> Panama</a>
                    <a href="#" class="submenu-item" data-category="paraguay"><i class="fas fa-flag"></i> Paraguay</a>
                    <a href="#" class="submenu-item" data-category="peru"><i class="fas fa-flag"></i> Perù</a>
                    <a href="#" class="submenu-item" data-category="polonia"><i class="fas fa-flag"></i> Polonia</a>
                    <a href="#" class="submenu-item" data-category="portogallo"><i class="fas fa-flag"></i> Portogallo</a>
                    <a href="#" class="submenu-item" data-category="qatar"><i class="fas fa-flag"></i> Qatar</a>
                    <a href="#" class="submenu-item" data-category="romania"><i class="fas fa-flag"></i> Romania</a>
                    <a href="#" class="submenu-item" data-category="russia"><i class="fas fa-flag"></i> Russia</a>
                    <a href="#" class="submenu-item" data-category="scozia"><i class="fas fa-flag"></i> Scozia</a>
                    <a href="#" class="submenu-item" data-category="senegal"><i class="fas fa-flag"></i> Senegal</a>
                    <a href="#" class="submenu-item" data-category="serbia"><i class="fas fa-flag"></i> Serbia</a>
                    <a href="#" class="submenu-item" data-category="slovacchia"><i class="fas fa-flag"></i> Slovacchia</a>
                    <a href="#" class="submenu-item" data-category="slovenia"><i class="fas fa-flag"></i> Slovenia</a>
                    <a href="#" class="submenu-item" data-category="spagna"><i class="fas fa-flag"></i> Spagna</a>
                    <a href="#" class="submenu-item" data-category="sud-africa"><i class="fas fa-flag"></i> Sud Africa</a>
                    <a href="#" class="submenu-item" data-category="svezia"><i class="fas fa-flag"></i> Svezia</a>
                    <a href="#" class="submenu-item" data-category="svizzera"><i class="fas fa-flag"></i> Svizzera</a>
                    <a href="#" class="submenu-item" data-category="tunisia"><i class="fas fa-flag"></i> Tunisia</a>
                    <a href="#" class="submenu-item" data-category="turchia"><i class="fas fa-flag"></i> Turchia</a>
                    <a href="#" class="submenu-item" data-category="ucraina"><i class="fas fa-flag"></i> Ucraina</a>
                    <a href="#" class="submenu-item" data-category="ungheria"><i class="fas fa-flag"></i> Ungheria</a>
                    <a href="#" class="submenu-item" data-category="uruguay"><i class="fas fa-flag"></i> Uruguay</a>
                    <a href="#" class="submenu-item" data-category="usa"><i class="fas fa-flag"></i> USA</a>
                    <a href="#" class="submenu-item" data-category="venezuela"><i class="fas fa-flag"></i> Venezuela</a>
                </div>
            </div>
        </div>
    </nav>
    <div id="side-menu-overlay"></div>


    <main class="container">
        <h2 id="page-category-title">Prodotti in Evidenza</h2>
        <div id="product-grid" class="product-grid">
            <!-- Products will be loaded here by JavaScript -->
        </div>
        <div id="no-products-message" style="display: none;">
            <!-- Message if no products are found -->
        </div>
    </main>

    <!-- Product Detail Modal -->
    <div id="product-detail-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" data-modal-id="product-detail-modal">×</span>
            <div id="product-detail-content"></div>
        </div>
    </div>

    <!-- Cart Modal -->
    <div id="cart-modal" class="modal">
        <div class="side-modal-content">
            <span class="modal-close" data-modal-id="cart-modal">×</span>
            <h2>Carrello</h2>
            <div id="cart-items-container"></div>
            <div class="cart-footer">
                <div id="cart-total" class="cart-total">
                    <span>Totale:</span>
                    <strong>€0.00</strong>
                </div>
                <div id="shipping-cost-info-cart" class="shipping-cost-info-cart" style="display:none;">
                    <i class="fas fa-info-circle"></i> Il costo della spedizione sarà calcolato al checkout.
                </div>
                <button id="empty-cart-btn" class="empty-cart-button" style="display:none;"><i class="fas fa-trash-alt"></i> Svuota Carrello</button>
                <button id="checkout-btn-from-cart" class="checkout-btn" style="display:none;">Procedi al Pagamento</button>
            </div>
        </div>
    </div>

    <!-- Wishlist Page -->
    <div id="wishlist-page">
        <div class="wishlist-page-header">
            <h2>I Tuoi Preferiti</h2>
            <button id="wishlist-page-close-btn" class="wishlist-page-close-btn" aria-label="Chiudi preferiti">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="wishlist-page-content">
            <div id="wishlist-page-grid" class="product-grid"></div>
        </div>
    </div>

    <!-- Edit Cart Item Modal -->
    <div id="edit-cart-item-modal" class="modal">
        <div class="modal-content edit-modal-content">
            <span class="modal-close" data-modal-id="edit-cart-item-modal">×</span>
            <div id="edit-cart-item-content"></div>
        </div>
    </div>

    <!-- Account Modal (Login/Register/Dashboard) -->
    <div id="account-modal" class="modal">
        <div class="modal-content auth-modal-content">
            <span class="modal-close" data-modal-id="account-modal">×</span>
            <div id="account-modal-content">
                <!-- Auth content will be loaded here by JS -->
            </div>
        </div>
    </div>

    <!-- User Data Modal -->
    <div id="user-data-modal" class="modal">
        <div class="modal-content user-data-modal-content">
            <span class="modal-close" data-modal-id="user-data-modal">×</span>
            <div class="modal-header"><h2>I Miei Dati</h2></div>
            <div id="user-data-modal-content">
                <!-- User personal data and addresses form/list will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div id="checkout-modal" class="modal">
        <div class="modal-content checkout-modal-content">
            <span class="modal-close" data-modal-id="checkout-modal">×</span>
            <div class="modal-header"><h2>Checkout</h2></div>
            <div id="checkout-modal-content">
                <!-- Checkout steps will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Orders History Modal -->
    <div id="orders-history-modal" class="modal">
        <div class="modal-content orders-history-modal-content">
            <span class="modal-close" data-modal-id="orders-history-modal">×</span>
             <div class="modal-header"><h2>I Miei Ordini</h2></div>
            <div id="orders-history-modal-content">
                 <!-- Orders list will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Order Detail Modal -->
    <div id="order-detail-modal" class="modal">
        <div class="modal-content order-detail-modal-content">
            <span class="modal-close" data-modal-id="order-detail-modal">×</span>
            <div class="modal-header"><h2>Dettaglio Ordine</h2></div>
            <div id="order-detail-modal-content">
                <!-- Specific order details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Confirm Cancel Order Modal -->
    <div id="confirm-cancel-order-modal" class="modal">
        <div class="modal-content confirm-cancel-order-modal-content" style="max-width: 450px;">
            <span class="modal-close" data-modal-id="confirm-cancel-order-modal">×</span>
            <div class="modal-header">
                <h2 id="confirm-cancel-order-title">
                    <i class="fas fa-exclamation-triangle" style="color: var(--toast-warning-bg); margin-right: 10px;"></i>Conferma Annullamento
                </h2>
            </div>
            <p id="confirm-cancel-order-message" style="margin-bottom: 25px; text-align: center; font-size: 1.05rem; line-height: 1.6;"></p>
            <div class="form-actions" style="justify-content: center;">
                <button id="confirm-cancel-order-btn" class="btn-danger"><i class="fas fa-check-circle"></i> Conferma Annullamento</button>
                <button id="cancel-cancel-order-btn" class="btn-secondary"><i class="fas fa-times-circle"></i> Annulla</button>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <!-- My Account Details Modal (NEW) -->
    <div id="my-account-details-modal" class="modal">
        <div class="modal-content my-account-details-modal-content"> <!-- Aggiunta classe per animazione -->
            <span class="modal-close" data-modal-id="my-account-details-modal">×</span>
            <div class="modal-header"><h2>Gestisci Account</h2></div>
            <div id="my-account-details-modal-content">
                <!-- Content will be loaded here by JS -->
            </div>
        </div>
    </div>

    <!-- Address Form Modal (NEW) -->
    <div id="address-form-modal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <span class="modal-close" data-modal-id="address-form-modal">×</span>
            <div class="modal-header">
                <h2 id="address-modal-title">Gestisci Indirizzo</h2>
            </div>
            <div id="address-form-modal-content-body">
                <form id="modal-address-form">
                    <input type="hidden" id="modal-address-id" value="">
                    <div class="form-group">
                        <label for="modal-address-street"><i class="fas fa-fw fa-map-marker-alt"></i> Via e Numero Civico</label>
                        <input type="text" id="modal-address-street" required>
                    </div>
                    <div class="form-group">
                        <label for="modal-address-city"><i class="fas fa-fw fa-city"></i> Città</label>
                        <input type="text" id="modal-address-city" required>
                    </div>
                    <div class="form-group">
                        <label for="modal-address-zip"><i class="fas fa-fw fa-mail-bulk"></i> CAP</label>
                        <input type="text" id="modal-address-zip" required pattern="[0-9]{5}">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn-primary" id="modal-save-address-btn">Salva Indirizzo</button>
                        <button type="button" class="btn-secondary" id="modal-cancel-address-btn">Annulla</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- JavaScript will be linked or embedded here -->
    <script>
  document.addEventListener('DOMContentLoaded', () => {
    const productGrid = document.getElementById('product-grid');
    const noProductsMessage = document.getElementById('no-products-message');
    const pageCategoryTitle = document.getElementById('page-category-title');

    const productDetailModal = document.getElementById('product-detail-modal');
    const productDetailContent = document.getElementById('product-detail-content');

    const cartModal = document.getElementById('cart-modal');
    const cartBtnIcon = document.getElementById('cart-btn-icon');
    const cartItemsContainer = document.getElementById('cart-items-container');
    const cartTotalEl = document.getElementById('cart-total');
    const cartCountBadge = document.getElementById('cart-count');
    const checkoutBtnFromCart = document.getElementById('checkout-btn-from-cart');
    const emptyCartBtn = document.getElementById('empty-cart-btn');

    const wishlistPage = document.getElementById('wishlist-page');
    const wishlistBtnIcon = document.getElementById('wishlist-btn-icon');
    const wishlistPageGrid = document.getElementById('wishlist-page-grid');
    const wishlistPageCloseBtn = document.getElementById('wishlist-page-close-btn');
    const wishlistCountBadge = document.getElementById('wishlist-count');

    const toastContainer = document.getElementById('toast-container');

    const hamburgerBtn = document.getElementById('hamburger-btn');
    const sideNavigationMenu = document.getElementById('side-navigation-menu');
    const closeSideMenuBtn = document.getElementById('close-side-menu-btn');
    const sideMenuOverlay = document.getElementById('side-menu-overlay');
    const sideMenuContent = document.querySelector('#side-navigation-menu .side-menu-content');
    const logoLink = document.querySelector('.logo');

    const editCartItemModal = document.getElementById('edit-cart-item-modal');
    const editCartItemContent = document.getElementById('edit-cart-item-content');

    const userAccountControlsContainer = document.getElementById('user-account-controls');
    const accountModal = document.getElementById('account-modal');
    const accountModalContent = document.getElementById('account-modal-content');

    const userDataModal = document.getElementById('user-data-modal');
    const userDataModalContent = document.getElementById('user-data-modal-content');

    const myAccountDetailsModal = document.getElementById('my-account-details-modal');
    const myAccountDetailsModalContent = document.getElementById('my-account-details-modal-content');

    const checkoutModal = document.getElementById('checkout-modal');
    const checkoutModalContent = document.getElementById('checkout-modal-content');

    const ordersHistoryModal = document.getElementById('orders-history-modal');
    const ordersHistoryModalContent = document.getElementById('orders-history-modal-content');

    const orderDetailModal = document.getElementById('order-detail-modal');
    const orderDetailModalContent = document.getElementById('order-detail-modal-content');

    const confirmCancelOrderModal = document.getElementById('confirm-cancel-order-modal');
    const confirmCancelOrderTitle = document.getElementById('confirm-cancel-order-title');
    const confirmCancelOrderMessage = document.getElementById('confirm-cancel-order-message');
    const confirmCancelOrderBtn = document.getElementById('confirm-cancel-order-btn');
    const cancelCancelOrderBtn = document.getElementById('cancel-cancel-order-btn');

    const addressFormModal = document.getElementById('address-form-modal');
    const addressModalTitle = document.getElementById('address-modal-title');
    const modalAddressForm = document.getElementById('modal-address-form');
    let originalAddressDataForModal = null;

    const PRODUCTS_API_URL = 'products_api.php';
    const AUTH_API_URL = 'auth_api.php';
    const USER_DATA_API_URL = 'user_data_api.php';
    const ORDERS_API_URL = 'orders_api.php';

    let allProducts = [];
    let cart = [];
    let wishlistProductIds = [];
    let currentCategoryFilter = 'all';
    let currentUserSession = null;
    let currentEditingCartItemId = null;
    let listOrderTimers = {};
    let userOrdersCache = [];

    const LS_CART_KEY = 'shoppingCart';
    const LS_CURRENT_USER_SESSION_KEY = 'eshopCurrentUserSession';
    // const LS_GUEST_WISHLIST_KEY = 'eshopGuestWishlist'; // RIMOSSO - Non più usato
    const LS_LEGACY_USER_ID_KEY = 'eshopUserId'; // Questo potrebbe rimanere se usato per ospiti e carrello

    const WISHLIST_REMOVAL_ANIMATION_DURATION = 500;
    const SHAKE_ANIMATION_DURATION = 400;
    const ORDER_CANCELLATION_WINDOW_MS = 5 * 60 * 1000; // 5 minutes

    let currentUserPersonalData = {
        username: '', loginEmail: '',
        contactFullName: '', contactEmail: '', contactPhone: ''
    };
    let originalPersonalData = null;
    let originalMyAccountDetails = null;
    let currentUserAddresses = [];

    function generateGUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    function generateNumericOrderIdFrontend() {
        return Math.floor(Math.random() * 9999) + 1;
    }

    // Funzione per verificare se l'utente è loggato (non un ospite)
    function isUserLoggedIn() {
        return currentUserSession && currentUserSession.userId && !String(currentUserSession.userId).startsWith('guest_');
    }

    function getEffectiveUserId() { // Usato principalmente per il carrello ospite, se mantenuto
        if (currentUserSession && currentUserSession.userId) {
            return String(currentUserSession.userId);
        }
        let guestId = localStorage.getItem(LS_LEGACY_USER_ID_KEY);
        if (!guestId) {
            guestId = `guest_${generateGUID()}`;
            localStorage.setItem(LS_LEGACY_USER_ID_KEY, guestId);
        }
        return guestId;
    }


    function setBodyScrollLock(lock) {
        const body = document.body;
        if (lock) {
            body.classList.add('body-scroll-locked');
        } else {
            const activeModals = document.querySelectorAll('.modal.active, #side-navigation-menu.open, #wishlist-page.active');
            if (activeModals.length === 0) {
                 body.classList.remove('body-scroll-locked');
            }
        }
    }

    function showFeedback(message, type = 'info', duration = 3000) {
        const toast = document.createElement('div');
        toast.className = `custom-toast ${type}`;

        let iconClass = 'fas fa-fw fa-info-circle';
        if (type === 'success') iconClass = 'fas fa-fw fa-check-circle';
        else if (type === 'error') iconClass = 'fas fa-fw fa-times-circle';
        else if (type === 'warning') iconClass = 'fas fa-fw fa-exclamation-triangle';

        toast.innerHTML = `
            <div class="custom-toast-icon"><i class="${iconClass}"></i></div>
            <div class="custom-toast-message">${message}</div>
            <div class="custom-toast-progress">
                <div class="custom-toast-progress-bar" style="animation-duration: ${duration}ms;"></div>
            </div>
        `;
        toastContainer.appendChild(toast);

        toast.classList.add('show');

        setTimeout(() => {
            toast.classList.remove('show');
            toast.classList.add('slide-out');

            toast.addEventListener('animationend', function handleOutAnimation(event) {
                if (event.animationName === 'slideOutUpBounceAndCollapseToast') {
                    if (toast.parentNode) {
                       toast.remove();
                    }
                }
            }, { once: true });
        }, duration);
    }

    function formatPrice(price) {
        return `€${parseFloat(price).toFixed(2)}`;
    }

    function toggleModal(modalId, show) {
        const modal = document.getElementById(modalId);
        if (!modal) {
            console.error(`[toggleModal] Modal con ID '${modalId}' non trovata.`);
            return;
        }

        const previouslyActiveModal = document.querySelector('.modal.active');

        if (show) {
            const isSubModal = (modalId === 'address-form-modal' && previouslyActiveModal?.id === 'user-data-modal') ||
                               (modalId === 'confirm-cancel-order-modal' && (previouslyActiveModal?.id === 'orders-history-modal' || previouslyActiveModal?.id === 'order-detail-modal')) ||
                               (modalId === 'my-account-details-modal' && previouslyActiveModal?.id === 'account-modal');


            if (previouslyActiveModal && previouslyActiveModal !== modal && !isSubModal) {
                previouslyActiveModal.classList.remove('active');
            }
            modal.classList.add('active');
            setBodyScrollLock(true);
        } else {
            modal.classList.remove('active');

            const anyOtherModalOpen = document.querySelector('.modal.active') ||
                                    sideNavigationMenu.classList.contains('open') ||
                                    wishlistPage.classList.contains('active');

            if (!anyOtherModalOpen) {
                setTimeout(() => setBodyScrollLock(false), modal.classList.contains('side-modal-content') ? 500 : 400);
            }
        }
    }

    async function toggleWishlistPage(show) {
        if (show) {
            if (!isUserLoggedIn()) { // Controllo aggiunto qui
                showFeedback("Devi essere registrato e loggato per visualizzare la tua lista dei preferiti.", "info");
                openAccountModal('login');
                return;
            }
            await renderWishlistPageGrid();
            wishlistPage.classList.add('active');
            setBodyScrollLock(true);
        } else {
            wishlistPage.classList.remove('active');
            const anyOtherModalOpen = document.querySelector('.modal.active') ||
                                    sideNavigationMenu.classList.contains('open');
            if (!anyOtherModalOpen) {
                setTimeout(() => setBodyScrollLock(false), 300);
            }
        }
    }

    function toggleSideMenu(show) {
        if (show) {
            sideNavigationMenu.classList.add('open');
            sideMenuOverlay.classList.add('active');
            setBodyScrollLock(true);
        } else {
            sideNavigationMenu.classList.remove('open');
            sideMenuOverlay.classList.remove('active');

            sideNavigationMenu.querySelectorAll('.submenu.open').forEach(submenu => {
                submenu.classList.remove('open');
                submenu.style.maxHeight = null;
                const toggleButton = submenu.previousElementSibling;
                if (toggleButton && toggleButton.classList.contains('main-category-toggle') && !toggleButton.classList.contains('single-link')) {
                    toggleButton.setAttribute('aria-expanded', 'false');
                }
            });
            const anyOtherModalOpen = document.querySelector('.modal.active') || wishlistPage.classList.contains('active');
            if(!anyOtherModalOpen) {
                 setTimeout(() => setBodyScrollLock(false), 400);
            }
        }
    }

    if (hamburgerBtn) hamburgerBtn.addEventListener('click', () => toggleSideMenu(true));
    if (closeSideMenuBtn) closeSideMenuBtn.addEventListener('click', () => toggleSideMenu(false));
    if (sideMenuOverlay) sideMenuOverlay.addEventListener('click', () => toggleSideMenu(false));
    if (logoLink) logoLink.addEventListener('click', (e) => { e.preventDefault(); filterProductsByCategory('all'); });

    if (sideMenuContent) {
        sideMenuContent.addEventListener('click', function(e) {
            const toggleButton = e.target.closest('.main-category-toggle');
            const submenuItem = e.target.closest('.submenu-item');
            if (toggleButton && !toggleButton.classList.contains('single-link')) {
                e.preventDefault();
                const submenu = toggleButton.nextElementSibling;
                if (!submenu || !submenu.classList.contains('submenu')) return;
                const isExpanded = toggleButton.getAttribute('aria-expanded') === 'true';
                if (isExpanded) {
                    submenu.classList.remove('open'); submenu.style.maxHeight = null; toggleButton.setAttribute('aria-expanded', 'false');
                } else {
                    this.querySelectorAll('.submenu.open').forEach(otherSubmenu => {
                        if (otherSubmenu !== submenu) {
                            otherSubmenu.classList.remove('open'); otherSubmenu.style.maxHeight = null;
                            const otherToggleButton = otherSubmenu.previousElementSibling;
                            if (otherToggleButton) otherToggleButton.setAttribute('aria-expanded', 'false');
                        }
                    });
                    submenu.classList.add('open'); submenu.style.maxHeight = submenu.scrollHeight + "px"; toggleButton.setAttribute('aria-expanded', 'true');
                }
            } else if (submenuItem || (toggleButton && toggleButton.classList.contains('single-link'))) {
                e.preventDefault();
                const category = submenuItem ? submenuItem.dataset.category : toggleButton.dataset.category;
                filterProductsByCategory(category);
            }
        });
    }
    document.querySelectorAll('.modal-close').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const modalId = btn.dataset.modalId;
            const wasCartOpen = modalId === 'edit-cart-item-modal' && editCartItemModal.dataset.cartModalWasOpen === 'true';

            if (modalId === 'edit-cart-item-modal') currentEditingCartItemId = null;
            if (modalId === 'checkout-modal') currentCheckoutStep = 1;

            if (modalId === 'orders-history-modal') {
                clearAllOrderListTimers();
            }
            if (modalId === 'order-detail-modal') {
                const currentDisplayingOrderId = orderDetailModal.dataset.currentOrderId;
                if (currentDisplayingOrderId) {
                    clearOrderDetailTimer(currentDisplayingOrderId);
                }
                const isConfirmCancelOpen = confirmCancelOrderModal.classList.contains('active');
                if (!isConfirmCancelOpen && !myAccountDetailsModal.classList.contains('active')) {
                    const ordersHistoryModalIsOpen = ordersHistoryModal.classList.contains('active');
                    const accountModalIsOpen = accountModal.classList.contains('active');
                }
            }

            if (modalId === 'my-account-details-modal' && !accountModal.classList.contains('active')) {
                // Decide if account-modal should be reopened
            }

            toggleModal(modalId, false);

            if (wasCartOpen) {
                setTimeout(() => toggleModal('cart-modal', true), 100);
            }
        });
    });

    async function fetchProductsFromAPI() {
        try {
            const response = await fetch(PRODUCTS_API_URL);
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: response.statusText }));
                throw new Error(`Errore HTTP ${response.status} nel caricamento prodotti: ${errorData.message}`);
            }
            const productsFromAPI = await response.json();
            allProducts = Array.isArray(productsFromAPI) ? productsFromAPI : [];
        } catch (error) {
            console.error('Errore nel fetch dei prodotti dall\'API:', error);
            showFeedback(`Impossibile caricare i prodotti (${error.message}).`, 'error', 6000);
            allProducts = [];
        }
    }

    function filterProductsByCategory(categorySlug) {
        currentCategoryFilter = categorySlug;
        let productsToDisplay;
        let titleText = "Prodotti in Evidenza";
        sideMenuContent.querySelectorAll('.submenu-item.active, .main-category-toggle.single-link.active').forEach(item => item.classList.remove('active'));

        if (categorySlug === 'all' || categorySlug === null) {
            productsToDisplay = allProducts;
        } else {
            productsToDisplay = allProducts.filter(product => product.category === categorySlug);
            const categoryLink = sideMenuContent.querySelector(`.submenu-item[data-category="${categorySlug}"], .main-category-toggle.single-link[data-category="${categorySlug}"]`);
            if (categoryLink) {
                titleText = categoryLink.querySelector('span') ? categoryLink.querySelector('span').textContent.trim() : categoryLink.textContent.trim();
                categoryLink.classList.add('active');
            } else {
                 titleText = `Categoria: ${categorySlug.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}`;
            }
        }
        pageCategoryTitle.textContent = titleText;
        renderProductGrid(productsToDisplay);
        toggleSideMenu(false);
        document.querySelectorAll('.modal.active').forEach(m => {
            if (m.id !== 'cart-modal' || (m.id === 'cart-modal' && !cartModal.classList.contains('was-already-open'))) {
                toggleModal(m.id, false);
            }
        });
        if (wishlistPage.classList.contains('active')) {
             toggleWishlistPage(false); // Chiude anche la wishlist se era aperta durante il filtro
        }
    }

    function loadCartFromStorage() {
        const storedCart = localStorage.getItem(LS_CART_KEY);
        cart = storedCart ? JSON.parse(storedCart) : [];
        updateCartDisplay();
    }

    function saveCartToStorage() {
        localStorage.setItem(LS_CART_KEY, JSON.stringify(cart));
        updateCartDisplay();
    }

    async function loadWishlistFromDB() {
        if (!isUserLoggedIn()) { // Modificato: se non loggato, wishlist vuota
            wishlistProductIds = [];
            updateWishlistVisuals();
            return;
        }

        // Se loggato, carica dal DB
        const userId = currentUserSession.userId;
        try {
            const response = await fetch(`${PRODUCTS_API_URL}?action=wishlist&user_id=${userId}`);
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: response.statusText }));
                if (response.status === 401 || response.status === 404) { // Utente non trovato o non autorizzato
                     console.warn(`Wishlist non caricata per utente ${userId}: ${errorData.message}`);
                     wishlistProductIds = []; // Resetta per sicurezza
                } else {
                    throw new Error(`Errore HTTP ${response.status} nel caricamento wishlist: ${errorData.message}`);
                }
            } else {
                const wishlistData = await response.json();
                wishlistProductIds = Array.isArray(wishlistData) ? wishlistData.map(p => String(p.id)) : [];
            }
        } catch (error) {
            console.error('Errore caricamento wishlist da DB:', error);
            showFeedback(`Impossibile caricare i preferiti: ${error.message}`, 'error', 4000);
            wishlistProductIds = []; // Reset on error
        }
        updateWishlistVisuals();
    }

    // RIMOSSA la funzione syncGuestWishlistToDB e LS_GUEST_WISHLIST_KEY

    function updateWishlistVisuals() {
        updateWishlistIconBadge();
        updateWishlistButtonsOnMainGrid();
    }

    function renderProductGrid(productsToDisplay) {
        productGrid.innerHTML = '';
        if (!productsToDisplay || productsToDisplay.length === 0) {
            noProductsMessage.style.display = 'flex';
            productGrid.style.display = 'none';
            if (currentCategoryFilter !== 'all' && currentCategoryFilter !== null) {
                noProductsMessage.innerHTML = `
                    <i class="fas fa-search empty-page-icon"></i><h3>Nessun prodotto trovato!</h3>
                    <p>Spiacenti, al momento non ci sono prodotti per la categoria '${pageCategoryTitle.textContent}'.</p>
                    <button class="btn-outline-primary" id="show-all-products-btn-msg">Mostra tutti i prodotti</button>`;
                const showAllBtn = noProductsMessage.querySelector('#show-all-products-btn-msg');
                if(showAllBtn) showAllBtn.addEventListener('click', () => filterProductsByCategory('all'));
            } else {
                 noProductsMessage.innerHTML = `<i class="fas fa-box-open empty-page-icon"></i><h3>Negozio vuoto!</h3><p>Sembra che non ci siano prodotti disponibili al momento. Torna a trovarci più tardi!</p>`;
            }
            return;
        }
        noProductsMessage.style.display = 'none'; productGrid.style.display = 'grid';

        productsToDisplay.forEach(product => {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.dataset.productId = product.id;
            card.innerHTML = `
                <img src="${product.imageSmall || 'https://via.placeholder.com/300x220'}" alt="${product.name}">
                <div class="product-card-content">
                    <h3>${product.name}</h3><p class="price">${formatPrice(product.price)}</p>
                    <div class="product-card-actions">
                        <button class="btn details-btn" data-product-id="${product.id}">Dettagli</button>
                        <button class="btn wishlist-btn-card" data-product-id="${product.id}"><i class="far fa-heart"></i></button>
                    </div>
                </div>`;
            productGrid.appendChild(card);
        });
        updateWishlistButtonsOnMainGrid();
    }

    function updateWishlistButtonsOnMainGrid() {
         document.querySelectorAll('#product-grid .wishlist-btn-card').forEach(btn => {
            const productId = btn.dataset.productId;
            const heartIcon = btn.querySelector('i');
            if (isUserLoggedIn() && wishlistProductIds.includes(productId)) { // Mostra attivo solo se loggato e in lista
                btn.classList.add('active'); heartIcon.classList.remove('far'); heartIcon.classList.add('fas');
            } else {
                btn.classList.remove('active'); heartIcon.classList.remove('fas'); heartIcon.classList.add('far');
            }
        });
    }

    function flyToCartEffect(startElementSourceImage) {
        if (!startElementSourceImage) return;
        const flyingEl = document.createElement('img');
        flyingEl.src = startElementSourceImage.src;
        flyingEl.className = 'flying-product';
        const startRect = startElementSourceImage.getBoundingClientRect();
        const initialSize = Math.min(startRect.width, 80);
        Object.assign(flyingEl.style, {
            width: `${initialSize}px`, height: `${initialSize}px`,
            left: `${startRect.left + (startRect.width / 2) - (initialSize / 2)}px`,
            top: `${startRect.top + (startRect.height / 2) - (initialSize / 2)}px`,
            opacity: '1'
        });
        document.body.appendChild(flyingEl);
        void flyingEl.offsetWidth;
        const cartIconRect = cartBtnIcon.getBoundingClientRect();
        const targetIconCenterX = cartIconRect.left + cartIconRect.width / 2;
        const targetIconCenterY = cartIconRect.top + cartIconRect.height / 2;
        const finalSize = 30;
        Object.assign(flyingEl.style, {
            left: `${targetIconCenterX - (finalSize / 2)}px`, top: `${targetIconCenterY - (finalSize / 2)}px`,
            width: `${finalSize}px`, height: `${finalSize}px`, opacity: '0.2'
        });
        let animationEnded = false;
        function onAnimationEnd() {
            if (animationEnded) return; animationEnded = true;
            flyingEl.remove();
            cartBtnIcon.classList.add('cart-icon-pop');
            setTimeout(() => cartBtnIcon.classList.remove('cart-icon-pop'), 400);
        }
        flyingEl.addEventListener('transitionend', onAnimationEnd); setTimeout(onAnimationEnd, 850);
    }

    function flyToWishlistEffect(startElementSourceImage) {
        if (!startElementSourceImage) return;
        const flyingEl = document.createElement('img');
        flyingEl.src = startElementSourceImage.src;
        flyingEl.className = 'flying-product';
        const startRect = startElementSourceImage.getBoundingClientRect();
        const initialSize = Math.min(startRect.width, 70);
        Object.assign(flyingEl.style, {
            width: `${initialSize}px`, height: `${initialSize}px`,
            left: `${startRect.left + (startRect.width / 2) - (initialSize / 2)}px`,
            top: `${startRect.top + (startRect.height / 2) - (initialSize / 2)}px`,
            opacity: '1'
        });
        document.body.appendChild(flyingEl);
        void flyingEl.offsetWidth;
        const wishlistIconRect = wishlistBtnIcon.getBoundingClientRect();
        const targetIconCenterX = wishlistIconRect.left + wishlistIconRect.width / 2;
        const targetIconCenterY = wishlistIconRect.top + wishlistIconRect.height / 2;
        const finalSize = 25;
        Object.assign(flyingEl.style, {
            left: `${targetIconCenterX - (finalSize / 2)}px`, top: `${targetIconCenterY - (finalSize / 2)}px`,
            width: `${finalSize}px`, height: `${finalSize}px`, opacity: '0.2'
        });
        let animationEnded = false;
        function onAnimationEnd() {
            if (animationEnded) return; animationEnded = true;
            flyingEl.remove();
            wishlistBtnIcon.classList.add('wishlist-icon-pop');
            setTimeout(() => wishlistBtnIcon.classList.remove('wishlist-icon-pop'), 400);
        }
        flyingEl.addEventListener('transitionend', onAnimationEnd); setTimeout(onAnimationEnd, 850);
    }

    productGrid.addEventListener('click', e => {
        const detailsBtn = e.target.closest('.details-btn');
        const wishlistCardBtn = e.target.closest('.wishlist-btn-card');

        if (detailsBtn) {
            openProductDetailModal(detailsBtn.dataset.productId);
        }
        if (wishlistCardBtn) {
            if (!isUserLoggedIn()) {
                showFeedback("Devi essere registrato e loggato per aggiungere prodotti ai preferiti.", "info");
                openAccountModal('login');
                return;
            }
            const productId = wishlistCardBtn.dataset.productId;
            const productCardElement = wishlistCardBtn.closest('.product-card');
            const productImageElement = productCardElement?.querySelector('img');
            const isInWishlist = wishlistProductIds.includes(productId);

            if (!isInWishlist && productImageElement) {
                flyToWishlistEffect(productImageElement);
                setTimeout(() => toggleWishlist(productId, 'add'), 100);
            } else {
                if (isInWishlist && productCardElement) {
                    productCardElement.classList.add('removing-from-wishlist-main');
                    setTimeout(() => productCardElement.classList.remove('removing-from-wishlist-main'), SHAKE_ANIMATION_DURATION);
                }
                toggleWishlist(productId, 'remove');
            }
        }
    });

    function openProductDetailModal(productIdStr) {
        const product = allProducts.find(p => String(p.id) === productIdStr);
        if (!product) {
            showFeedback("Dettagli prodotto non disponibili.", "error"); return;
        }
        let sizesOptions = product.availableSizes && Array.isArray(product.availableSizes) && product.availableSizes.length > 0 ? product.availableSizes.map(s => `<option value="${s}">${s}</option>`).join('') : '';
        let colorsOptions = product.availableColors && Array.isArray(product.availableColors) && product.availableColors.length > 0 ? product.availableColors.map(c => `<option value="${c}">${c}</option>`).join('') : '';

        productDetailContent.innerHTML = `
            <div class="product-detail-layout">
                <div class="product-detail-image"><img src="${product.imageLarge || product.imageSmall || 'https://via.placeholder.com/400x300'}" alt="${product.name}"></div>
                <div class="product-detail-info">
                    <h2>${product.name}</h2><p class="price">${formatPrice(product.price)}</p><p>${product.description || ''}</p>
                    <div class="product-detail-options">
                        <label for="product-size">Taglia:</label><select id="product-size" ${!sizesOptions ? 'disabled' : ''}>${!sizesOptions ? '<option selected>Unica</option>' : sizesOptions}</select>
                        <label for="product-color">Colore:</label><select id="product-color" ${!colorsOptions ? 'disabled' : ''}>${!colorsOptions ? '<option selected>Unico</option>' : colorsOptions}</select>
                        <label for="product-quantity">Quantità:</label><input type="number" id="product-quantity" value="1" min="1" max="10">
                    </div>
                    <button class="add-to-cart-btn" data-product-id="${product.id}">Aggiungi al Carrello</button>
                    <div class="product-detail-tags">
                        ${sizesOptions ? `<div class="tag-group"><strong>Taglie:</strong> ${product.availableSizes.map(s=>`<span>${s}</span>`).join('')}</div>` : ''}
                        ${colorsOptions ? `<div class="tag-group"><strong>Colori:</strong> ${product.availableColors.map(c=>`<span>${c}</span>`).join('')}</div>` : ''}
                        ${product.category ? `<div class="tag-group"><strong>Categoria:</strong><span>${product.category.replace(/-/g,' ').replace(/\b\w/g,l=>l.toUpperCase())}</span></div>` : ''}
                    </div>
                </div></div>`;
        toggleModal('product-detail-modal', true);

        productDetailContent.querySelector('.add-to-cart-btn').addEventListener('click', function() {
            this.disabled = true;
            const selectedSizeEl = productDetailContent.querySelector('#product-size');
            const selectedColorEl = productDetailContent.querySelector('#product-color');
            const quantity = parseInt(productDetailContent.querySelector('#product-quantity').value);

            const selectedSize = selectedSizeEl.value;
            const selectedColor = selectedColorEl.value;

            if(sizesOptions && selectedSize === "Unica" && selectedSizeEl.options.length > 1){
                showFeedback("Seleziona una taglia.", 'warning'); this.disabled=false; return;
            }
            if(colorsOptions && selectedColor === "Unico" && selectedColorEl.options.length > 1){
                showFeedback("Seleziona un colore.", 'warning'); this.disabled=false; return;
            }

            const pImageEl = productDetailContent.querySelector('.product-detail-image img');
            if(pImageEl) flyToCartEffect(pImageEl);
            addToCart(product.id, selectedSize, selectedColor, quantity);
            setTimeout(() => {
                showFeedback(`${product.name} aggiunto al carrello!`, 'success');
                toggleModal('product-detail-modal', false); this.disabled=false;
            }, 850);
        });
    }

    cartBtnIcon.addEventListener('click', () => {
        cartModal.classList.add('was-already-open');
        toggleModal('cart-modal', true);
        setTimeout(() => cartModal.classList.remove('was-already-open'), 0);
    });

    if(checkoutBtnFromCart) {
        checkoutBtnFromCart.addEventListener('click', () => {
            if (cart.length === 0) { showFeedback("Carrello vuoto!",'warning'); return; }
            openCheckoutModal();
        });
    }

    if (emptyCartBtn) {
        emptyCartBtn.addEventListener('click', () => {
            if (cart.length > 0) {
                cart = [];
                saveCartToStorage();
                showFeedback('Carrello svuotato con successo!', 'success');
            }
        });
    }

    function addToCart(productId, size, color, quantity = 1) {
        const product = allProducts.find(p => p.id == productId);
        if (!product) return;
        const cartItemId = `${product.id}_${size}_${color}`;
        const existingItem = cart.find(item => item.cartItemId === cartItemId);
        if (existingItem) existingItem.quantity += quantity;
        else cart.push({
            cartItemId, productId: product.id, name: product.name, price: product.price,
            imageSmall: product.imageSmall, size: (size==="Unica"?"Unica":size), color:(color==="Unico"?"Unico":color), quantity
        });
        saveCartToStorage();
    }

    function updateCartItemQuantity(cartItemId, newQuantity) {
        const item = cart.find(i => i.cartItemId === cartItemId);
        if (item) { item.quantity = Math.max(1, newQuantity); saveCartToStorage(); }
    }

    function removeFromCart(cartItemId) {
        const itemIndex = cart.findIndex(item => item.cartItemId === cartItemId);
        if (itemIndex > -1) {
            showFeedback(`${cart[itemIndex].name} rimosso.`, 'info');
            cart.splice(itemIndex, 1); saveCartToStorage();
        }
    }

    function updateCartDisplay() {
        cartItemsContainer.innerHTML = ''; let total = 0; let itemCount = 0;
        if (cart.length === 0) {
            cartItemsContainer.innerHTML = `
                <div class="empty-cart-container">
                    <i class="fas fa-shopping-basket empty-cart-icon"></i><h3>Carrello vuoto!</h3>
                    <p>Nessun prodotto aggiunto. Esplora il negozio!</p>
                    <button class="explore-products-btn-cart" id="explore-from-empty-cart-btn"><i class="fas fa-store"></i> Vai allo Shopping</button>
                </div>`;
            if(checkoutBtnFromCart) checkoutBtnFromCart.style.display = 'none';
            if(emptyCartBtn) emptyCartBtn.style.display = 'none';
            document.getElementById('shipping-cost-info-cart').style.display = 'none';
            cartItemsContainer.querySelector('#explore-from-empty-cart-btn')?.addEventListener('click', () => toggleModal('cart-modal', false));
        } else {
            cart.forEach(item => {
                const cartItemEl = document.createElement('div');
                cartItemEl.className = 'cart-item'; cartItemEl.dataset.cartItemId = item.cartItemId;
                let details = [];
                if (item.size !== 'Unica') details.push(`Taglia: ${item.size}`);
                if (item.color !== 'Unico') details.push(`Colore: ${item.color}`);
                cartItemEl.innerHTML = `
                    <div class="cart-item-inner"><div class="cart-item-front">
                        <img src="${item.imageSmall || 'https://via.placeholder.com/60'}" alt="${item.name}">
                        <div class="list-item-info"><h4>${item.name}</h4><p>${details.join(', ')}</p>
                            <p><span class="cart-item-unit-price">${formatPrice(item.price)}</span>
                               <span class="cart-item-qty-display"> × ${item.quantity}</span> =
                               <span class="cart-item-total-price">${formatPrice(parseFloat(item.price) * item.quantity)}</span></p>
                        </div>
                        <div class="cart-item-quantity">
                            <button class="quantity-change" data-change="-1">-</button><input type="text" value="${item.quantity}" readonly><button class="quantity-change" data-change="1">+</button>
                        </div>
                        <div class="list-item-actions">
                             <button class="edit-cart-item-btn" data-cart-item-id="${item.cartItemId}" aria-label="Modifica prodotto"><i class="fas fa-pencil-alt"></i></button>
                             <button class="remove-from-cart-trigger" aria-label="Rimuovi prodotto"><i class="fas fa-trash"></i></button>
                        </div>
                    </div><div class="cart-item-back">
                        <h5>Eliminare questo prodotto?</h5>
                        <div class="confirmation-actions"><button class="confirm-delete-btn">Sì</button><button class="cancel-delete-btn">No</button></div>
                    </div></div>`;
                cartItemsContainer.appendChild(cartItemEl);
                total += parseFloat(item.price) * item.quantity; itemCount += item.quantity;
            });
            if(checkoutBtnFromCart) checkoutBtnFromCart.style.display = 'block';
            if(emptyCartBtn) emptyCartBtn.style.display = 'block';
            document.getElementById('shipping-cost-info-cart').style.display = 'block';
        }
        cartTotalEl.querySelector('strong').textContent = formatPrice(total);
        cartCountBadge.textContent = itemCount;
    }

    cartItemsContainer.addEventListener('click', e => {
        const cartItemEl = e.target.closest('.cart-item'); if (!cartItemEl) return;
        const cartItemId = cartItemEl.dataset.cartItemId;
        const itemInnerEl = cartItemEl.querySelector('.cart-item-inner');

        if (e.target.closest('.edit-cart-item-btn')) {
            openEditCartItemModal(cartItemId);
        }
        else if (e.target.closest('.remove-from-cart-trigger')) cartItemEl.classList.add('is-flipped');
        else if (e.target.closest('.confirm-delete-btn')) {
            if(itemInnerEl) itemInnerEl.classList.add('is-removing');
            setTimeout(() => removeFromCart(cartItemId), 700);
        }
        else if (e.target.closest('.cancel-delete-btn')) cartItemEl.classList.remove('is-flipped');
        else if (e.target.closest('.quantity-change')) {
            const item = cart.find(i => i.cartItemId === cartItemId);
            if (item) {
                let newQty = item.quantity + parseInt(e.target.closest('.quantity-change').dataset.change);
                if (newQty <= 0) cartItemEl.classList.add('is-flipped');
                else updateCartItemQuantity(cartItemId, newQty);
            }
        }
    });

    function openEditCartItemModal(cartItemId) {
        currentEditingCartItemId = cartItemId;
        const cartItem = cart.find(item => item.cartItemId === cartItemId);
        if (!cartItem) {
            showFeedback("Articolo non trovato nel carrello.", "error");
            return;
        }
        const product = allProducts.find(p => p.id === cartItem.productId);
        if (!product) {
            showFeedback("Dettagli prodotto originali non trovati.", "error");
            return;
        }

        let availableSizesOptions = '';
        if (product.availableSizes && product.availableSizes.length > 0) {
            availableSizesOptions = product.availableSizes.map(s =>
                `<option value="${s}" ${s === cartItem.size ? 'selected' : ''}>${s}</option>`
            ).join('');
        } else {
            availableSizesOptions = `<option value="Unica" selected>Unica</option>`;
        }

        let availableColorsOptions = '';
        if (product.availableColors && product.availableColors.length > 0) {
            availableColorsOptions = product.availableColors.map(c =>
                `<option value="${c}" ${c === cartItem.color ? 'selected' : ''}>${c}</option>`
            ).join('');
        } else {
            availableColorsOptions = `<option value="Unico" selected>Unico</option>`;
        }

        editCartItemContent.innerHTML = `
            <div class="edit-cart-item-header">
                <img src="${cartItem.imageSmall || 'https://via.placeholder.com/80'}" alt="${cartItem.name}">
                <h3>Modifica: ${cartItem.name}</h3>
            </div>
            <div class="edit-cart-item-options">
                <div class="option-group">
                    <label for="edit-item-size">Taglia:</label>
                    <select id="edit-item-size" ${!(product.availableSizes && product.availableSizes.length > 0) ? 'disabled' : ''}>
                        ${availableSizesOptions}
                    </select>
                </div>
                <div class="option-group">
                    <label for="edit-item-color">Colore:</label>
                    <select id="edit-item-color" ${!(product.availableColors && product.availableColors.length > 0) ? 'disabled' : ''}>
                        ${availableColorsOptions}
                    </select>
                </div>
            </div>
            <div class="edit-cart-item-actions">
                <button class="btn cancel-edit-btn">Annulla</button>
                <button class="btn save-edit-btn">Salva Modifiche</button>
            </div>
        `;

        editCartItemModal.dataset.cartModalWasOpen = cartModal.classList.contains('active') ? 'true' : 'false';
        toggleModal('edit-cart-item-modal', true);

        editCartItemContent.querySelector('.save-edit-btn').addEventListener('click', saveCartItemChanges);
        editCartItemContent.querySelector('.cancel-edit-btn').addEventListener('click', () => {
            currentEditingCartItemId = null;
            toggleModal('edit-cart-item-modal', false);
            if (editCartItemModal.dataset.cartModalWasOpen === 'true') {
                setTimeout(() => toggleModal('cart-modal', true), 100);
            }
        });
    }

    function saveCartItemChanges() {
        if (!currentEditingCartItemId) return;

        const oldCartItem = cart.find(item => item.cartItemId === currentEditingCartItemId);
        if (!oldCartItem) {
            showFeedback("Errore: articolo da modificare non trovato.", "error");
            toggleModal('edit-cart-item-modal', false);
            currentEditingCartItemId = null;
            return;
        }

        const newSize = editCartItemContent.querySelector('#edit-item-size').value;
        const newColor = editCartItemContent.querySelector('#edit-item-color').value;
        const baseProductId = oldCartItem.productId;

        if (newSize === oldCartItem.size && newColor === oldCartItem.color) {
            showFeedback("Nessuna modifica rilevata.", "info");
            toggleModal('edit-cart-item-modal', false);
            currentEditingCartItemId = null;
            if (editCartItemModal.dataset.cartModalWasOpen === 'true') {
                setTimeout(() => toggleModal('cart-modal', true), 100);
            }
            return;
        }
        const newCartItemId = `${baseProductId}_${newSize}_${newColor}`;
        const existingItemWithNewOptions = cart.find(item => item.cartItemId === newCartItemId);

        if (existingItemWithNewOptions && newCartItemId !== currentEditingCartItemId) {
            existingItemWithNewOptions.quantity += oldCartItem.quantity;
            const oldItemIndex = cart.findIndex(item => item.cartItemId === currentEditingCartItemId);
            if (oldItemIndex > -1) cart.splice(oldItemIndex, 1);
            showFeedback("Articolo aggiornato e unito con esistente.", 'success');
        } else {
            oldCartItem.cartItemId = newCartItemId;
            oldCartItem.size = newSize;
            oldCartItem.color = newColor;
            showFeedback("Articolo modificato con successo!", 'success');
        }
        saveCartToStorage();
        toggleModal('edit-cart-item-modal', false);
        currentEditingCartItemId = null;
        if (editCartItemModal.dataset.cartModalWasOpen === 'true') {
            setTimeout(() => toggleModal('cart-modal', true), 100);
        }
    }

    wishlistBtnIcon.addEventListener('click', () => toggleWishlistPage(true)); // Il controllo login è in toggleWishlistPage
    wishlistPageCloseBtn.addEventListener('click', () => toggleWishlistPage(false));

    async function toggleWishlist(productIdStr, actionType) {
        // Assumiamo che isUserLoggedIn() sia stato chiamato prima di invocare toggleWishlist
        // quindi currentUserSession.userId è l'ID di un utente loggato.
        const userIdForWishlist = currentUserSession.userId;
        const product = allProducts.find(p => String(p.id) === productIdStr);
        if (!product) { console.error("Prodotto non trovato in toggleWishlist:", productIdStr); return; }

        wishlistBtnIcon.disabled = true;

        let method, url;
        if (actionType === 'add') {
            method = 'POST';
            url = `${PRODUCTS_API_URL}?action=wishlist`;
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userIdForWishlist, product_id: product.id })
                });
                const data = await response.json();
                if (!response.ok && response.status !== 201 && !(response.status === 200 && data.message && data.message.includes("già presente")) && response.status !== 409) { // 409 = Conflict (già esiste)
                    throw new Error(data.message || `Errore HTTP ${response.status}`);
                }
                if (!wishlistProductIds.includes(String(product.id))) {
                    wishlistProductIds.push(String(product.id));
                }
                showFeedback(`${product.name} aggiunto ai preferiti!`, 'success');
            } catch (error) {
                console.error('Errore aggiunta wishlist (DB):', error);
                showFeedback(`Errore aggiunta preferiti: ${error.message}`, 'error');
            }
        } else if (actionType === 'remove') {
            method = 'DELETE';
            url = `${PRODUCTS_API_URL}?action=wishlist&user_id=${userIdForWishlist}&product_id=${product.id}`;
            try {
                const response = await fetch(url, { method: method });
                const data = await response.json();
                if (!response.ok && !(response.status === 200 && data.message && data.message.includes("non trovato"))) {
                    throw new Error(data.message || `Errore HTTP ${response.status}`);
                }
                const index = wishlistProductIds.indexOf(String(product.id));
                if (index > -1) wishlistProductIds.splice(index, 1);
                showFeedback(`${product.name} rimosso dai preferiti.`, 'info');
            } catch (error) {
                console.error('Errore rimozione wishlist (DB):', error);
                showFeedback(`Errore rimozione preferiti: ${error.message}`, 'error');
            }
        }
        // Rimossa la parte else che gestiva la wishlist ospite con localStorage

        wishlistBtnIcon.disabled = false;
        updateWishlistVisuals();
        if (wishlistPage.classList.contains('active')) await renderWishlistPageGrid();
    }

    async function removeFromWishlistPage(productIdStr) {
        // Assumiamo che l'utente sia loggato perché questa funzione è chiamata dalla pagina wishlist,
        // che è accessibile solo da loggati.
        const productCardElement = wishlistPageGrid.querySelector(`.product-card[data-product-id="${productIdStr}"]`);
        if (productCardElement) {
            productCardElement.classList.add('is-removing-from-wishlist');
            setTimeout(async () => {
                await toggleWishlist(productIdStr, 'remove');
            }, WISHLIST_REMOVAL_ANIMATION_DURATION);
        } else {
            await toggleWishlist(productIdStr, 'remove');
        }
    }

    function updateWishlistIconBadge() {
        if (isUserLoggedIn()) {
            wishlistCountBadge.textContent = wishlistProductIds.length;
        } else {
            wishlistCountBadge.textContent = 0; // Per utenti non loggati, il contatore è 0
        }
    }

    async function renderWishlistPageGrid() {
        wishlistPageGrid.innerHTML = '';
        // Se !isUserLoggedIn(), la pagina wishlist non dovrebbe nemmeno aprirsi,
        // ma per sicurezza gestiamo il caso.
        if (!isUserLoggedIn()) {
            Object.assign(wishlistPageGrid.style, { display: 'flex', alignItems: 'center', justifyContent: 'center', height: '100%'});
            wishlistPageGrid.innerHTML = `
                <div class="empty-wishlist-container">
                    <i class="far fa-heart empty-wishlist-icon"></i><h3>Accedi per i Preferiti</h3>
                    <p>Devi essere registrato e aver effettuato il login per usare la lista dei desideri.</p>
                    <button class="btn-primary" id="login-from-empty-wishlist-btn" style="padding: 10px 20px; font-size: 1rem;"><i class="fas fa-sign-in-alt"></i> Accedi o Registrati</button>
                </div>`;
            wishlistPageGrid.querySelector('#login-from-empty-wishlist-btn')?.addEventListener('click', () => {
                toggleWishlistPage(false);
                openAccountModal('login');
            });
            return;
        }

        const userId = currentUserSession.userId;
        let favoritedProductsDetails = [];

        if (wishlistProductIds.length > 0) {
            // Siccome l'utente è loggato, i dati dovrebbero essere già nel DB
            try {
                const response = await fetch(`${PRODUCTS_API_URL}?action=wishlist&user_id=${userId}`);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({message: "Errore server"}));
                    if (response.status === 401 || response.status === 404) {
                        console.warn("Errore caricamento dettagli wishlist (render): Utente non valido/trovato.", errorData.message);
                         favoritedProductsDetails = [];
                    } else {
                        throw new Error(errorData.message || "Errore caricamento dettagli prodotti wishlist per la pagina");
                    }
                } else {
                    favoritedProductsDetails = await response.json();
                }
                favoritedProductsDetails = Array.isArray(favoritedProductsDetails) ? favoritedProductsDetails : [];
            } catch (err) {
                console.error("Errore fetch dettagli completi wishlist per la pagina:", err);
                showFeedback(`Impossibile caricare i dettagli dei preferiti: ${err.message}`, 'error');
                // Come fallback, potremmo tentare di usare allProducts se gli ID sono già noti localmente, ma è meno affidabile.
                // Per ora, mostriamo errore e lista vuota in caso di fallimento grave del fetch.
                favoritedProductsDetails = [];
            }
        }

        wishlistPageGrid.className = 'product-grid';
        Object.assign(wishlistPageGrid.style, { display: 'grid', alignItems: 'initial', justifyContent: 'initial', height: 'auto'});

        if (favoritedProductsDetails.length === 0) {
            if (!wishlistPageGrid.querySelector('.empty-wishlist-container')) {
                Object.assign(wishlistPageGrid.style, { display: 'flex', alignItems: 'center', justifyContent: 'center', height: '100%'});
                wishlistPageGrid.innerHTML = `
                    <div class="empty-wishlist-container">
                        <i class="far fa-heart empty-wishlist-icon"></i><h3>Lista Desideri Vuota</h3>
                        <p>Nessun preferito aggiunto. Inizia ad esplorare!</p>
                        <button class="explore-products-btn" id="explore-from-empty-wishlist-btn"><i class="fas fa-store"></i> Vai allo Shopping</button>
                    </div>`;
                const exploreBtn = wishlistPageGrid.querySelector('#explore-from-empty-wishlist-btn');
                if (exploreBtn) exploreBtn.addEventListener('click', () => {
                    toggleWishlistPage(false);
                    filterProductsByCategory('all');
                });
            }
            return;
        }

        favoritedProductsDetails.forEach(product => {
            if (wishlistPageGrid.querySelector(`.product-card[data-product-id="${product.id}"].is-removing-from-wishlist`)) return;
            const card = document.createElement('div');
            card.className = 'product-card'; card.dataset.productId = product.id;
            card.innerHTML = `
                <img src="${product.imageSmall || 'https://via.placeholder.com/300x220'}" alt="${product.name}">
                <div class="product-card-content">
                    <h3>${product.name}</h3><p class="price">${formatPrice(product.price)}</p>
                    <div class="product-card-actions">
                        <button class="btn details-btn-wishlist" data-product-id="${product.id}"><i class="fas fa-eye"></i> Dettagli</button>
                        <button class="btn remove-from-wishlist-page-btn" data-product-id="${product.id}"><i class="fas fa-trash-alt"></i> Rimuovi</button>
                    </div></div>`;
            wishlistPageGrid.appendChild(card);
        });
    }

    wishlistPageGrid.addEventListener('click', e => {
        // Assumiamo che l'utente sia loggato se sta interagendo con questa griglia
        const detailsBtn = e.target.closest('.details-btn-wishlist');
        const removeBtn = e.target.closest('.remove-from-wishlist-page-btn');
        if (detailsBtn) {
            openProductDetailModal(detailsBtn.dataset.productId);
        } else if (removeBtn) {
            removeFromWishlistPage(removeBtn.dataset.productId);
        }
    });

    // --- AUTENTICAZIONE ---
    function loadCurrentUserSession() {
        const sessionData = localStorage.getItem(LS_CURRENT_USER_SESSION_KEY);
        currentUserSession = sessionData ? JSON.parse(sessionData) : null;
    }

    function saveCurrentUserSession(session) {
        localStorage.setItem(LS_CURRENT_USER_SESSION_KEY, JSON.stringify(session));
        currentUserSession = session;
    }

    function clearCurrentUserSession() {
        localStorage.removeItem(LS_CURRENT_USER_SESSION_KEY);
        currentUserSession = null;
    }

    async function registerUser(username, email, password) {
        try {
            const response = await fetch(`${AUTH_API_URL}?action=register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, email, password })
            });
            const result = await response.json();
            if (response.ok || response.status === 201) {
                showFeedback(result.message || "Registrazione avvenuta con successo! Ora puoi effettuare il login.", "success");
                return true;
            } else {
                showFeedback(result.message || "Errore durante la registrazione.", "error");
                return false;
            }
        } catch (error) {
            console.error('Errore API registrazione:', error);
            showFeedback("Errore di connessione durante la registrazione.", "error");
            return false;
        }
    }

    async function loginUser(identifier, password) {
        try {
            const response = await fetch(`${AUTH_API_URL}?action=login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ identifier, password })
            });
            const result = await response.json();

            if (response.ok) {
                saveCurrentUserSession(result.userData);
                showFeedback(result.message || `Bentornato, ${result.userData.username}!`, "success");
                await initializeUserSpecificData(); // Questo ora caricherà la wishlist dal DB
                toggleModal('account-modal', false);
                return true;
            } else {
                showFeedback(result.message || "Username/Email o password non validi.", "error");
                return false;
            }
        } catch (error) {
            console.error('Errore API login:', error);
            showFeedback("Errore di connessione durante il login.", "error");
            return false;
        }
    }

    async function logoutUser() {
        const username = currentUserSession ? currentUserSession.username : "Utente";
        clearCurrentUserSession();
        showFeedback(`Logout effettuato. Arrivederci, ${username}!`, "info");

        wishlistProductIds = []; // Svuota la wishlist locale
        // localStorage.removeItem(LS_GUEST_WISHLIST_KEY); // Non più necessario
        updateWishlistVisuals(); // Aggiorna l'icona e i pulsanti

        await initializeUserSpecificData(); // Ricarica dati utente (ora ospite)
        updateAuthUI();
        toggleModal('account-modal', false);
        userOrdersCache = [];
    }

    async function deleteCurrentUserAccount() {
        if (!currentUserSession || !currentUserSession.userId) {
            showFeedback("Nessun utente loggato o ID utente mancante.", "error");
            return;
        }
        if (!confirm(`Sei sicuro di voler eliminare l'account ${currentUserSession.username}? Questa azione è irreversibile e cancellerà tutti i tuoi dati (inclusi gli ordini) dal database.`)) {
            return;
        }

        try {
            const response = await fetch(`${AUTH_API_URL}?action=delete_account&user_id=${currentUserSession.userId}`, {
                method: 'DELETE'
            });
            const result = await response.json();

            if (response.ok) {
                showFeedback(result.message || `Account ${currentUserSession.username} eliminato con successo.`, "success");

                clearCurrentUserSession();

                wishlistProductIds = []; // Svuota la wishlist locale
                updateWishlistVisuals();

                await initializeUserSpecificData();
                updateAuthUI();
                toggleModal('account-modal', false);
                userOrdersCache = [];
            } else {
                showFeedback(result.message || "Errore durante l'eliminazione dell'account.", "error");
            }
        } catch (error) {
            console.error('Errore API eliminazione account:', error);
            showFeedback("Errore di connessione durante l'eliminazione dell'account.", "error");
        }
    }

    function updateAuthUI() {
        loadCurrentUserSession();
        let content = '';
        if (currentUserSession) {
            content = `<span class="username-display">Ciao, ${currentUserSession.username}</span>
                       <button id="open-account-dashboard-btn" aria-label="Il Mio Account"><i class="fas fa-user-circle"></i> Account</button>`;
        } else {
            content = `<button id="open-login-modal-btn" aria-label="Accedi o Registrati"><i class="fas fa-sign-in-alt"></i> Accedi</button>`;
        }
        userAccountControlsContainer.innerHTML = content;

        if (currentUserSession) {
            document.getElementById('open-account-dashboard-btn')?.addEventListener('click', () => openAccountModal('dashboard'));
        } else {
            document.getElementById('open-login-modal-btn')?.addEventListener('click', () => openAccountModal('login'));
        }
    }

    function openAccountModal(initialView = 'login') {
        if (!accountModalContent) return;
        let content = '';
        if (currentUserSession) {
             content = `
                <div class="user-dashboard">
                    <div class="modal-header" style="text-align:left; padding-left:0; border-bottom:none;">
                        <h2 style="text-align:left;">Ciao, ${currentUserSession.username}!</h2>
                    </div>
                    <p class="user-greeting">Gestisci il tuo account e i tuoi ordini.</p>
                    <div class="dashboard-actions">
                        <button id="open-my-account-details-btn" class="btn-primary"><i class="fas fa-user-cog"></i> Gestisci Account</button>
                        <button id="open-user-data-btn" class="btn-primary"><i class="fas fa-id-card"></i> I Miei Dati di Contatto</button>
                        <button id="open-orders-history-btn" class="btn-primary"><i class="fas fa-receipt"></i> I Miei Ordini</button>
                        <button id="logout-btn" class="btn-secondary"><i class="fas fa-sign-out-alt"></i> Esci</button>
                        <button id="delete-account-btn" class="btn-danger" style="margin-top: 20px;"><i class="fas fa-user-slash"></i> Elimina Account</button>
                    </div>
                </div>`;
        } else {
            content = `
        <div class="auth-modal-illustration">
            <i class="fas fa-user-lock animated-icon"></i> <!-- Icona grande e moderna -->
        </div>
        <div class="auth-tabs modern-tabs">
            <button class="tab-btn ${initialView === 'login' ? 'active' : ''}" data-tab="login-section"><i class="fas fa-sign-in-alt"></i> Login</button>
            <button class="tab-btn ${initialView === 'register' ? 'active' : ''}" data-tab="register-section"><i class="fas fa-user-plus"></i> Registrazione</button>
        </div>
        <div id="login-section" class="auth-section ${initialView === 'login' ? 'active' : ''}">
            <div class="modal-header"><h2 style="font-size: 1.4rem;"><i class="fas fa-sign-in-alt"></i> Accedi al tuo Account</h2></div>
            <form id="login-form" autocomplete="on">
                <div class="form-group with-icon">
                    <label for="login-identifier">Username o Email</label>
                    <div class="input-icon"><i class="fas fa-user"></i><input type="text" id="login-identifier" required placeholder="Inserisci username o email"></div>
                </div>
                <div class="form-group with-icon">
                    <label for="login-password">Password</label>
                    <div class="input-icon"><i class="fas fa-lock"></i><input type="password" id="login-password" required placeholder="Inserisci la password"></div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary big-btn"><i class="fas fa-sign-in-alt"></i> Accedi</button>
                </div>
                <p class="auth-switch-text">Non hai un account? <button type="button" class="btn-link switch-to-register"><i class="fas fa-user-plus"></i> Registrati</button></p>
            </form>
        </div>
        <div id="register-section" class="auth-section ${initialView === 'register' ? 'active' : ''}">
            <div class="modal-header"><h2 style="font-size: 1.4rem;"><i class="fas fa-user-plus"></i> Crea un Nuovo Account</h2></div>
            <form id="register-form" autocomplete="on">
                <div class="form-group with-icon">
                    <label for="register-username">Username</label>
                    <div class="input-icon"><i class="fas fa-user"></i><input type="text" id="register-username" required minlength="3" placeholder="Scegli uno username"></div>
                </div>
                <div class="form-group with-icon">
                    <label for="register-email">Email</label>
                    <div class="input-icon"><i class="fas fa-envelope"></i><input type="email" id="register-email" required placeholder="Inserisci la tua email"></div>
                </div>
                <div class="form-group with-icon">
                    <label for="register-password">Password</label>
                    <div class="input-icon"><i class="fas fa-lock"></i><input type="password" id="register-password" required minlength="6" placeholder="Crea una password"></div>
                </div>
                <div class="form-group with-icon">
                    <label for="register-confirm-password">Conferma Password</label>
                    <div class="input-icon"><i class="fas fa-lock"></i><input type="password" id="register-confirm-password" required placeholder="Ripeti la password"></div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary big-btn"><i class="fas fa-user-plus"></i> Registrati</button>
                </div>
                <p class="auth-switch-text">Hai già un account? <button type="button" class="btn-link switch-to-login"><i class="fas fa-sign-in-alt"></i> Accedi</button></p>
            </form>
        </div>`;
        }
        accountModalContent.innerHTML = content;
        toggleModal('account-modal', true);
        setupAccountModalListeners();
    }

    function setupAccountModalListeners() {
        accountModalContent.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                accountModalContent.querySelector('.tab-btn.active').classList.remove('active');
                btn.classList.add('active');
                accountModalContent.querySelector('.auth-section.active').classList.remove('active');
                accountModalContent.querySelector(`#${btn.dataset.tab}`).classList.add('active');
            });
        });

        accountModalContent.querySelector('.switch-to-register')?.addEventListener('click', () => openAccountModal('register'));
        accountModalContent.querySelector('.switch-to-login')?.addEventListener('click', () => openAccountModal('login'));

        const loginForm = accountModalContent.querySelector('#login-form');
        if (loginForm) {
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const identifier = loginForm.querySelector('#login-identifier').value;
                const password = loginForm.querySelector('#login-password').value;
                await loginUser(identifier, password);
            });
        }

        const registerForm = accountModalContent.querySelector('#register-form');
        if (registerForm) {
            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = registerForm.querySelector('#register-username').value;
                const email = registerForm.querySelector('#register-email').value;
                const password = registerForm.querySelector('#register-password').value;
                const confirmPassword = registerForm.querySelector('#register-confirm-password').value;
                if (password !== confirmPassword) {
                    showFeedback("Le password non coincidono.", "error"); return;
                }
                if (await registerUser(username, email, password)) {
                    openAccountModal('login');
                }
            });
        }

        accountModalContent.querySelector('#open-my-account-details-btn')?.addEventListener('click', openMyAccountDetailsModal);
        accountModalContent.querySelector('#open-user-data-btn')?.addEventListener('click', openUserDataModal);
        accountModalContent.querySelector('#open-orders-history-btn')?.addEventListener('click', openOrdersHistoryModal);
        accountModalContent.querySelector('#logout-btn')?.addEventListener('click', logoutUser);
        accountModalContent.querySelector('#delete-account-btn')?.addEventListener('click', deleteCurrentUserAccount);
    }

    function openMyAccountDetailsModal() {
        if (!currentUserSession) {
            showFeedback("Devi essere loggato per gestire il tuo account.", "info");
            openAccountModal('login');
            return;
        }

        myAccountDetailsModalContent.innerHTML = `
            <form id="my-account-details-form">
                <div class="form-group">
                    <label for="myacc-username">Username (per login)</label>
                    <input type="text" id="myacc-username" value="${currentUserPersonalData.username || currentUserSession.username || ''}" readonly required minlength="3">
                </div>
                <div class="form-group">
                    <label for="myacc-email">Email (per login)</label>
                    <input type="email" id="myacc-email" value="${currentUserPersonalData.loginEmail || currentUserSession.email || ''}" readonly required>
                </div>
                <div class="form-actions" style="justify-content:flex-start;">
                    <button type="button" id="edit-my-account-details-btn" class="btn-secondary"><i class="fas fa-edit"></i> Modifica Dati Account</button>
                    <button type="submit" id="save-my-account-details-btn" class="btn-primary" style="display:none;" disabled><i class="fas fa-save"></i> Salva Modifiche Account</button>
                    <button type="button" id="cancel-edit-my-account-details-btn" class="btn-secondary" style="display:none;"><i class="fas fa-times"></i> Annulla Modifica</button>
                </div>
            </form>
        `;
        toggleModal('my-account-details-modal', true);
        if (accountModal.classList.contains('active')) {
            toggleModal('account-modal', false);
        }
        setMyAccountDetailsEditMode(false);

        myAccountDetailsModalContent.querySelector('#edit-my-account-details-btn').addEventListener('click', () => setMyAccountDetailsEditMode(true));
        myAccountDetailsModalContent.querySelector('#cancel-edit-my-account-details-btn').addEventListener('click', () => {
            if (originalMyAccountDetails) {
                myAccountDetailsModalContent.querySelector('#myacc-username').value = originalMyAccountDetails.username;
                myAccountDetailsModalContent.querySelector('#myacc-email').value = originalMyAccountDetails.email;
            }
            setMyAccountDetailsEditMode(false);
        });

        const form = myAccountDetailsModalContent.querySelector('#my-account-details-form');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const saveBtn = myAccountDetailsModalContent.querySelector('#save-my-account-details-btn');
            if (saveBtn.disabled) return;
            const newUsername = form.querySelector('#myacc-username').value.trim();
            const newEmail = form.querySelector('#myacc-email').value.trim().toLowerCase();
            await saveMyAccountDetails(newUsername, newEmail);
        });
    }

  function setMyAccountDetailsEditMode(isEditing) {
    const usernameInput = myAccountDetailsModalContent.querySelector('#myacc-username');
    const emailInput = myAccountDetailsModalContent.querySelector('#myacc-email');
    const editBtn = myAccountDetailsModalContent.querySelector('#edit-my-account-details-btn');
    const saveBtn = myAccountDetailsModalContent.querySelector('#save-my-account-details-btn');
    const cancelBtn = myAccountDetailsModalContent.querySelector('#cancel-edit-my-account-details-btn');

    if (!usernameInput || !emailInput || !editBtn || !saveBtn || !cancelBtn) return;

    if (isEditing) {
        originalMyAccountDetails = {
            username: usernameInput.value,
            email: emailInput.value
        };
        usernameInput.readOnly = false;
        emailInput.readOnly = false;
        usernameInput.style.cursor = 'text';
        emailInput.style.cursor = 'text';

        editBtn.style.display = 'none';
        saveBtn.style.display = 'inline-block';
        saveBtn.disabled = true;
        cancelBtn.style.display = 'inline-block';

        [usernameInput, emailInput].forEach(field => {
            field.removeEventListener('input', handleMyAccountDetailsInputChange);
            field.addEventListener('input', handleMyAccountDetailsInputChange);
        });
        usernameInput.focus();
    } else {
        usernameInput.readOnly = true;
        emailInput.readOnly = true;
        usernameInput.style.cursor = 'default';
        emailInput.style.cursor = 'default';

        editBtn.style.display = 'inline-block';
        saveBtn.style.display = 'none';
        cancelBtn.style.display = 'none';

        [usernameInput, emailInput].forEach(field => {
            field.removeEventListener('input', handleMyAccountDetailsInputChange);
        });
        originalMyAccountDetails = null;
    }
}

function handleMyAccountDetailsInputChange() {
    const saveBtn = myAccountDetailsModalContent.querySelector('#save-my-account-details-btn');
    if (!saveBtn || !originalMyAccountDetails) return;

    const currentUsername = myAccountDetailsModalContent.querySelector('#myacc-username').value.trim();
    const currentEmail = myAccountDetailsModalContent.querySelector('#myacc-email').value.trim().toLowerCase();

    let isEmailValid = true;
    if (!currentEmail || !/\S+@\S+\.\S+/.test(currentEmail)) {
        isEmailValid = false;
    }

    let hasChanged = false;
    if (currentUsername !== originalMyAccountDetails.username || currentEmail !== originalMyAccountDetails.email) {
        hasChanged = true;
    }
    saveBtn.disabled = !(hasChanged && currentUsername && currentEmail && isEmailValid);
}

async function saveMyAccountDetails(username, email) {
        if (!currentUserSession || !currentUserSession.userId) {
            showFeedback("Sessione utente non valida.", "error");
            return;
        }
        try {
            const response = await fetch(`${AUTH_API_URL}?action=update_account_details&user_id=${currentUserSession.userId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, email })
            });
            const result = await response.json();
            if (response.ok) {
                showFeedback(result.message || "Dettagli account di login aggiornati!", "success");
                currentUserSession.username = result.updatedUserData.username;
                currentUserSession.email = result.updatedUserData.email;
                saveCurrentUserSession(currentUserSession);

                currentUserPersonalData.username = result.updatedUserData.username;
                currentUserPersonalData.loginEmail = result.updatedUserData.email;

                updateAuthUI();
                toggleModal('my-account-details-modal', false);
            } else {
                showFeedback(result.message || "Errore durante l'aggiornamento dell'account.", "error");
            }
        } catch (error) {
            console.error('Errore API aggiornamento account:', error);
            showFeedback("Errore di connessione durante l'aggiornamento dell'account.", "error");
        }
    }

   async function loadUserPersonalData() {
    if (!currentUserSession || !currentUserSession.userId) {
        currentUserPersonalData = {
            username: (currentUserSession ? currentUserSession.username : ''),
            loginEmail: (currentUserSession ? currentUserSession.email : ''),
            contactFullName: '', contactEmail: '', contactPhone: ''
        };
        return;
    }
    try {
        const response = await fetch(`${USER_DATA_API_URL}?action=get_personal_data&user_id=${currentUserSession.userId}`);
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ message: `HTTP error ${response.status}` }));
            throw new Error(errorData.message);
        }
        const data = await response.json();
        currentUserPersonalData = {
            username: data.username || (currentUserSession ? currentUserSession.username : ''),
            loginEmail: data.loginEmail || (currentUserSession ? currentUserSession.email : ''),
            contactFullName: data.contactFullName || '',
            contactEmail: data.contactEmail || '',
            contactPhone: data.contactPhone || ''
        };
    } catch (error) {
        console.error('Errore caricamento dati personali da API:', error);
        showFeedback(`Errore caricamento dati personali: ${error.message}`, "error");
        currentUserPersonalData = {
            username: (currentUserSession ? currentUserSession.username : ''),
            loginEmail: (currentUserSession ? currentUserSession.email : ''),
            contactFullName: '', contactEmail: '', contactPhone: ''
        };
    }
}

    async function saveUserContactDataToAPI() {
        if (!currentUserSession || !currentUserSession.userId || !currentUserPersonalData) {
             showFeedback("Sessione non valida o dati mancanti.", "error"); return false;
        }
        try {
            const payload = {
                contactFullName: currentUserPersonalData.contactFullName,
                contactEmail: currentUserPersonalData.contactEmail,
                contactPhone: currentUserPersonalData.contactPhone
            };
            const response = await fetch(`${USER_DATA_API_URL}?action=save_personal_data&user_id=${currentUserSession.userId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.message || `HTTP error ${response.status}`);
            }
            showFeedback(result.message || "Dati di contatto salvati!", "success");
            return true;
        } catch (error) {
            console.error('Errore salvataggio dati di contatto via API:', error);
            showFeedback(`Errore salvataggio dati di contatto: ${error.message}`, "error");
            return false;
        }
    }

    async function loadUserAddresses() {
        if (!currentUserSession || !currentUserSession.userId) {
             currentUserAddresses = []; return;
        }
        try {
            const response = await fetch(`${USER_DATA_API_URL}?action=get_addresses&user_id=${currentUserSession.userId}`);
            if (!response.ok) {
                 const errorData = await response.json().catch(() => ({ message: `HTTP error ${response.status}` }));
                throw new Error(errorData.message);
            }
            currentUserAddresses = await response.json();
            if (!Array.isArray(currentUserAddresses)) currentUserAddresses = [];
        } catch (error) {
            console.error('Errore caricamento indirizzi da API:', error);
            showFeedback(`Errore caricamento indirizzi: ${error.message}`, "error");
            currentUserAddresses = [];
        }
    }

    function setPersonalDataEditMode(isEditing) {
        const fullNameInput = userDataModalContent.querySelector('#user-contact-fullname');
        const emailInput = userDataModalContent.querySelector('#user-contact-email');
        const phoneInput = userDataModalContent.querySelector('#user-contact-phone');
        const editBtn = userDataModalContent.querySelector('#edit-personal-data-btn');
        const saveBtn = userDataModalContent.querySelector('#save-personal-data-btn');
        const cancelBtn = userDataModalContent.querySelector('#cancel-edit-personal-data-btn');

        if (!fullNameInput || !emailInput || !phoneInput || !editBtn || !saveBtn || !cancelBtn) return;

        if (isEditing) {
            originalPersonalData = {
                contactFullName: fullNameInput.value,
                contactEmail: emailInput.value,
                contactPhone: phoneInput.value
            };
            fullNameInput.readOnly = false; emailInput.readOnly = false; phoneInput.readOnly = false;
            saveBtn.disabled = true;
            fullNameInput.style.cursor = 'text'; emailInput.style.cursor = 'text'; phoneInput.style.cursor = 'text';
            editBtn.style.display = 'none'; saveBtn.style.display = 'inline-block'; cancelBtn.style.display = 'inline-block';
            [fullNameInput, emailInput, phoneInput].forEach(field => {
                field.removeEventListener('input', handlePersonalDataInputChange);
                field.addEventListener('input', handlePersonalDataInputChange);
            });
            fullNameInput.focus();
        } else {
            fullNameInput.readOnly = true; emailInput.readOnly = true; phoneInput.readOnly = true;
            fullNameInput.style.cursor = 'default'; emailInput.style.cursor = 'default'; phoneInput.style.cursor = 'default';
            editBtn.style.display = 'inline-block'; saveBtn.style.display = 'none'; cancelBtn.style.display = 'none';
            if (originalPersonalData) {
                fullNameInput.value = originalPersonalData.contactFullName;
                emailInput.value = originalPersonalData.contactEmail;
                phoneInput.value = originalPersonalData.contactPhone;
            }
            originalPersonalData = null;
        }
    }

    function handlePersonalDataInputChange() {
        const saveBtn = userDataModalContent.querySelector('#save-personal-data-btn');
        if (!saveBtn) return;
        const currentFullName = userDataModalContent.querySelector('#user-contact-fullname').value.trim();
        const currentEmail = userDataModalContent.querySelector('#user-contact-email').value.trim();
        const currentPhone = userDataModalContent.querySelector('#user-contact-phone').value.trim();

        let isContactEmailValid = true;
        if (currentEmail && !/\S+@\S+\.\S+/.test(currentEmail)) {
            isContactEmailValid = false;
        }

        let hasChanged = false;
        if (originalPersonalData) {
            hasChanged = currentFullName !== originalPersonalData.contactFullName ||
                         currentEmail !== originalPersonalData.contactEmail ||
                         currentPhone !== originalPersonalData.contactPhone;
        } else {
            hasChanged = !!currentFullName || !!currentEmail || !!currentPhone;
        }
        saveBtn.disabled = !(hasChanged && isContactEmailValid);
    }

    function renderUserDataModal() {
        if (!currentUserPersonalData) {
             showFeedback("Dati utente non disponibili.", "error"); return;
        }
        userDataModalContent.innerHTML = `
            <form id="personal-data-form"><h4>Informazioni di Contatto</h4>
                <div class="form-group">
                    <label for="user-contact-fullname"><i class="fas fa-fw fa-user"></i> Nome Completo (per spedizioni/contatto)</label>
                    <input type="text" id="user-contact-fullname" value="${currentUserPersonalData.contactFullName || ''}" readonly>
                </div>
                <div class="form-group">
                    <label for="user-contact-email"><i class="fas fa-fw fa-envelope"></i> Email di Contatto (per comunicazioni ordini)</label>
                    <input type="email" id="user-contact-email" value="${currentUserPersonalData.contactEmail || ''}" readonly>
                </div>
                <div class="form-group">
                    <label for="user-contact-phone"><i class="fas fa-fw fa-phone"></i> Numero di Telefono (per contatto)</label>
                    <input type="tel" id="user-contact-phone" value="${currentUserPersonalData.contactPhone || ''}" readonly>
                </div>
                <div class="form-actions" style="justify-content:flex-start;">
                    <button type="button" id="edit-personal-data-btn" class="btn-secondary"><i class="fas fa-edit"></i> Modifica Dati Contatto</button>
                    <button type="submit" id="save-personal-data-btn" class="btn-primary" style="display:none;"><i class="fas fa-save"></i> Salva Dati Contatto</button>
                    <button type="button" id="cancel-edit-personal-data-btn" class="btn-secondary" style="display:none;"><i class="fas fa-times"></i> Annulla Modifica</button>
                </div>
            </form>
            <hr style="margin: 30px 0;">
            <h4><i class="fas fa-fw fa-map-signs"></i> Indirizzi di Spedizione</h4>
            <div id="address-list-container"></div>
            <button id="open-add-new-address-modal-btn" class="btn-primary" style="margin-top:15px;"><i class="fas fa-plus"></i> Aggiungi Nuovo Indirizzo</button>
        `;
        renderAddressList();
        setupUserDataModalListeners();
        setPersonalDataEditMode(false);
    }

    function renderAddressList() {
        const container = userDataModalContent.querySelector('#address-list-container');
        if (!container) return;
        if (currentUserAddresses.length === 0) {
            container.innerHTML = "<p>Nessun indirizzo salvato.</p>"; return;
        }
        const ul = document.createElement('ul');
        ul.className = 'address-list';
        currentUserAddresses.forEach((addr) => {
            const li = document.createElement('li');
            li.className = 'address-item';
            li.dataset.addressId = addr.id;
            li.innerHTML = `
                <p>
                    ${addr.is_default ? '<span class="address-default-badge">Predefinito</span>' : ''}
                    ${addr.street}, ${addr.city}, ${addr.zip_code}
                </p>
                <div class="address-item-actions">
                    ${!addr.is_default ? `<button class="set-default-address-btn" data-address-id="${addr.id}" title="Imposta come predefinito"><i class="fas fa-star"></i></button>` : ''}
                    <button class="edit-address-btn" data-address-id="${addr.id}" title="Modifica indirizzo"><i class="fas fa-edit"></i></button>
                    <button class="delete-address-btn" data-address-id="${addr.id}" title="Elimina indirizzo"><i class="fas fa-trash-alt"></i></button>
                </div>`;
            ul.appendChild(li);
        });
        container.innerHTML = ''; container.appendChild(ul);
    }

    async function openUserDataModal() {
        if (!currentUserSession) {
            showFeedback("Devi essere loggato per modificare i tuoi dati.", "info");
            openAccountModal('login'); return;
        }
        if (!currentUserPersonalData || currentUserPersonalData.username !== currentUserSession.username) {
             await loadUserPersonalData();
        }
        if (currentUserAddresses.length === 0) { // Carica indirizzi solo se non già in cache
            await loadUserAddresses();
        }
        renderUserDataModal();
        toggleModal('user-data-modal', true);
        if (accountModal.classList.contains('active')) {
            toggleModal('account-modal', false);
        }
    }

    function openAddressFormModal(addressIdToEdit = null) {
        if (!currentUserSession) {
            showFeedback("Devi essere loggato per gestire gli indirizzi.", "info");
            openAccountModal('login'); return;
        }
        modalAddressForm.reset();
        const modalAddressIdField = modalAddressForm.querySelector('#modal-address-id');
        const modalSaveAddressBtn = modalAddressForm.querySelector('#modal-save-address-btn');
        modalSaveAddressBtn.disabled = true;
        const modalStreetField = modalAddressForm.querySelector('#modal-address-street');
        const modalCityField = modalAddressForm.querySelector('#modal-address-city');
        const modalZipField = modalAddressForm.querySelector('#modal-address-zip');

        if (addressIdToEdit) {
            const addrToEdit = currentUserAddresses.find(addr => String(addr.id) === String(addressIdToEdit));
            if (addrToEdit) {
                addressModalTitle.textContent = "Modifica Indirizzo";
                modalAddressIdField.value = addrToEdit.id;
                modalStreetField.value = addrToEdit.street;
                modalCityField.value = addrToEdit.city;
                modalZipField.value = addrToEdit.zip_code;
                originalAddressDataForModal = {
                    street: addrToEdit.street, city: addrToEdit.city, zip_code: addrToEdit.zip_code
                };
            } else {
                showFeedback("Indirizzo da modificare non trovato.", "error");
                originalAddressDataForModal = null; return;
            }
        } else {
            addressModalTitle.textContent = "Nuovo Indirizzo";
            modalAddressIdField.value = "";
            originalAddressDataForModal = { street: '', city: '', zip_code: '' };
        }
        if (userDataModal.classList.contains('active')) {
            addressFormModal.dataset.parentModal = 'user-data-modal';
        } else { delete addressFormModal.dataset.parentModal; }
        [modalStreetField, modalCityField, modalZipField].forEach(field => {
            field.removeEventListener('input', handleAddressInputChange);
            field.addEventListener('input', handleAddressInputChange);
        });
        toggleModal('address-form-modal', true);
        modalStreetField.focus();
    }

    function closeAddressFormModalAndReopenParent() {
        toggleModal('address-form-modal', false);
        if (addressFormModal.dataset.parentModal === 'user-data-modal') {
           setTimeout(() => toggleModal('user-data-modal', true), 100);
        }
    }

    function handleAddressInputChange() {
        const modalSaveAddressBtn = modalAddressForm.querySelector('#modal-save-address-btn');
        const currentStreet = modalAddressForm.querySelector('#modal-address-street').value.trim();
        const currentCity = modalAddressForm.querySelector('#modal-address-city').value.trim();
        const currentZip = modalAddressForm.querySelector('#modal-address-zip').value.trim();
        const allFieldsFilled = currentStreet && currentCity && currentZip;
        if (!allFieldsFilled) { modalSaveAddressBtn.disabled = true; return; }
        let hasChanged = false;
        if (originalAddressDataForModal) {
            hasChanged = currentStreet !== originalAddressDataForModal.street ||
                         currentCity !== originalAddressDataForModal.city ||
                         currentZip !== originalAddressDataForModal.zip_code;
        } else { hasChanged = allFieldsFilled; }
        modalSaveAddressBtn.disabled = !hasChanged;
    }

    function setupUserDataModalListeners() {
        const editPersonalDataBtn = userDataModalContent.querySelector('#edit-personal-data-btn');
        const cancelEditPersonalDataBtn = userDataModalContent.querySelector('#cancel-edit-personal-data-btn');
        if (editPersonalDataBtn) editPersonalDataBtn.addEventListener('click', () => setPersonalDataEditMode(true));
        if (cancelEditPersonalDataBtn) cancelEditPersonalDataBtn.addEventListener('click', () => setPersonalDataEditMode(false));

        const personalDataForm = userDataModalContent.querySelector('#personal-data-form');
        if (personalDataForm) {
            personalDataForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUserSession) {
                     showFeedback("Sessione scaduta o non valida. Effettua nuovamente il login.", "error"); return;
                }
                currentUserPersonalData.contactFullName = userDataModalContent.querySelector('#user-contact-fullname').value.trim();
                currentUserPersonalData.contactEmail = userDataModalContent.querySelector('#user-contact-email').value.trim();
                currentUserPersonalData.contactPhone = userDataModalContent.querySelector('#user-contact-phone').value.trim();

                if (currentUserPersonalData.contactEmail && !/\S+@\S+\.\S+/.test(currentUserPersonalData.contactEmail)) {
                    showFeedback("Formato email di contatto non valido.", "error");
                    return;
                }
                const success = await saveUserContactDataToAPI();
                if (success) { originalPersonalData = null; setPersonalDataEditMode(false); }
            });
        }
        const openAddNewAddressModalBtn = userDataModalContent.querySelector('#open-add-new-address-modal-btn');
        if (openAddNewAddressModalBtn) {
            openAddNewAddressModalBtn.addEventListener('click', () => openAddressFormModal(null));
        }
        const addressListContainer = userDataModalContent.querySelector('#address-list-container');
        if (addressListContainer) {
            addressListContainer.addEventListener('click', async (e) => {
                if (!currentUserSession) {
                    showFeedback("Sessione scaduta o non valida. Effettua nuovamente il login.", "error"); return;
                }
                const targetButton = e.target.closest('button');
                if (!targetButton) return;
                const addressId = targetButton.dataset.addressId;
                if (targetButton.classList.contains('edit-address-btn')) {
                    openAddressFormModal(addressId);
                } else if (targetButton.classList.contains('delete-address-btn')) {
                    if (confirm("Sei sicuro di voler eliminare questo indirizzo?")) {
                        try {
                            const response = await fetch(`${USER_DATA_API_URL}?action=delete_address&user_id=${currentUserSession.userId}&address_id=${addressId}`, {
                                method: 'DELETE'
                            });
                            const result = await response.json();
                            if (!response.ok) throw new Error(result.message || `HTTP error ${response.status}`);
                            showFeedback(result.message || "Indirizzo eliminato.", "info");
                            await loadUserAddresses(); renderAddressList();
                        } catch (error) {
                             console.error('Errore eliminazione indirizzo via API:', error);
                             showFeedback(`Errore eliminazione indirizzo: ${error.message}`, "error");
                        }
                    }
                } else if (targetButton.classList.contains('set-default-address-btn')) {
                     try {
                        const response = await fetch(`${USER_DATA_API_URL}?action=set_default_address&user_id=${currentUserSession.userId}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ address_id: parseInt(addressId) })
                        });
                        const result = await response.json();
                        if (!response.ok) throw new Error(result.message || `HTTP error ${response.status}`);
                        showFeedback(result.message || "Indirizzo predefinito aggiornato.", "success");
                        await loadUserAddresses(); renderAddressList();
                    } catch (error) {
                         console.error('Errore impostazione indirizzo predefinito via API:', error);
                         showFeedback(`Errore impostazione predefinito: ${error.message}`, "error");
                    }
                }
            });
        }
    }

    if (modalAddressForm) {
        modalAddressForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserSession) {
                showFeedback("Sessione scaduta o non valida. Effettua nuovamente il login.", "error"); return;
            }
            const addressId = modalAddressForm.querySelector('#modal-address-id').value;
            const payload = {
                street: modalAddressForm.querySelector('#modal-address-street').value.trim(),
                city: modalAddressForm.querySelector('#modal-address-city').value.trim(),
                zip_code: modalAddressForm.querySelector('#modal-address-zip').value.trim(),
            };
            if (addressId) payload.id = parseInt(addressId);
            if (!payload.street || !payload.city || !payload.zip_code) {
                showFeedback("Tutti i campi dell'indirizzo sono obbligatori.", "error"); return;
            }
            let url, method;
            if (addressId) {
                url = `${USER_DATA_API_URL}?action=update_address&user_id=${currentUserSession.userId}&address_id=${addressId}`;
                method = 'PUT';
            } else {
                url = `${USER_DATA_API_URL}?action=add_address&user_id=${currentUserSession.userId}`;
                method = 'POST';
            }
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (!response.ok && response.status !== 201) throw new Error(result.message || `HTTP error ${response.status}`);
                showFeedback(result.message || (addressId ? "Indirizzo aggiornato!" : "Indirizzo aggiunto!"), "success");
                await loadUserAddresses();
                if (userDataModalContent.querySelector('#address-list-container')) renderAddressList();
                closeAddressFormModalAndReopenParent();
            } catch (error) {
                console.error('Errore salvataggio indirizzo via API (modale):', error);
                showFeedback(`Errore salvataggio indirizzo: ${error.message}`, "error");
            }
        });
    }
    const modalCancelAddressBtn = document.getElementById('modal-cancel-address-btn');
    if (modalCancelAddressBtn) modalCancelAddressBtn.addEventListener('click', () => closeAddressFormModalAndReopenParent());

    // --- PROCEDURA DI CHECKOUT (ORDINI SU DB) ---
    let currentCheckoutStep = 1;
    const checkoutData = {};
    const shippingOptions = [
        { id: 'standard', name: 'Spedizione Standard (5-7 giorni)', cost: 5.00 },
        { id: 'express', name: 'Spedizione Express (2-3 giorni)', cost: 10.00 }
    ];

    async function openCheckoutModal() {
        if (cart.length === 0) {
            showFeedback("Il carrello è vuoto. Aggiungi prodotti prima di procedere.", "warning"); return;
        }
        if (!isUserLoggedIn()) { // Modificato per usare la nuova funzione di controllo
            showFeedback("Devi effettuare il login per procedere al checkout.", "info");
            openAccountModal('login'); return;
        }
        currentCheckoutStep = 1;
        checkoutData.items = JSON.parse(JSON.stringify(cart));
        checkoutData.subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);

        if (!currentUserPersonalData ||
            currentUserPersonalData.username !== currentUserSession.username ||
            currentUserPersonalData.loginEmail !== currentUserSession.email) {
             await loadUserPersonalData();
        }
        await loadUserAddresses();

        checkoutData.fullName = currentUserPersonalData.contactFullName || currentUserPersonalData.username || '';
        checkoutData.email = currentUserPersonalData.contactEmail || currentUserPersonalData.loginEmail || '';
        checkoutData.phone = currentUserPersonalData.contactPhone || '';

        const defaultAddress = currentUserAddresses.find(addr => addr.is_default) || (currentUserAddresses.length > 0 ? currentUserAddresses[0] : null);
        if (defaultAddress) {
            checkoutData.street = defaultAddress.street; checkoutData.city = defaultAddress.city; checkoutData.zip = defaultAddress.zip_code;
        } else { checkoutData.street = ''; checkoutData.city = ''; checkoutData.zip = ''; }

        renderCheckoutStep();
        toggleModal('checkout-modal', true);
        if (cartModal.classList.contains('active')) {
            toggleModal('cart-modal', false);
        }
    }

    function renderCheckoutStep() {
        let html = `
            <div class="checkout-steps">
                <div class="checkout-step-indicator ${currentCheckoutStep === 1 ? 'active' : (currentCheckoutStep > 1 ? 'completed' : '')}" data-step="1"><i class="fas fa-user-circle"></i> 1. Dati</div>
                <div class="checkout-step-indicator ${currentCheckoutStep === 2 ? 'active' : (currentCheckoutStep > 2 ? 'completed' : '')}" data-step="2"><i class="fas fa-truck"></i> 2. Spedizione</div>
                <div class="checkout-step-indicator ${currentCheckoutStep === 3 ? 'active' : (currentCheckoutStep > 3 ? 'completed' : '')}" data-step="3"><i class="fas fa-credit-card"></i> 3. Pagamento</div>
                <div class="checkout-step-indicator ${currentCheckoutStep === 4 ? 'active' : ''}" data-step="4"><i class="fas fa-clipboard-check"></i> 4. Riepilogo</div>
            </div>
            <form id="checkout-form"><div id="checkout-steps-container">`;
        html += `
            <div class="checkout-step ${currentCheckoutStep === 1 ? 'active' : ''}" data-step="1">
                <h4><i class="fas fa-user-edit"></i> Dati di Spedizione e Contatto</h4>
                <div class="form-group"><label for="chk-fullname"><i class="fas fa-fw fa-user"></i> Nome Completo</label><input type="text" id="chk-fullname" value="${checkoutData.fullName || ''}" required></div>
                <div class="form-group"><label for="chk-street"><i class="fas fa-fw fa-map-marker-alt"></i> Indirizzo (Via, N°)</label><input type="text" id="chk-street" value="${checkoutData.street || ''}" required></div>
                <div class="form-group"><label for="chk-city"><i class="fas fa-fw fa-city"></i> Città</label><input type="text" id="chk-city" value="${checkoutData.city || ''}" required></div>
                <div class="form-group"><label for="chk-zip"><i class="fas fa-fw fa-mail-bulk"></i> CAP</label><input type="text" id="chk-zip" value="${checkoutData.zip || ''}" pattern="[0-9]{5}" required></div>
                <div class="form-group"><label for="chk-email"><i class="fas fa-fw fa-envelope"></i> Email (per comunicazioni ordine)</label><input type="email" id="chk-email" value="${checkoutData.email || ''}" required></div>
                <div class="form-group"><label for="chk-phone"><i class="fas fa-fw fa-phone"></i> Telefono</label><input type="tel" id="chk-phone" value="${checkoutData.phone || ''}"></div>
            </div>
            <div class="checkout-step ${currentCheckoutStep === 2 ? 'active' : ''}" data-step="2">
                <h4>Metodo di Spedizione</h4>
                <div id="shipping-methods">
                    ${shippingOptions.map(opt => `
                        <div class="form-group">
                            <input type="radio" name="shipping_method" id="ship-${opt.id}" value="${opt.id}" ${checkoutData.shippingMethod === opt.id ? 'checked' : ''} required>
                            <label for="ship-${opt.id}"><i class="fas fa-fw ${opt.id === 'express' ? 'fa-rocket' : 'fa-truck'}"></i> ${opt.name} <span class="shipping-cost">(+${formatPrice(opt.cost)})</span></label>
                        </div>`).join('')}
                </div>
            </div>
            <div class="checkout-step ${currentCheckoutStep === 3 ? 'active' : ''}" data-step="3">
                <h4>Metodo di Pagamento</h4>
                <div id="payment-methods">
                    <div class="form-group">
                        <input type="radio" name="payment_method" id="pay-cc" value="credit_card" ${checkoutData.paymentMethod === 'credit_card' ? 'checked' : ''} required>
                        <label for="pay-cc"><i class="fas fa-fw fa-credit-card"></i> Carta di Credito</label>
                    </div>
                    <div id="credit-card-details" style="${checkoutData.paymentMethod === 'credit_card' ? 'display:block;' : 'display:none;'}">
                        <div class="form-group"><label for="cc-number"><i class="fas fa-fw fa-credit-card"></i> Numero Carta</label><input type="text" id="cc-number" placeholder="xxxx xxxx xxxx xxxx" pattern="[0-9]{13,19}"></div>
                        <div class="form-group"><label for="cc-expiry"><i class="fas fa-fw fa-calendar-alt"></i> Scadenza (MM/AA)</label><input type="text" id="cc-expiry" placeholder="MM/AA" pattern="(0[1-9]|1[0-2])\/([0-9]{2})"></div>
                        <div class="form-group"><label for="cc-cvv"><i class="fas fa-fw fa-lock"></i> CVV</label><input type="text" id="cc-cvv" pattern="[0-9]{3,4}"></div>
                    </div>
                    <div class="form-group">
                         <input type="radio" name="payment_method" id="pay-paypal" value="paypal" ${checkoutData.paymentMethod === 'paypal' ? 'checked' : ''}>
                         <label for="pay-paypal"><i class="fab fa-fw fa-paypal"></i> PayPal <span class="payment-info">(Verrai reindirizzato)</span></label>
                    </div>
                    <div class="form-group">
                         <input type="radio" name="payment_method" id="pay-transfer" value="bank_transfer" ${checkoutData.paymentMethod === 'bank_transfer' ? 'checked' : ''}>
                         <label for="pay-transfer"><i class="fas fa-fw fa-university"></i> Bonifico Bancario <span class="payment-info">(Dettagli dopo conferma)</span></label>
                    </div>
                </div>
            </div>`;
        if (currentCheckoutStep === 4) {
            const selectedShipping = shippingOptions.find(opt => opt.id === checkoutData.shippingMethod);
            const shippingCost = selectedShipping ? selectedShipping.cost : 0;
            const totalAmount = checkoutData.subtotal + shippingCost;
            checkoutData.shippingCost = shippingCost; checkoutData.totalAmount = totalAmount;
        }
        html += `
            <div class="checkout-step ${currentCheckoutStep === 4 ? 'active' : ''}" data-step="4">
                <h4>Riepilogo Ordine</h4>
                <div class="order-summary-section"><h4><i class="fas fa-user-circle"></i> Dati Cliente:</h4>
                    <p><i class="fas fa-fw fa-user"></i> <strong>Nome:</strong> ${checkoutData.fullName}</p>
                    <p><i class="fas fa-fw fa-map-marked-alt"></i> <strong>Indirizzo:</strong> ${checkoutData.street}, ${checkoutData.city} ${checkoutData.zip}</p>
                    <p><i class="fas fa-fw fa-envelope"></i> <strong>Email:</strong> ${checkoutData.email}</p>
                    <p><i class="fas fa-fw fa-phone"></i> <strong>Telefono:</strong> ${checkoutData.phone || 'N/D'}</p>
                </div>
                 <div class="order-summary-section"><h4><i class="fas fa-shipping-fast"></i> Spedizione:</h4>
                    <p><i class="fas fa-fw ${checkoutData.shippingMethod === 'express' ? 'fa-rocket' : 'fa-truck'}"></i>
                        ${(shippingOptions.find(s => s.id === checkoutData.shippingMethod) || {}).name || 'Non selezionata'}
                        ${checkoutData.shippingCost !== undefined ? ` (+${formatPrice(checkoutData.shippingCost)})` : ''}
                    </p>
                </div>
                <div class="order-summary-section"><h4><i class="fas fa-money-check-alt"></i> Pagamento:</h4>
                    <p><i class="fas fa-fw ${checkoutData.paymentMethod === 'credit_card' ? 'fa-credit-card' : (checkoutData.paymentMethod === 'paypal' ? 'fa-paypal fab' : 'fa-university')}"></i> ${checkoutData.paymentMethod === 'credit_card' ? 'Carta di Credito' : (checkoutData.paymentMethod === 'paypal' ? 'PayPal' : 'Bonifico Bancario')}</p>
                </div>
                 <div class="order-summary-section"><h4><i class="fas fa-shopping-basket"></i> Articoli:</h4>
                    <div class="summary-item-list">
                    ${checkoutData.items.map(item => `
                        <div class="summary-product" style="align-items: center;">
                            <img src="${item.imageSmall || 'https://via.placeholder.com/40'}" alt="${item.name}" class="summary-product-image">
                            <div style="flex-grow: 1; display: flex; flex-direction: column;">
                                ${item.name} (x${item.quantity})
                                ${ (item.size && item.size !== 'Unica') || (item.color && item.color !== 'Unico') ?
                                    `<small style="font-size: 0.8rem; color: var(--dark-gray); margin-top: 2px;">
                                        ${item.size && item.size !== 'Unica' ? `Taglia: ${item.size}` : ''}
                                        ${(item.size && item.size !== 'Unica') && (item.color && item.color !== 'Unico') ? ' &bull; ' : ''}
                                        ${item.color && item.color !== 'Unico' ? `Colore: ${item.color}` : ''}
                                    </small>` : ''
                                }
                            </div>
                            <span>${formatPrice(item.price * item.quantity)}</span>
                        </div>`).join('')}
                    </div> <!-- Chiusura di .summary-item-list -->
                </div> <!-- Chiusura di .order-summary-section per gli articoli -->

                <!-- INIZIO BLOCCO TOTALI AGGIUNTO -->
                <div class="order-summary-totals" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--light-gray);">
                    <div class="summary-total-line" style="margin-top:0;"><span><i class="fas fa-fw fa-receipt"></i> Subtotale:</span><span>${formatPrice(checkoutData.subtotal)}</span></div>
                    <div class="summary-total-line"><span><i class="fas fa-fw fa-truck"></i> Spedizione:</span><span>${formatPrice(checkoutData.shippingCost)}</span></div>
                    <div class="summary-total-line grand-total"><span><i class="fas fa-fw fa-euro-sign"></i> TOTALE ORDINE:</span><span>${formatPrice(checkoutData.totalAmount)}</span></div>
                </div>
                <!-- FINE BLOCCO TOTALI AGGIUNTO -->

            </div> <!-- Chiusura di .checkout-step[data-step="4"] -->
        </div>`; // Chiusura di #checkout-steps-container

        html += `<div class="form-actions" style="justify-content: space-between; margin-top:30px;">`;
        if (currentCheckoutStep > 1) {
            html += `<button type="button" id="checkout-prev-btn" class="btn-secondary"><i class="fas fa-chevron-left"></i> Indietro</button>`;
        } else { html += `<div></div>`; }
        if (currentCheckoutStep < 4) {
            html += `<button type="button" id="checkout-next-btn" class="btn-primary">Avanti <i class="fas fa-chevron-right"></i></button>`;
        } else {
            html += `<button type="button" id="checkout-confirm-btn" class="btn-primary"><i class="fas fa-check-circle"></i> Conferma Ordine</button>`;
        }
        html += `</div></form>`;
        checkoutModalContent.innerHTML = html;
        setupCheckoutListeners();
    }

    function setupCheckoutListeners() {
        const nextBtn = checkoutModalContent.querySelector('#checkout-next-btn');
        const prevBtn = checkoutModalContent.querySelector('#checkout-prev-btn');
        const confirmBtn = checkoutModalContent.querySelector('#checkout-confirm-btn');

        if (nextBtn) nextBtn.addEventListener('click', () => {
            if (validateCheckoutStep()) {
                const currentStepEl = checkoutModalContent.querySelector(`.checkout-step[data-step="${currentCheckoutStep}"]`);
                currentCheckoutStep++;
                if(currentStepEl) currentStepEl.classList.add('slide-out-left');
                setTimeout(() => {
                    document.querySelectorAll('#checkout-steps-container .checkout-step').forEach(step => {
                       step.classList.remove('active', 'slide-in-left', 'slide-in-right', 'slide-out-left', 'slide-out-right');
                    });
                    renderCheckoutStep();
                    const newStepEl = checkoutModalContent.querySelector(`.checkout-step[data-step="${currentCheckoutStep}"]`);
                    if(newStepEl) newStepEl.classList.add('slide-in-right');
                }, 300);
            }
        });
        if (prevBtn) prevBtn.addEventListener('click', () => {
            const currentStepEl = checkoutModalContent.querySelector(`.checkout-step[data-step="${currentCheckoutStep}"]`);
            currentCheckoutStep--;
            if(currentStepEl) currentStepEl.classList.add('slide-out-right');
            setTimeout(() => {
                document.querySelectorAll('#checkout-steps-container .checkout-step').forEach(step => {
                    step.classList.remove('active', 'slide-in-left', 'slide-in-right', 'slide-out-left', 'slide-out-right');
                });
                renderCheckoutStep();
                const newStepEl = checkoutModalContent.querySelector(`.checkout-step[data-step="${currentCheckoutStep}"]`);
                if(newStepEl) newStepEl.classList.add('slide-in-left');
            }, 300);
        });
        if (confirmBtn) confirmBtn.addEventListener('click', confirmOrderAndSaveToDB);
        const paymentRadios = checkoutModalContent.querySelectorAll('input[name="payment_method"]');
        paymentRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                const ccDetailsDiv = checkoutModalContent.querySelector('#credit-card-details');
                if (ccDetailsDiv) ccDetailsDiv.style.display = (e.target.value === 'credit_card') ? 'block' : 'none';
            });
        });
    }

    function validateCheckoutStep() {
        let isValid = true;
        if (currentCheckoutStep === 1) {
            ['#chk-fullname', '#chk-street', '#chk-city', '#chk-zip', '#chk-email'].forEach(id => {
                const input = checkoutModalContent.querySelector(id);
                if (!input || !input.value.trim() || (input.pattern && !new RegExp(input.pattern).test(input.value))) {
                    isValid = false; if(input) input.style.borderColor = 'var(--accent-color)';
                } else { if(input) input.style.borderColor = '#ccc'; }
            });
            if(isValid) {
                checkoutData.fullName = checkoutModalContent.querySelector('#chk-fullname').value.trim();
                checkoutData.street = checkoutModalContent.querySelector('#chk-street').value.trim();
                checkoutData.city = checkoutModalContent.querySelector('#chk-city').value.trim();
                checkoutData.zip = checkoutModalContent.querySelector('#chk-zip').value.trim();
                checkoutData.email = checkoutModalContent.querySelector('#chk-email').value.trim();
                checkoutData.phone = checkoutModalContent.querySelector('#chk-phone').value.trim();
            } else { showFeedback("Compila tutti i campi dati correttamente.", "warning"); }
        } else if (currentCheckoutStep === 2) {
            const selectedShipping = checkoutModalContent.querySelector('input[name="shipping_method"]:checked');
            if (!selectedShipping) { isValid = false; showFeedback("Seleziona un metodo di spedizione.", "warning");
            } else { checkoutData.shippingMethod = selectedShipping.value; }
        } else if (currentCheckoutStep === 3) {
            const selectedPayment = checkoutModalContent.querySelector('input[name="payment_method"]:checked');
            if (!selectedPayment) { isValid = false; showFeedback("Seleziona un metodo di pagamento.", "warning");
            } else {
                checkoutData.paymentMethod = selectedPayment.value;
                if (checkoutData.paymentMethod === 'credit_card') {
                    checkoutData.cardDetails = {};
                     ['#cc-number', '#cc-expiry', '#cc-cvv'].forEach(id => {
                        const input = checkoutModalContent.querySelector(id);
                         if (!input || !input.value.trim() || (input.pattern && !new RegExp(input.pattern).test(input.value))) {
                             isValid = false; if(input) input.style.borderColor = 'var(--accent-color)';
                         } else { if(input) input.style.borderColor = '#ccc'; }
                     });
                     if (!isValid) showFeedback("Compila correttamente i dati della carta.", "warning");
                }
            }
        }
        return isValid;
    }

    function setButtonLoadingState(button, isLoading, originalHTML = null) {
        if (!button) return;

        if (isLoading) {
            if (originalHTML) {
                button.dataset.originalHTML = originalHTML;
            } else if (!button.dataset.originalHTML) {
                button.dataset.originalHTML = button.innerHTML;
            }
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Elaborazione...';
            button.disabled = true;
        } else {
            if (button.dataset.originalHTML) {
                button.innerHTML = button.dataset.originalHTML;
            }
            button.disabled = false;
        }
    }

   
       async function confirmOrderAndSaveToDB() {
        const confirmBtn = checkoutModalContent.querySelector('#checkout-confirm-btn'); // <<--- AGGIUNTO: Seleziona il pulsante
        const originalButtonHTML = confirmBtn ? confirmBtn.innerHTML : ''; // <<--- AGGIUNTO: Salva HTML originale

        if (!isUserLoggedIn() || !currentUserSession || !currentUserSession.userId) {
            showFeedback("Errore: sessione utente non valida. Effettua il login.", "error");
            return;
        }

        // <<--- INIZIO: Modifica per stato di loading ---
        if (confirmBtn) {
            setButtonLoadingState(confirmBtn, true); // Usa la funzione helper esistente
        }
        // <<--- FINE: Modifica per stato di loading ---

        const numericOrderId = generateNumericOrderIdFrontend();
        const orderPayload = {
            userId: currentUserSession.userId,
            numericOrderId: numericOrderId,
            ...checkoutData
        };
        delete orderPayload.cardDetails; // Rimuoviamo i dettagli della carta se presenti, non vanno al DB

        try {
            const response = await fetch(`${ORDERS_API_URL}?action=create_order`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderPayload)
            });
            const result = await response.json();

            if (!response.ok && response.status !== 201) {
                throw new Error(result.message || `Errore HTTP ${response.status} durante la creazione dell'ordine.`);
            }

            cart = [];
            saveCartToStorage();
            const displayOrderId = `#${String(numericOrderId).padStart(4, '0')}`;
            userOrdersCache = []; // Svuota la cache degli ordini perché è stato aggiunto uno nuovo

            if (checkoutData.paymentMethod === 'paypal') {
                showFeedback(`Ordine ${displayOrderId} registrato! Stai per essere reindirizzato a PayPal per il pagamento...`, "success", 4000);
                toggleModal('checkout-modal', false);
                currentCheckoutStep = 1; // Resetta lo step del checkout
                // NOTA: Non ripristiniamo il pulsante qui perché la pagina viene reindirizzata
                const shippingAddressForPayPal = {
                    street: checkoutData.street,
                    city: checkoutData.city,
                    zip: checkoutData.zip
                };
                redirectToPayPal(displayOrderId, orderPayload.totalAmount, shippingAddressForPayPal);

            } else {
                showFeedback(`Ordine ${displayOrderId} confermato con successo! Grazie per il tuo acquisto.`, "success", 5000);
                toggleModal('checkout-modal', false);
                currentCheckoutStep = 1; // Resetta lo step del checkout
                if (confirmBtn) { // <<--- AGGIUNTO: Ripristina il pulsante
                    setButtonLoadingState(confirmBtn, false, originalButtonHTML);
                }
            }

        } catch (error) {
            console.error('Errore API creazione ordine:', error);
            showFeedback(`Errore durante la conferma dell'ordine: ${error.message}`, "error");
            if (confirmBtn) { // <<--- AGGIUNTO: Ripristina il pulsante anche in caso di errore
                setButtonLoadingState(confirmBtn, false, originalButtonHTML);
            }
        }
    }
   
   
   
   function redirectToPayPal(orderNumericId, totalAmount, shippingAddress) {
        const paypalUrl = new URL('https://www.paypal.com/cgi-bin/webscr');
        paypalUrl.searchParams.append('cmd', '_xclick');
        paypalUrl.searchParams.append('business', 'tribal1983@libero.it'); // EMAIL REALE PAYPAL BUSINESS
        paypalUrl.searchParams.append('item_name', `Ordine ${orderNumericId}`);
        paypalUrl.searchParams.append('amount', parseFloat(totalAmount).toFixed(2));
        paypalUrl.searchParams.append('currency_code', 'EUR');
        paypalUrl.searchParams.append('invoice', orderNumericId.replace(/^#/, ''));
        paypalUrl.searchParams.append('return', window.location.href + '?payment_status=success&order_id=' + orderNumericId.replace(/^#/, ''));
        paypalUrl.searchParams.append('cancel_return', window.location.href + '?payment_status=cancelled&order_id=' + orderNumericId.replace(/^#/, ''));

        if (shippingAddress) {
            paypalUrl.searchParams.append('address_override', '1');
            paypalUrl.searchParams.append('no_shipping', '1'); // Se l'indirizzo è già raccolto e non deve essere modificato su PayPal

            let address1 = shippingAddress.street || '';

            if (address1) paypalUrl.searchParams.append('address1', address1);
            if (shippingAddress.city) paypalUrl.searchParams.append('city', shippingAddress.city);
            if (shippingAddress.zip) paypalUrl.searchParams.append('zip', shippingAddress.zip);
            paypalUrl.searchParams.append('country', 'IT'); // Codice paese ISO
        }

        console.log("PayPal URL with address attempt:", paypalUrl.toString());
        setTimeout(() => { window.open(paypalUrl.toString(), '_self'); }, 2000);
    }


    // --- GESTIONE ORDINI (con API) ---
    let userOrdersIntervals = {};

    async function openOrdersHistoryModal() {
        if (!isUserLoggedIn()) { // Modificato
            showFeedback("Devi essere loggato per vedere lo storico ordini.", "info"); return;
        }
        await renderOrdersHistory();
        toggleModal('orders-history-modal', true);
        if (accountModal.classList.contains('active')) {
            toggleModal('account-modal', false);
        }
        setupOrderSearchDebounce();
    }

    function setupOrderSearchDebounce() {
        const searchInput = ordersHistoryModalContent.querySelector('#order-search-input');
        if (searchInput) {
            const clone = searchInput.cloneNode(true);
            searchInput.parentNode.replaceChild(clone, searchInput);
            let debounceTimeout;
            clone.addEventListener('input', (e) => {
                const searchValue = e.target.value.trim();
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(() => { renderOrdersHistory(searchValue); }, 300);
            });
        }
    }

    async function fetchUserOrdersFromAPI() {
        if (!isUserLoggedIn() || !currentUserSession || !currentUserSession.userId) return [];
        try {
            const response = await fetch(`${ORDERS_API_URL}?action=get_orders&user_id=${currentUserSession.userId}`);
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: `HTTP error ${response.status}` }));
                throw new Error(errorData.message);
            }
            userOrdersCache = await response.json();
            return userOrdersCache;
        } catch (error) {
            console.error('Errore caricamento ordini da API:', error);
            showFeedback(`Errore caricamento ordini: ${error.message}`, "error");
            return [];
        }
    }

    async function renderOrdersHistory(searchTerm = '') {
        if (!isUserLoggedIn() || !currentUserSession || !currentUserSession.userId) {
            ordersHistoryModalContent.innerHTML = `<p class="empty-message">Impossibile caricare gli ordini (sessione non valida).</p>`; return;
        }
        let ordersToDisplay = [];
        if (searchTerm || userOrdersCache.length === 0) {
            await fetchUserOrdersFromAPI();
        }
        ordersToDisplay = [...userOrdersCache];

        const cleanSearchTerm = searchTerm.replace(/^#/, '').toLowerCase();
        if (searchTerm) {
            ordersToDisplay = ordersToDisplay.filter(order =>
                String(order.numeric_order_id).toLowerCase().includes(cleanSearchTerm) ||
                String(order.id).toLowerCase().includes(cleanSearchTerm)
            );
        }
        const searchInput = ordersHistoryModalContent.querySelector('#order-search-input');
        const cursorPosition = searchInput?.selectionStart || 0;
        let html = `
            <div class="form-group">
                <div style="position: relative;">
                    <i class="fas fa-search" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--dark-gray);"></i>
                    <input type="text" id="order-search-input" placeholder="Cerca per ID ordine (es. #1234 o 1234)..." value="${searchTerm}" style="padding-left: 40px;">
                </div>
            </div>
            <ul class="orders-list">`;
        if (ordersToDisplay.length === 0) {
            html += `<p class="empty-message">${searchTerm ? 'Nessun ordine trovato per la ricerca.' : 'Non hai ancora effettuato ordini.'}</p>`;
        } else {
            const now = Date.now();
            ordersToDisplay.forEach(order => {
                const orderDate = new Date(order.order_date);
                const displayOrderId = `#${String(order.numeric_order_id).padStart(4, '0')}`;
                let isOrderCancellable = false;
                let timeLeftForCancellationMs = 0;
                if (order.status === 'processing' || order.status === 'pending_payment') {
                    const timeSinceOrder = now - orderDate.getTime();
                    if (timeSinceOrder < ORDER_CANCELLATION_WINDOW_MS) {
                        isOrderCancellable = true;
                        timeLeftForCancellationMs = ORDER_CANCELLATION_WINDOW_MS - timeSinceOrder;
                    }
                }
                const isPayPalPending = order.payment_method === 'paypal' && order.status === 'pending_payment';

                html += `
                    <li class="order-item">
                        <div class="order-info order-main-details">
                            <span><i class="fas fa-fw fa-hashtag"></i> <strong>ID Ordine:</strong> ${displayOrderId}</span>
                            <span><i class="fas fa-fw fa-calendar-alt"></i> <strong>Data:</strong> ${orderDate.toLocaleDateString('it-IT')} ${orderDate.toLocaleTimeString('it-IT')}</span>
                        </div>
                        <div class="order-info">
                            <span><i class="fas fa-fw fa-euro-sign"></i> <strong>Totale:</strong> ${formatPrice(order.total_amount)}</span>
                             <span class="order-status-label order-status-${order.status.toLowerCase()}">
                                ${getOrderStatusText(order.status)} <i class="${getOrderStatusIcon(order.status)}"></i>
                                ${isPayPalPending ? '<span class="order-status-note">(Non Pagato)</span>' : ''}
                             </span>
                        </div>
                        <div class="order-item-actions">
                            <button class="btn-primary view-order-detail-btn" data-order-id="${order.id}"><i class="fas fa-eye"></i> Dettagli</button>
                        </div>
                        ${(isOrderCancellable || isPayPalPending) ? `
                        <div class="order-actions-extra" data-order-id="${order.id}">
                            ${isOrderCancellable ? `
                                <button class="btn-danger cancel-order-list-btn" data-order-id="${order.id}">
                                    <i class="fas fa-ban"></i> Annulla Ordine
                                </button>
                                <span class="cancel-order-timer-list" data-order-id="${order.id}" data-time-left="${timeLeftForCancellationMs}"><i class="fas fa-fw fa-clock"></i> </span>
                            ` : ''}
                            ${isPayPalPending ? `
                                <button class="btn-warning pay-now-btn" data-order-id="${order.id}" data-order-numeric-id="${order.numeric_order_id}" data-total-amount="${order.total_amount}">
                                    <i class="fab fa-paypal"></i> Paga Adesso
                                </button>
                            ` : ''}
                        </div>` : ''}
                    </li>`;
            });
        }
        html += `</ul>`;
        ordersHistoryModalContent.innerHTML = html;
        setupOrdersHistoryListeners();
        updateOrderListTimers();
        const newSearchInput = ordersHistoryModalContent.querySelector('#order-search-input');
        if (newSearchInput) {
            newSearchInput.focus();
            try { newSearchInput.setSelectionRange(cursorPosition, cursorPosition); } catch (e) { /* ignore */ }
        }
    }

    function updateOrderListTimers() {
        clearAllOrderListTimers();
        const timerElements = ordersHistoryModalContent.querySelectorAll('.cancel-order-timer-list');
        timerElements.forEach(timerEl => {
            const orderId = timerEl.dataset.orderId;
            let timeLeft = parseInt(timerEl.dataset.timeLeft);
            function updateDisplay() {
                if (timeLeft <= 0) {
                    timerEl.textContent = "Tempo scaduto per l'annullamento.";
                    const cancelButtonContainer = ordersHistoryModalContent.querySelector(`.order-actions-extra[data-order-id="${orderId}"]`);
                    const cancelButton = cancelButtonContainer?.querySelector('.cancel-order-list-btn');
                    if (cancelButton) cancelButton.style.display = 'none';
                    if (listOrderTimers[orderId]) { clearInterval(listOrderTimers[orderId]); delete listOrderTimers[orderId]; }
                } else {
                    const minutes = Math.floor(timeLeft / (60 * 1000));
                    const seconds = Math.floor((timeLeft % (60 * 1000)) / 1000);
                    timerEl.innerHTML = `<i class="fas fa-fw fa-clock"></i> Tempo rimanente: ${minutes} min ${seconds} sec`;
                }
            }
            updateDisplay();
            if (timeLeft > 0) {
                listOrderTimers[orderId] = setInterval(() => { timeLeft -= 1000; updateDisplay(); }, 1000);
            }
        });
    }

    function clearAllOrderListTimers() {
        Object.values(listOrderTimers).forEach(clearInterval); listOrderTimers = {};
    }

    function getOrderStatusText(status) {
        const map = {
            processing: "In Elaborazione",
            shipped: "Spedito",
            delivered: "Consegnato",
            cancelled: "Annullato",
            pending_payment: "In Attesa di Pagamento"
        };
        return map[status.toLowerCase()] || status;
    }
    function getOrderStatusIcon(status) {
         const map = {
            processing: "fas fa-cogs",
            shipped: "fas fa-shipping-fast",
            delivered: "fas fa-check-double",
            cancelled: "fas fa-times-circle",
            pending_payment: "fas fa-hourglass-half"
        };
        return map[status.toLowerCase()] || "fas fa-question-circle";
    }

    function setupOrdersHistoryListeners() {
        const searchInput = ordersHistoryModalContent.querySelector('#order-search-input');
        if (searchInput) {
            let debounceTimeout;
            searchInput.addEventListener('input', (e) => {
                const searchValue = e.target.value.trim();
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(() => { renderOrdersHistory(searchValue); }, 300);
            });
        }
        ordersHistoryModalContent.querySelectorAll('.view-order-detail-btn').forEach(btn => {
            btn.addEventListener('click', (e) => openOrderDetailModal(e.currentTarget.dataset.orderId));
        });
        ordersHistoryModalContent.querySelectorAll('.cancel-order-list-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                showConfirmCancelOrderModal(e.currentTarget.dataset.orderId);
            });
        });
        ordersHistoryModalContent.querySelectorAll('.pay-now-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const payNowButton = e.currentTarget;
                const originalButtonHTML = payNowButton.innerHTML;
                setButtonLoadingState(payNowButton, true);

                const orderId = payNowButton.dataset.orderId;
                const orderNumericId = payNowButton.dataset.orderNumericId;
                const totalAmount = payNowButton.dataset.totalAmount;

                let orderDetails = userOrdersCache.find(o => String(o.id) === orderId);
                if (!orderDetails || !orderDetails.shipping_street) {
                    try {
                        const response = await fetch(`${ORDERS_API_URL}?action=get_order_detail&user_id=${currentUserSession.userId}&order_id=${orderId}`);
                        if (!response.ok) throw new Error("Impossibile recuperare dettagli ordine per pagamento.");
                        orderDetails = await response.json();
                    } catch (err) {
                        showFeedback(err.message, "error");
                        setButtonLoadingState(payNowButton, false, originalButtonHTML);
                        return;
                    }
                }

                if (orderDetails && orderDetails.shipping_street) {
                    const shippingAddressForPayPal = {
                        street: orderDetails.shipping_street,
                        city: orderDetails.shipping_city,
                        zip: orderDetails.shipping_zip_code
                    };
                    redirectToPayPal(`#${String(orderNumericId).padStart(4, '0')}`, totalAmount, shippingAddressForPayPal);
                    // Non resettare il loader qui perché la pagina verrà reindirizzata
                } else {
                    showFeedback("Indirizzo di spedizione non trovato per questo ordine.", "error");
                    setButtonLoadingState(payNowButton, false, originalButtonHTML);
                }
            });
        });
    }

    async function openOrderDetailModal(dbOrderId) {
        if (!isUserLoggedIn() || !currentUserSession || !currentUserSession.userId) {
            showFeedback("Sessione utente non valida per visualizzare i dettagli ordine.", "error"); return;
        }
        try {
            const response = await fetch(`${ORDERS_API_URL}?action=get_order_detail&user_id=${currentUserSession.userId}&order_id=${dbOrderId}`);
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: `HTTP error ${response.status}` }));
                throw new Error(errorData.message);
            }
            const order = await response.json();
            if (!order || !order.id) { showFeedback("Dettagli ordine non trovati.", "error"); return; }
            orderDetailModal.dataset.currentOrderId = order.id;
            const orderDate = new Date(order.order_date);
            const displayOrderId = `#${String(order.numeric_order_id).padStart(4, '0')}`;

            let cancellable = (order.status === 'processing' || order.status === 'pending_payment') &&
                              (Date.now() - orderDate.getTime()) < ORDER_CANCELLATION_WINDOW_MS;
            let timeLeftForCancellation = ORDER_CANCELLATION_WINDOW_MS - (Date.now() - orderDate.getTime());
            const isPayPalPendingDetail = order.payment_method === 'paypal' && order.status === 'pending_payment';

            orderDetailModalContent.innerHTML = `
                <p><i class="fas fa-fw fa-hashtag"></i> <strong>ID Ordine:</strong> ${displayOrderId} (DB ID: ${order.id})</p>
                <p><i class="fas fa-fw fa-calendar-alt"></i> <strong>Data Ordine:</strong> ${orderDate.toLocaleDateString('it-IT')} ${orderDate.toLocaleTimeString('it-IT')}</p>
                <p><i class="fas fa-fw fa-info-circle"></i> <strong>Stato Ordine:</strong>
                    <span class="order-status-label order-status-${order.status.toLowerCase()}">
                        ${getOrderStatusText(order.status)} <i class="${getOrderStatusIcon(order.status)}"></i>
                        ${isPayPalPendingDetail ? '<span class="order-status-note">(Non Pagato)</span>' : ''}
                    </span>
                </p>
                <div id="order-detail-sections">
                    <div class="detail-section"><h4><i class="fas fa-user-circle"></i> Informazioni Cliente</h4>
                        <p><i class="fas fa-fw fa-user"></i> <strong>Nome:</strong> ${order.full_name}</p>
                        <p><i class="fas fa-fw fa-map-marked-alt"></i> <strong>Indirizzo:</strong> ${order.shipping_street}, ${order.shipping_city} ${order.shipping_zip_code}</p>
                        <p><i class="fas fa-fw fa-envelope"></i> <strong>Email:</strong> ${order.email}</p>
                        <p><i class="fas fa-fw fa-phone"></i> <strong>Telefono:</strong> ${order.phone || 'N/D'}</p>
                    </div>
                    <div class="detail-section"><h4><i class="fas fa-shipping-fast"></i> Informazioni Spedizione</h4>
                         <p><i class="fas fa-fw fa-truck-loading"></i> <strong>Metodo:</strong> ${(shippingOptions.find(s => s.id === order.shipping_method) || {}).name || order.shipping_method}</p>
                         <p><i class="fas fa-fw fa-coins"></i> <strong>Costo:</strong> ${formatPrice(order.shipping_cost)}</p>
                    </div>
                     <div class="detail-section"><h4><i class="fas fa-credit-card"></i> Informazioni Pagamento</h4>
                        <p><i class="fas fa-fw ${order.payment_method === 'credit_card' ? 'fa-credit-card' : (order.payment_method === 'paypal' ? 'fa-paypal fab' : 'fa-university')}"></i> <strong>Metodo:</strong> ${order.payment_method === 'credit_card' ? 'Carta di Credito' : (order.payment_method === 'paypal' ? 'PayPal' : 'Bonifico Bancario')}</p>
                    </div>
                    <div class="detail-section"><h4><i class="fas fa-boxes"></i> Articoli Ordinati</h4>
                        <div id="order-detail-items-list">
                        ${(order.items && Array.isArray(order.items)) ? order.items.map(item => `
                            <div class="product">
                                <span> <img src="${item.imageSmall || 'https://via.placeholder.com/30x30'}" alt="${item.product_name}" style="width:30px; height:30px; object-fit:contain; margin-right:5px; vertical-align:middle;">
                                ${item.product_name} (Taglia: ${item.size || 'N/A'}, Colore: ${item.color || 'N/A'}) x${item.quantity}</span>
                                <span>${formatPrice(item.unit_price * item.quantity)}</span>
                            </div>`).join('') : '<p>Nessun articolo trovato per questo ordine.</p>'}
                        </div>
                        <div class="summary-total-line" style="margin-top:15px;"><span><i class="fas fa-fw fa-receipt"></i> Subtotale:</span><span>${formatPrice(order.subtotal)}</span></div>
                        <div class="summary-total-line"><span><i class="fas fa-fw fa-truck"></i> Spedizione:</span><span>${formatPrice(order.shipping_cost)}</span></div>
                        <div class="summary-total-line grand-total"><span><i class="fas fa-fw fa-euro-sign"></i> TOTALE ORDINE:</span><span>${formatPrice(order.total_amount)}</span></div>
                    </div>
                </div>
                ${(cancellable || isPayPalPendingDetail) ? `
                    <div class="form-actions" style="margin-top:20px; justify-content:center; flex-wrap: wrap; gap: 10px;">
                        ${cancellable ? `
                            <button id="cancel-order-btn" class="btn-danger" data-order-id="${order.id}">
                                <i class="fas fa-ban"></i> Annulla Ordine
                            </button>
                            <span id="cancel-order-timer" style="flex-basis: 100%; text-align: center; margin-top: 5px;"><i class="fas fa-fw fa-stopwatch"></i> </span>
                        ` : ''}
                        ${isPayPalPendingDetail ? `
                            <button id="pay-now-detail-btn" class="btn-warning" data-order-id="${order.id}" data-order-numeric-id="${order.numeric_order_id}" data-total-amount="${order.total_amount}">
                                <i class="fab fa-paypal"></i> Paga Adesso
                            </button>
                        ` : ''}
                    </div>` : ''}
            `;
            toggleModal('order-detail-modal', true);
            if (cancellable) {
                const timerEl = orderDetailModalContent.querySelector('#cancel-order-timer');
                const cancelBtn = orderDetailModalContent.querySelector('#cancel-order-btn');
                if (userOrdersIntervals[order.id]) clearInterval(userOrdersIntervals[order.id]);
                function updateDetailTimerDisplay() {
                    const minutes = Math.floor(timeLeftForCancellation / (60 * 1000));
                    const seconds = Math.floor((timeLeftForCancellation % (60 * 1000)) / 1000);
                    if (timerEl) timerEl.innerHTML = `<i class="fas fa-fw fa-stopwatch"></i> Tempo rimanente per annullare: ${minutes} min ${seconds} sec`;
                }
                userOrdersIntervals[order.id] = setInterval(() => {
                    timeLeftForCancellation -= 1000;
                    if (timeLeftForCancellation <= 0) {
                        clearInterval(userOrdersIntervals[order.id]); delete userOrdersIntervals[order.id];
                        if(cancelBtn) cancelBtn.style.display = 'none';
                        if(timerEl) timerEl.innerHTML = `<i class="fas fa-fw fa-stopwatch"></i> Tempo scaduto per l'annullamento.`;
                    } else { updateDetailTimerDisplay(); }
                }, 1000);
                updateDetailTimerDisplay();
                if(cancelBtn) cancelBtn.addEventListener('click', async (e) => {
                    showConfirmCancelOrderModal(e.currentTarget.dataset.orderId);
                });
            }
            const payNowDetailBtn = orderDetailModalContent.querySelector('#pay-now-detail-btn');
            if (payNowDetailBtn) {
                payNowDetailBtn.addEventListener('click', (e) => {
                    const payNowButton = e.currentTarget;
                    const originalButtonHTML = payNowButton.innerHTML;
                    setButtonLoadingState(payNowButton, true);

                    const orderNumericId = payNowButton.dataset.orderNumericId;
                    const totalAmount = payNowButton.dataset.totalAmount;
                     const shippingAddressForPayPal = {
                        street: order.shipping_street,
                        city: order.shipping_city,
                        zip: order.shipping_zip_code
                    };
                    redirectToPayPal(`#${String(orderNumericId).padStart(4, '0')}`, totalAmount, shippingAddressForPayPal);
                    // Non resettare il loader qui
                });
            }

        } catch (error) {
            console.error("Errore API caricamento dettaglio ordine:", error);
            showFeedback(`Impossibile caricare i dettagli dell'ordine: ${error.message}`, "error");
        }
    }

    async function cancelOrder(dbOrderId) {
        if (!isUserLoggedIn() || !currentUserSession || !currentUserSession.userId) {
            showFeedback("Sessione utente non valida per annullare l'ordine.", "error");
            return false;
        }
        try {
            const response = await fetch(`${ORDERS_API_URL}?action=cancel_order&user_id=${currentUserSession.userId}&order_id=${dbOrderId}`, {
                method: 'PUT'
            });
            const result = await response.json();

            if (response.ok) {
                showFeedback(result.message || "Ordine annullato con successo.", "success");
                userOrdersCache = [];
                clearOrderDetailTimer(dbOrderId);
                if (listOrderTimers[dbOrderId]) {
                    clearInterval(listOrderTimers[dbOrderId]);
                    delete listOrderTimers[dbOrderId];
                }
                if (ordersHistoryModal.classList.contains('active')) {
                    await renderOrdersHistory();
                }
                if (orderDetailModal.classList.contains('active') && orderDetailModal.dataset.currentOrderId === String(dbOrderId)) {
                    await openOrderDetailModal(String(dbOrderId));
                }
                return true;
            } else {
                showFeedback(result.message || "Errore durante l'annullamento dell'ordine.", "error");
                if (ordersHistoryModal.classList.contains('active')) await renderOrdersHistory();
                if (orderDetailModal.classList.contains('active') && orderDetailModal.dataset.currentOrderId === String(dbOrderId)) await openOrderDetailModal(String(dbOrderId));
                return false;
            }
        } catch (error) {
            console.error('Errore API annullamento ordine:', error);
            showFeedback(`Errore di connessione durante l'annullamento: ${error.message}`, "error");
            return false;
        }
    }

    async function showConfirmCancelOrderModal(dbOrderId) {
         if (!isUserLoggedIn() || !currentUserSession || !currentUserSession.userId) {
            showFeedback("Sessione utente non valida.", "error"); return;
        }
        let orderToConfirm;
        try {
            const response = await fetch(`${ORDERS_API_URL}?action=get_order_detail&user_id=${currentUserSession.userId}&order_id=${dbOrderId}`);
            if (!response.ok) throw new Error("Errore caricamento ordine per conferma annullamento.");
            orderToConfirm = await response.json();
        } catch(e) {
            showFeedback("Impossibile recuperare i dettagli dell'ordine per l'annullamento.", "error"); return;
        }
        if (!orderToConfirm || !orderToConfirm.id) { showFeedback("Ordine non trovato.", "error"); return; }
        const orderDate = new Date(orderToConfirm.order_date);
        const timeLeftMs = ORDER_CANCELLATION_WINDOW_MS - (Date.now() - orderDate.getTime());
        if ((orderToConfirm.status !== 'processing' && orderToConfirm.status !== 'pending_payment') || timeLeftMs <= 0) {
            showFeedback("Questo ordine non è più annullabile.", "warning");
            userOrdersCache = [];
            if (ordersHistoryModal.classList.contains('active')) await renderOrdersHistory();
            if (orderDetailModal.classList.contains('active') && orderDetailModal.dataset.currentOrderId === String(dbOrderId)) {
                 await openOrderDetailModal(String(dbOrderId));
            }
            return;
        }
        confirmCancelOrderMessage.textContent = `Sei sicuro di voler annullare l'ordine #${String(orderToConfirm.numeric_order_id).padStart(4, '0')}?`;
        confirmCancelOrderBtn.onclick = async () => {
            await cancelOrder(String(dbOrderId));
            toggleModal('confirm-cancel-order-modal', false);
        };
        cancelCancelOrderBtn.onclick = () => {
            toggleModal('confirm-cancel-order-modal', false);
        };
        toggleModal('confirm-cancel-order-modal', true);
    }

    function clearOrderDetailTimer(orderId) {
        const numericOrderId = parseInt(orderId);
        if (userOrdersIntervals[numericOrderId]) {
            clearInterval(userOrdersIntervals[numericOrderId]);
            delete userOrdersIntervals[numericOrderId];
        }
    }

    async function initializeUserSpecificData() {
        loadCurrentUserSession();
        if (currentUserSession && currentUserSession.userId && !String(currentUserSession.userId).startsWith('guest_')) { // Verifica aggiuntiva che non sia guest
            await loadUserPersonalData();
            await loadUserAddresses();
            await loadWishlistFromDB(); // Carica la wishlist solo se utente loggato (non guest)
        } else {
            currentUserPersonalData = {
                username: '', loginEmail: '',
                contactFullName: '', contactEmail: '', contactPhone: ''
            };
            currentUserAddresses = [];
            wishlistProductIds = []; // La wishlist è vuota per ospiti o non loggati
            userOrdersCache = [];
        }
        updateAuthUI();
        updateWishlistVisuals(); // Assicura che l'UI della wishlist rifletta lo stato (vuota per ospiti)
    }

    async function init() {
        await fetchProductsFromAPI();
        loadCartFromStorage(); // Il carrello può esistere anche per ospiti
        await initializeUserSpecificData();
        filterProductsByCategory(currentCategoryFilter);
    }

    init();
});
    </script>
</body>
</html>